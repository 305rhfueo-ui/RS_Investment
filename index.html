<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Timeframe RS Investment (v1.3)</title>
    <link rel="shortcut icon" href="static/favicon.png">
    <style>
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --primary-color: #00e676;
            --text-color: #ffffff;
            --text-secondary: #b0b0b0;
            --danger-color: #ff5252;
            --border-color: #333;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 95%;
            max-width: 1600px;
            /* Wider for more columns */
            margin-top: 40px;
            text-align: center;
            flex-grow: 1;
        }

        h1 {
            margin-bottom: 20px;
        }

        .subtitle {
            color: #888;
            font-size: 14px;
            margin-bottom: 30px;
        }

        .info-box {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: left;
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        button {
            background-color: var(--primary-color);
            color: #000;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            transition: 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        /* Filter Popup */
        .filter-popup {
            position: absolute;
            background-color: #333;
            border: 1px solid #555;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
            min-width: 120px;
            text-align: left;
        }

        .filter-popup label {
            display: block;
            margin-bottom: 5px;
            cursor: pointer;
            color: #eee;
            font-size: 13px;
        }

        .filter-popup button {
            margin-top: 5px;
            padding: 5px 10px;
            font-size: 12px;
            width: 100%;
            background-color: var(--primary-color);
            color: #000;
        }

        #result-area {
            display: none;
            margin-top: 40px;
        }

        .btn-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .download-btn {
            background-color: #333;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
            transition: 0.2s;
            cursor: pointer;
        }

        .download-btn:hover {
            background-color: #555;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--surface-color);
            font-size: 13px;
        }

        th,
        td {
            text-align: left;
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            cursor: pointer;
            user-select: none;
            background-color: #252525;
            color: var(--text-secondary);
            position: sticky;
            top: 0;
            white-space: nowrap;
        }

        th:hover {
            background-color: #333;
        }

        .rs-pos {
            color: #00e676;
        }

        .rs-neg {
            color: #ff5252;
        }

        footer {
            width: 100%;
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 12px;
            border-top: 1px solid var(--border-color);
            margin-top: 50px;
            padding-bottom: 30px;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1 id="page-title" style="margin-bottom:5px;">US Market Multi-Timeframe RS Investment</h1>

        <h2 id="mode-subtitle" style="margin-top:0; margin-bottom:10px; font-size:24px; min-height:30px;"></h2>

        <p class="subtitle" id="last-updated" style="margin-bottom:15px;">업데이트 확인 중...</p>
        <p id="history-debug" style="font-size: 12px; color: #ff9800; display: none;"></p>

        <!-- 날짜 선택 드롭다운 -->
        <div style="margin-bottom:30px;">
            <label for="date-selector" style="color: #aaa; margin-right: 10px; font-size: 14px;">
                📅 데이터 날짜:
            </label>
            <select id="date-selector" style="
                background-color: #2a2a2a;
                color: #fff;
                border: 1px solid #444;
                padding: 8px 15px;
                border-radius: 5px;
                font-size: 14px;
                cursor: pointer;
                min-width: 150px;
            ">
                <option value="static/result.json">Latest</option>
            </select>
        </div>

        <div class="info-box">
            <ul>
                <li><strong>일일 자동 업데이트</strong>: 매일 미국 장 마감 후 서버가 자동으로 데이터를 갱신합니다. (매일 UTC 21:00 / 한국 시간 오전 6:00)</li>
                <li><strong>RS Logic</strong>: (개별종목 기간 수익률) - (QQQ 기간 수익률)
                    <ul>
                        <li><strong>RS(6mo)</strong>: 120영업일, <strong>RS(3mo)</strong>: 60영업일, <strong>RS(1mo)</strong>:
                            20영업일</li>
                        <li>양수(+)면 벤치마크(QQQ) 대비 초과 수익, 음수(-)면 저조한 성과를 의미합니다.</li>
                    </ul>
                </li>
                <li><strong>시가총액</strong>: 주가 × 발행주식수 (기업의 총 시장 가치)</li>
                <li><strong>WRS (Weighted Relative Strength):</strong> 섹터/산업 내 종목들의 시가총액 가중 평균 RS (섹터/산업의 주도력)</li>
                <li><strong>WRS_MD:</strong> 섹터/산업 내 종목들의 RS(6mo) 중앙값 (Median)</li>
                <li><strong>Win-rate:</strong> (해당 Sector/Industry 내 RS(6mo) > 0 인 Ticker 수) / Total Count (단위: %)</li>
                <li><strong>Final WRS:</strong> 종합 점수 = WRS(6MO)×40% + WRS_MD(6MO)×40% + Win-rate×(1-(1/Total
                    Count))×20%</li>
                <li><strong>10D Chg (%):</strong> WRS 및 개별 종목 RS(6mo)의 10거래일 전 대비 변화율</li>
                <li><strong>RS_DiF / WRS_Dif:</strong> (1개월 RS) - (3개월 RS) - (6개월 RS) (단기 모멘텀이 장기보다 강한지 확인)</li>
                <li><strong>50DIV(%):</strong> 현재 주가와 50일 이동평균선의 괴리율 (높을수록 과열)</li>

                <li><strong>EPS Trend:</strong> 시장 전문가들의 EPS(주당순이익) 예상치 30일전 대비 변화율 (CY:올해, NY:내년, CY와 NY 모두 5% 이상일 경우
                    장기 주도주가 될 가능성이 매우 높음)</li>
                <li><strong>Up/Down #:</strong> 최근 30일간 EPS 추정치를 상향(Up)/하향(Down) 조정한 애널리스트 수</li>
                <li><strong>Up/Down Ratio:</strong> 상향 조정 비율 (높을수록 실적 전망 긍정적)</li>
                <li><strong>Today's List 기준:</strong>
                    <ul>
                        <li><strong>섹터/산업:</strong> Total Count 2개 이상, Win-rate 60% 이상, Final WRS(종합 점수) 상위 30%</li>
                        <li><strong>종목:</strong> 선정된 섹터/산업 내 RS(6mo) 상위 30% 이내 & <strong>50DIV > 0</strong></li>
                    </ul>
                </li>
                <li><strong>Today's Main 기준:</strong>
                    <ul>
                        <li><strong>Today's List</strong> 조건을 만족하는 종목 중</li>
                        <li><strong>CY Trend & NY Trend</strong> 모두 5% 이상</li>
                        <li><strong>50DIV</strong> 55% 이하</li>
                    </ul>
                </li>
                <li><strong>급등/반등가능성↑종목:</strong> RS_DiF > 0 이며, CY Trend 및 NY Trend가 모두 양수인 종목 (NY Trend 순 정렬)</li>
                <li><strong>급등/반등가능성↑섹터:</strong> WRS_Dif > 0 인 섹터 (Win-rate 순 정렬)</li>

            </ul>
        </div>

        <!-- ... -->

        <div id="result-area">
            <div class="btn-group">
                <span id="result-count" style="font-size:14px; color:#aaa;"></span>

                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="text" id="search-input" placeholder="Search..."
                        style="padding:10px; border-radius:4px; border:1px solid #333; background:#222; color:#fff;">

                    <button id="indiv-btn" onclick="showIndividualRS()" class="download-btn"
                        style="background-color:#2196f3; color:#ffffff;">
                        Individual RS
                    </button>

                    <button id="wrs-btn" onclick="showWRS()" class="download-btn"
                        style="background-color:#00e676; color:#000;">
                        Sector/Industry WRS
                    </button>

                    <button id="todays-list-btn" onclick="showTodaysList()" class="download-btn"
                        style="background-color:#ff9800; color:#000;">
                        Today's List
                    </button>

                    <button id="todays-main-btn" onclick="showTodaysMain()" class="download-btn"
                        style="background-color:#e91e63; color:#ffffff;">
                        Today's Main
                    </button>

                    <!-- Rising Links (Text style buttons) -->
                    <a href="#" onclick="showRisingStocks(); return false;"
                        style="color: #ffca28; text-decoration: none; font-size: 14px; font-weight: bold; margin-left: 10px;">
                        ⚡급등/반등가능성↑종목
                    </a>
                    <a href="#" onclick="showRisingSectors(); return false;"
                        style="color: #ffca28; text-decoration: none; font-size: 14px; font-weight: bold;">
                        ⚡급등/반등가능성↑섹터
                    </a>



                    <button onclick="downloadExcel()" class="download-btn">📥 엑셀 다운로드</button>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th onclick="sortTable('Ticker')">Ticker ⬍</th>
                        <th onclick="sortTable('Sector')">Sector ⬍</th>
                        <th onclick="sortTable('Industry')">Industry ⬍</th>
                        <th onclick="sortTable('Price')">Price ($) ⬍</th>
                        <th onclick="sortTable('Market Cap')">Market Cap ($) ⬍</th>
                        <th onclick="sortTable('MarketCapRank')">MC Rank ⬍</th>

                        <th onclick="sortTable('RS_6mo')">RS (6mo) ⬍</th>
                        <th onclick="sortTable('RS_3mo')">RS (3mo) ⬍</th>
                        <th onclick="sortTable('RS_1mo')">RS (1mo) ⬍</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>

    <footer>
        <p>RS Investment © 2026 | Idea & Built by In-kyu Lee</p>
        <div style="margin-top: 15px; font-size: 11px; color: #555; line-height: 1.5;">
            <strong>Disclaimer:</strong> Data provided by Yahoo Finance. This project is for <strong>personal
                educational purposes only</strong> and is <strong>not for commercial use</strong>.<br>
            All data is strictly for informational purposes and should not be considered financial advice.
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <script>
        // Global State & Data
        let globalData = [];
        let groupedData = []; // for WRS mode

        // App State
        let appState = {
            mode: 'INDIVIDUAL', // 'INDIVIDUAL' | 'WRS' | 'DRILLDOWN' | 'TODAYS_LIST' | 'RISING_STOCKS' | 'RISING_SECTORS'
            filterText: '',
            drillDownKey: null, // "Sector|Industry"
            sort: { key: 'RS_6mo', asc: false }, // Default Sort: RS(6mo) Descending
            filterRS_DiF: 'ALL', // 'ALL' | 'POS' | 'NEG'
            filterWRS_Dif: 'ALL' // 'ALL' | 'POS' | 'NEG'
        };

        // 페이지 로드 시 자동 실행
        window.onload = function () {
            const today = new Date();
            const kstDate = new Intl.DateTimeFormat('ko-KR', {
                timeZone: 'Asia/Seoul',
                year: 'numeric', month: '2-digit', day: '2-digit'
            }).format(today);
            document.getElementById('page-title').innerText = `${kstDate} RS Investment`;

            // Enter Key Listener for Search
            document.getElementById('search-input').addEventListener("keypress", function (event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    handleSearch();
                }
            });

            // Close filter popup when clicking outside
            document.addEventListener('click', function (event) {
                const popup = document.getElementById('filter-popup');
                if (popup && popup.style.display === 'block' && !event.target.closest('th')) {
                    if (!popup.contains(event.target)) {
                        popup.style.display = 'none';
                    }
                }
            });

            loadData();
            loadHistoryIndex();
        };

        // Load History Index and populate dropdown
        async function loadHistoryIndex() {
            try {
                const res = await fetch('./static/history_index.json?t=' + new Date().getTime());
                if (!res.ok) return; // No history yet

                const json = await res.json();
                const selector = document.getElementById('date-selector');

                // Add history options
                json.dates.forEach(item => {
                    const option = document.createElement('option');
                    option.value = 'static/' + item.filename;
                    option.text = item.date;
                    selector.appendChild(option);
                });

                // Add change listener
                selector.addEventListener('change', function () {
                    loadData(this.value);
                });

            } catch (e) {
                console.log("History index load failed:", e);
            }
        }

        async function loadData(url = './static/result.json') {
            const loader = document.getElementById('loading-msg');
            loader.style.display = 'block'; // Show loader when switching

            try {
                // Fetch Data
                const res = await fetch(url + '?t=' + new Date().getTime());
                if (res.status === 404) throw new Error("BOT_WORKING");
                if (!res.ok) throw new Error("데이터 로드 실패 code: " + res.status);

                const rawText = await res.text();
                // Fix NaN issue
                const sanitizedText = rawText.replace(/:\s*NaN/g, ': null');
                const json = JSON.parse(sanitizedText);

                // Initialize Data
                globalData = json.data;

                // [Added] Calculate RS_DiF for Individual Data
                globalData.forEach(item => {
                    const rs1 = item.RS_1mo || 0;
                    const rs3 = item.RS_3mo || 0;
                    const rs6 = item.RS_6mo || 0;
                    // Formula: RS(1mo) - RS(3mo) - RS(6mo)
                    item.RS_DiF = rs1 - rs3 - rs6;
                });

                // [Fix] Calculate WRS immediately so groupedData is ready for History Comparison
                calculateWRS();

                // Time Display
                if (json.last_updated) {
                    const lastUpdatedEl = document.getElementById('last-updated');
                    if (lastUpdatedEl) {
                        try {
                            const dateObj = new Date(json.last_updated.replace(' UTC', 'Z').replace(' ', 'T'));
                            const kstStr = new Intl.DateTimeFormat('ko-KR', {
                                timeZone: 'Asia/Seoul',
                                year: 'numeric', month: '2-digit', day: '2-digit',
                                hour: '2-digit', minute: '2-digit', second: '2-digit',
                                hour12: false
                            }).format(dateObj);
                            lastUpdatedEl.innerText = `Last update KST: ${kstStr}`;
                        } catch (e) {
                            lastUpdatedEl.innerText = `Last Updated: ${json.last_updated}`;
                        }
                    }
                }

                // Initial Render
                updateUI();

                document.getElementById('result-area').style.display = 'block';
                loader.style.display = 'none';

                // [Added] Load Historical Data for 5-day comparison (Async)
                loadHistoricalComparison();

            } catch (e) {
                if (e.message === "BOT_WORKING") {
                    loader.innerHTML = `<div style="padding: 20px; border: 2px dashed var(--primary-color);"><h3>🤖 봇이 작업중입니다!</h3><p>잠시 후 새로고침 해주세요.</p></div>`;
                } else {
                    loader.innerText = "Error: " + e.message;
                }
            }
        }

        // [Added] New Function for Historical Comparison
        async function loadHistoricalComparison() {
            const debugEl = document.getElementById('history-debug');
            if (debugEl) debugEl.style.display = 'block';

            try {
                // 1. Get History Index
                const res = await fetch('./static/history_index.json?t=' + new Date().getTime());
                if (!res.ok) {
                    if (debugEl) debugEl.innerText = "Hist Index Fetch Failed";
                    return;
                }
                const indexData = await res.json();

                const dates = indexData.dates; // Sorted DESC

                if (dates.length < 11) {
                    if (debugEl) debugEl.innerText = `History insufficient (Count: ${dates.length}, Need 11)`;
                    console.log("Not enough history for 10D comparison (Total: " + dates.length + ")");
                    return;
                }

                const targetHistory = dates[10]; // 10 days ago (11th file)

                if (debugEl) debugEl.innerText = `Loading History: ${targetHistory.date} ...`;
                console.log("Loading 10-day ago data from:", targetHistory.filename);

                const histRes = await fetch('static/' + targetHistory.filename);
                if (!histRes.ok) {
                    if (debugEl) debugEl.innerText = `Hist File Fetch Failed: ${targetHistory.filename}`;
                    throw new Error("Failed to fetch history file");
                }
                // [Fix] Handle NaN in JSON
                const rawText = await histRes.text();
                // Replace constants like NaN with null (or 0) because JSON.parse fails on them
                const sanitizedText = rawText.replace(/:\s*NaN/g, ': null');
                const histJson = JSON.parse(sanitizedText);
                const histData = histJson.data; // Raw tickers

                // Update Header with Date
                const dateStr = targetHistory.date; // "YYYY-MM-DD"
                const shortDate = dateStr.substring(5); // "MM-DD"
                const header = document.querySelector('th[onclick="sortTable(\'Final_WRS_10D_Chg\')"]');
                if (header) header.innerText = `10D Chg (${shortDate}) ⬍`;

                // 3. Calculate WRS for Historical Data
                const histWRS = calculateWRSForData(histData);
                const histKeys = Object.keys(histWRS);

                let matchCount = 0;
                let foundCount = 0;
                let firstHistKey = histKeys.length > 0 ? histKeys[0] : "None";
                let firstCurrKey = "None";

                // 4. Merge WRS
                groupedData.forEach((curr, idx) => {
                    const key = `${curr.Sector}|${curr.Industry}`;
                    if (idx === 0) firstCurrKey = key;

                    const past = histWRS[key];

                    if (past) {
                        foundCount++;
                        if (past.Final_WRS !== 0 && !isNaN(past.Final_WRS)) {
                            const change = ((curr.Final_WRS - past.Final_WRS) / Math.abs(past.Final_WRS)) * 100;
                            curr.Final_WRS_10D_Chg = change;
                            matchCount++;
                        } else {
                            curr.Final_WRS_10D_Chg = null;
                        }
                    } else {
                        curr.Final_WRS_10D_Chg = null;
                    }
                });

                // [Added] 5. Merge Individual RS (Ticker Level)
                const histTickerMap = {};
                histData.forEach(item => {
                    if (item.Ticker) histTickerMap[item.Ticker] = item.RS_6mo;
                });

                let tickerMatchCount = 0;
                globalData.forEach(curr => {
                    const pastRS = histTickerMap[curr.Ticker];
                    // Check if pastRS is valid number (can be 0, but usually not null/undefined)
                    if (pastRS !== undefined && pastRS !== null && !isNaN(pastRS) && pastRS !== 0) {
                        // Change % = (Curr - Past) / |Past| * 100
                        const change = ((curr.RS_6mo - pastRS) / Math.abs(pastRS)) * 100;
                        curr.RS_6mo_10D_Chg = change;
                        tickerMatchCount++;
                    } else {
                        curr.RS_6mo_10D_Chg = null;
                    }
                });

                const debugMsg = `Loaded: ${dateStr} | HistItems: ${histData.length} | WRSGroups: ${histKeys.length} | Found: ${foundCount} | Valid: ${matchCount}\nTicker Matches: ${tickerMatchCount}`;
                if (debugEl) debugEl.innerText = debugMsg;
                console.log(debugMsg);

                // 6. Re-render UI
                updateUI();

            } catch (e) {
                console.error("Historical comparison failed:", e);
                if (debugEl) debugEl.innerText = `History Error: ${e.message}`;
            }
        }

        // Refactored WRS Calculation to be reusable
        function calculateWRSForData(rawData) {
            const groups = {};
            rawData.forEach(item => {
                // Ensure field existence
                if (!item['Market Cap'] || item['Market Cap'] === 'N/A') return;
                if (!item['Sector'] || item['Sector'] === 'N/A' || item['Sector'] === 'nan') return;

                const key = `${item.Sector}|${item.Industry}`;
                if (!groups[key]) {
                    groups[key] = {
                        Sector: item.Sector,
                        Industry: item.Industry,
                        Count: 0,
                        TotalMC: 0,
                        WeightedSum6: 0,
                        RS_Values: [],
                        WinCount: 0
                    };
                }

                // Robust Parsing
                const mc = parseMarketCap(item['Market Cap']);
                // Ensure RS is number
                const rs6 = parseFloat(item.RS_6mo) || 0;

                if (mc > 0) {
                    groups[key].Count += 1;
                    groups[key].TotalMC += mc;
                    groups[key].WeightedSum6 += (mc * rs6);
                    groups[key].RS_Values.push(rs6);
                    if (rs6 > 0) groups[key].WinCount += 1;
                }
            });

            const result = {};
            Object.values(groups).forEach(g => {
                // Median Calculation
                const sortedRS = g.RS_Values.sort((a, b) => a - b);

                let median = 0;
                if (sortedRS.length > 0) {
                    const mid = Math.floor(sortedRS.length / 2);
                    median = sortedRS.length % 2 === 0
                        ? (sortedRS[mid - 1] + sortedRS[mid]) / 2
                        : sortedRS[mid];
                }

                const wrs6mo = g.TotalMC > 0 ? (g.WeightedSum6 / g.TotalMC) : 0;
                const winRate = g.Count > 0 ? (g.WinCount / g.Count) : 0;
                const winFactor = g.Count > 1 ? (1 - (1 / g.Count)) : 0;

                const finalWRS = (wrs6mo * 0.4) + (median * 0.4) + (winRate * winFactor * 0.2);

                // [Added] WRS_Dif Calculation
                // Formula: WRS(1mo) - WRS(3mo) - WRS(6mo)
                const wrs3mo = g.TotalMC > 0 ? (g.WeightedSum3 / g.TotalMC) : 0;
                const wrs1mo = g.TotalMC > 0 ? (g.WeightedSum1 / g.TotalMC) : 0;
                const wrsDif = wrs1mo - wrs3mo - wrs6mo;

                result[`${g.Sector}|${g.Industry}`] = {
                    Final_WRS: finalWRS,
                    WRS_Dif: wrsDif
                };
            });
            return result;
        }

        // --- Core Functions ---

        function showIndividualRS() {
            appState.mode = 'INDIVIDUAL';
            appState.drillDownKey = null;
            appState.sort = { key: 'RS_6mo', asc: false }; // Default sort

            document.getElementById('search-input').value = '';
            appState.filterText = '';
            updateUI();
        }

        function showWRS() {
            // If in Drilldown, this acts as "Back"
            if (appState.mode === 'DRILLDOWN') {
                appState.mode = 'WRS';
                appState.drillDownKey = null;
            } else {
                appState.mode = 'WRS';
            }

            // Generate data if needed
            if (groupedData.length === 0) calculateWRS();

            appState.sort = { key: 'Final_WRS', asc: false }; // Default sort

            document.getElementById('search-input').value = '';
            appState.filterText = '';
            updateUI();
        }

        function updateUI() {
            const subtitle = document.getElementById('mode-subtitle');
            const wrsBtn = document.getElementById('wrs-btn');
            const indivBtn = document.getElementById('indiv-btn');
            const resultCount = document.getElementById('result-count');

            if (!subtitle || !wrsBtn || !indivBtn) {
                console.error("Missing UI elements");
                return;
            }

            // 1. Update Subtitle & Button States
            if (appState.mode === 'INDIVIDUAL') {
                subtitle.innerText = "Individual RS";
                subtitle.style.color = "#2196f3"; // Blue

                // Active/Inactive Styling (Optional)
                indivBtn.style.opacity = '1';
                wrsBtn.innerText = "Sector/Industry WRS"; // Reset text (Fixed: removed .style)

            } else if (appState.mode === 'WRS') {
                subtitle.innerText = "Sector/Industry WRS";
                subtitle.style.color = "#ff5252"; // Red

                wrsBtn.innerText = "Sector/Industry WRS";

            } else if (appState.mode === 'DRILLDOWN') {
                subtitle.innerText = "Sector Detail View";
                subtitle.style.color = "#00e676";

                // Change WRS button to Back button
                wrsBtn.innerText = "Back to WRS List";

            } else if (appState.mode === 'TODAYS_LIST') {
                subtitle.innerText = "Today's List";
                subtitle.style.color = "#ff9800"; // Orange

                wrsBtn.innerText = "Sector/Industry WRS"; // Reset

            } else if (appState.mode === 'TODAYS_MAIN') {
                subtitle.innerText = "Today's Main";
                subtitle.style.color = "#e91e63"; // Pink

                wrsBtn.innerText = "Sector/Industry WRS"; // Reset

            } else if (appState.mode === 'TODAYS_TOP') {
                subtitle.innerText = "Today's Top (Best of Best)";
                subtitle.style.color = "#00bcd4"; // Cyan

                wrsBtn.innerText = "Sector/Industry WRS"; // Reset
            } else if (appState.mode === 'RISING_STOCKS') {
                subtitle.innerText = "Rising/Rebound Stocks (RS_DiF > 0, CY/NY > 0)";
                subtitle.style.color = "#ffca28";
                wrsBtn.innerText = "Sector/Industry WRS";
            } else if (appState.mode === 'RISING_SECTORS') {
                subtitle.innerText = "Rising/Rebound Sectors (WRS_Dif > 0)";
                subtitle.style.color = "#ffca28";
                wrsBtn.innerText = "Sector/Industry WRS";
            }

            // 2. Render Data
            const data = getFilteredAndSortedData();
            renderTable(data);

            if (resultCount) {
                resultCount.innerText = `Total: ${data.length} Items`;
            }

            // 3. Table Layout Adjustment (Compact center for WRS)
            const tableElement = document.querySelector('table');
            if (tableElement) {
                if (appState.mode === 'WRS') {
                    tableElement.style.width = 'auto'; // Shrink to fit
                    tableElement.style.margin = '0 auto'; // Center
                } else {
                    tableElement.style.width = '100%'; // Full width
                    tableElement.style.margin = '0';
                }
            }
        }

        function showTodaysList() {
            appState.mode = 'TODAYS_LIST';
            appState.filterText = '';
            document.getElementById('search-input').value = '';
            appState.sort = { key: 'RS_6mo', asc: false };

            // WRS 계산이 필요한 경우
            if (groupedData.length === 0) {
                calculateWRS();
            }

            updateUI();
        }

        function showTodayMain() {
            // Function needed but not part of original request, implementing `showTodaysMain` below
        }

        function showTodaysMain() {
            appState.mode = 'TODAYS_MAIN';
            appState.filterText = '';
            document.getElementById('search-input').value = '';
            appState.sort = { key: 'RS_6mo', asc: false };

            if (groupedData.length === 0) {
                calculateWRS();
            }

            updateUI();
        }

        function showTodaysTop() {
            appState.mode = 'TODAYS_TOP';
            appState.filterText = '';
            document.getElementById('search-input').value = '';
            appState.sort = { key: 'RS_6mo', asc: false };


            updateUI();
        }

        function calculateWRS() {
            // Group by Sector|Industry
            const groups = {};

            globalData.forEach(item => {
                // Ensure Sector/Industry exists
                if (!item['Sector'] || item['Sector'] === 'N/A') return;
                if (!item['Industry'] || item['Industry'] === 'N/A') return;

                const key = `${item.Sector}|${item.Industry}`;
                if (!groups[key]) {
                    groups[key] = {
                        Sector: item.Sector,
                        Industry: item.Industry,
                        Count: 0,
                        TotalMC: 0,
                        WeightedSum6: 0,
                        WeightedSum3: 0, // [Added]
                        WeightedSum1: 0, // [Added]
                        RS_Values: [], // For Median
                        WinCount: 0
                    };
                }

                // Market Cap Parsing
                const mc = parseMarketCap(item['Market Cap']);
                if (mc > 0) {
                    const rs6 = parseFloat(item.RS_6mo) || 0;
                    const rs3 = parseFloat(item.RS_3mo) || 0; // [Added]
                    const rs1 = parseFloat(item.RS_1mo) || 0; // [Added]

                    groups[key].Count += 1;
                    groups[key].TotalMC += mc;
                    groups[key].WeightedSum6 += (mc * rs6);
                    groups[key].WeightedSum3 += (mc * rs3); // [Added]
                    groups[key].WeightedSum1 += (mc * rs1); // [Added]

                    groups[key].RS_Values.push(rs6);

                    if (rs6 > 0) groups[key].WinCount += 1;
                }
            });

            // Calculate Metrics per Group
            groupedData = Object.values(groups).map(g => {
                // 1. Median RS(6mo)
                const sortedRS = g.RS_Values.sort((a, b) => a - b);
                let median = 0;
                if (sortedRS.length > 0) {
                    const mid = Math.floor(sortedRS.length / 2);
                    median = sortedRS.length % 2 === 0
                        ? (sortedRS[mid - 1] + sortedRS[mid]) / 2
                        : sortedRS[mid];
                }

                // 2. WRS (Weighted Average)
                const wrs6mo = g.TotalMC > 0 ? (g.WeightedSum6 / g.TotalMC) : 0;
                const wrs3mo = g.TotalMC > 0 ? (g.WeightedSum3 / g.TotalMC) : 0; // [Added]
                const wrs1mo = g.TotalMC > 0 ? (g.WeightedSum1 / g.TotalMC) : 0; // [Added]

                // 3. Win Rate & Factor
                const winRate = g.Count > 0 ? (g.WinCount / g.Count) : 0;
                // Count > 1 이면 (1 - 1/N), 1개면 0
                const winFactor = g.Count > 1 ? (1 - (1 / g.Count)) : 0;

                // 4. Final WRS
                // Formula: WRS(6MO)*0.4 + WRS_MD(6MO)*0.4 + Win-rate*Win-factor*0.2
                const finalWRS = (wrs6mo * 0.4) + (median * 0.4) + (winRate * winFactor * 0.2);

                // [Added] WRS_Dif Calculation
                // Formula: WRS(1mo) - WRS(3mo) - WRS(6mo)
                const wrsDif = wrs1mo - wrs3mo - wrs6mo;

                return {
                    Sector: g.Sector,
                    Industry: g.Industry,
                    Count: g.Count,
                    WRS_6mo: wrs6mo,
                    WRS_3mo: wrs3mo,
                    WRS_1mo: wrs1mo,
                    WRS_Dif: wrsDif, // [Added]
                    WRS_MD_6mo: median,
                    Win_Rate: winRate * 100, // %
                    Final_WRS: finalWRS,
                    Final_WRS_10D_Chg: null, // Placeholder
                    RS_Values: g.RS_Values
                };
            });
        }

        // --- Helper: Parse Market Cap ---
        function parseMarketCap(mcStr) {
            if (!mcStr) return 0;
            // e.g. "1.23T", "45.6B", "789M"
            const last = mcStr.slice(-1).toUpperCase();
            const val = parseFloat(mcStr.slice(0, -1));

            if (isNaN(val)) return 0;

            if (last === 'T') return val * 1_000_000_000_000;
            if (last === 'B') return val * 1_000_000_000;
            if (last === 'M') return val * 1_000_000;
            if (last === 'K') return val * 1_000;
            return val;
        }

        // --- Helper: Sort ---
        function sortTable(key) {
            if (appState.sort.key === key) {
                // Toggle desc/asc
                appState.sort.asc = !appState.sort.asc;
            } else {
                appState.sort.key = key;
                appState.sort.asc = false; // Default desc
            }
            updateUI();
        }

        // --- Helper: Filter by RS_DiF / WRS_Dif ---
        function applyFilter(type, value) {
            if (type === 'RS_DiF') {
                appState.filterRS_DiF = value;
            } else if (type === 'WRS_Dif') {
                appState.filterWRS_Dif = value;
            }

            // Close popup
            const popup = document.getElementById('filter-popup');
            if (popup) popup.style.display = 'none';

            updateUI();
        }

        function showFilterPopup(event, type) {
            event.stopPropagation(); // Stop sorting

            const popup = document.getElementById('filter-popup');
            if (!popup) {
                // Create popup if not exists
                const div = document.createElement('div');
                div.id = 'filter-popup';
                div.className = 'filter-popup';
                document.body.appendChild(div);
            }

            const p = document.getElementById('filter-popup');
            const currentFilter = (type === 'RS_DiF') ? appState.filterRS_DiF : appState.filterWRS_Dif;

            p.innerHTML = `
                <div style="font-weight:bold; margin-bottom:8px; border-bottom:1px solid #555; padding-bottom:5px;">
                    ${type} Filter
                </div>
                <label>
                    <input type="radio" name="filter-${type}" value="ALL" 
                        onclick="applyFilter('${type}', 'ALL')" ${currentFilter === 'ALL' ? 'checked' : ''}> 
                    All
                </label>
                <label>
                    <input type="radio" name="filter-${type}" value="POS" 
                        onclick="applyFilter('${type}', 'POS')" ${currentFilter === 'POS' ? 'checked' : ''}> 
                    (+) Positive
                </label>
                <label>
                    <input type="radio" name="filter-${type}" value="NEG" 
                        onclick="applyFilter('${type}', 'NEG')" ${currentFilter === 'NEG' ? 'checked' : ''}> 
                    (-) Negative
                </label>
            `;

            // Position
            const rect = event.target.getBoundingClientRect();
            p.style.top = (window.scrollY + rect.bottom + 5) + 'px';
            p.style.left = (window.scrollX + rect.left) + 'px';
            p.style.display = 'block';
        }

        // --- Data Processing for Render ---
        function getFilteredAndSortedData() {
            let targetData = [];

            // 1. Select Data Source based on Mode
            if (appState.mode === 'INDIVIDUAL' || appState.mode === 'TODAYS_LIST' || appState.mode === 'TODAYS_MAIN') {
                targetData = [...globalData]; // Copy
            } else if (appState.mode === 'WRS' || appState.mode === 'RISING_SECTORS') {
                targetData = [...groupedData];
            } else if (appState.mode === 'DRILLDOWN') {
                // Filter globalData by DrillDownKey
                targetData = globalData.filter(item => {
                    return `${item.Sector}|${item.Industry}` === appState.drillDownKey;
                });
            } else if (appState.mode === 'RISING_STOCKS') {
                targetData = [...globalData];
            } else if (appState.mode === 'TODAYS_TOP') { // Added TODAYS_TOP logic source
                targetData = [...globalData];
            }


            // 2. Apply Mode-Specific Filters
            if (appState.mode === 'TODAYS_LIST') {
                // [Requirement]
                // 1. Sector/Industry: Count >= 2, Win-Rate >= 60%, Final WRS Top 30%
                // 2. Individual: RS(6mo) Top 30% within Sector, 50DIV > 0

                // A. Identify Top Sectors
                const validGroups = groupedData.filter(g => g.Count >= 2 && g.Win_Rate >= 60);
                // Sort by Final_WRS desc to find top 30%
                validGroups.sort((a, b) => b.Final_WRS - a.Final_WRS);
                const topGroupCutoff = Math.ceil(validGroups.length * 0.3);
                const topGroups = validGroups.slice(0, topGroupCutoff);
                const topGroupKeys = new Set(topGroups.map(g => `${g.Sector}|${g.Industry}`));

                // B. Filter Tickers
                targetData = targetData.filter(stock => {
                    // Must belong to Top Sector
                    const key = `${stock.Sector}|${stock.Industry}`;
                    if (!topGroupKeys.has(key)) return false;

                    // Must have 50DIV > 0
                    const div50 = parseFloat(stock['50DIV']);
                    if (isNaN(div50) || div50 <= 0) return false;

                    return true;
                });

                // C. RS(6mo) Top 30% within *each* sector (pre-calculation optimization?)
                // Or just filter here simply? The requirement says "RS(6mo) Top 30% within selected sector"
                // Let's refine: For each stock, check if it is in top 30% of its group.
                // We need group-level sorted lists.
                // Re-use groups from calculateWRS logic? 

                // Easy way: Group targetData by (Sector|Industry) again, then slice top 30%.
                // But targetData is already filtered by group.

                // Let's do a map for "Top 30% Threshold per Group"
                const groupThresholds = {};
                topGroups.forEach(g => {
                    // g.RS_Values is already sorted asc (rs values)
                    // We need top 30% -> Top 0.3 -> Bottom 0.7 index
                    // e.g. 10 items. Top 3 items. 7th item is cutoff (if sorted asc).
                    const count = g.RS_Values.length;
                    const cutoffIndex = Math.floor(count * 0.7);
                    // g.RS_Values is sorted ASC. so index 0 is smallest. 
                    // slice(cutoffIndex) gives top items.
                    // The value at cutoffIndex is the minimum RS needed.
                    if (count > 0 && cutoffIndex < count) {
                        groupThresholds[`${g.Sector}|${g.Industry}`] = g.RS_Values[cutoffIndex];
                    } else {
                        groupThresholds[`${g.Sector}|${g.Industry}`] = -9999; // Take all
                    }
                });

                targetData = targetData.filter(stock => {
                    const key = `${stock.Sector}|${stock.Industry}`;
                    const threshold = groupThresholds[key];
                    const rs6 = parseFloat(stock.RS_6mo) || 0;
                    return rs6 >= threshold;
                });

            } else if (appState.mode === 'TODAYS_MAIN') {
                // Reuse logic of TODAYS_LIST first, then stricter filter
                // 1. Get List Data (Simulate Today's List Logic)
                // Copy-paste logic or abstraction? Abstraction is better but stick to flow.

                // A. Identify Top Sectors (Same as List)
                const validGroups = groupedData.filter(g => g.Count >= 2 && g.Win_Rate >= 60);
                validGroups.sort((a, b) => b.Final_WRS - a.Final_WRS);
                const topGroupCutoff = Math.ceil(validGroups.length * 0.3);
                const topGroups = validGroups.slice(0, topGroupCutoff);
                const topGroupKeys = new Set(topGroups.map(g => `${g.Sector}|${g.Industry}`));

                targetData = targetData.filter(stock => {
                    const key = `${stock.Sector}|${stock.Industry}`;
                    if (!topGroupKeys.has(key)) return false;
                    const div50 = parseFloat(stock['50DIV']);
                    if (isNaN(div50) || div50 <= 0) return false;
                    return true;
                });

                // Thresholds (Same as List)
                const groupThresholds = {};
                topGroups.forEach(g => {
                    const count = g.RS_Values.length;
                    const cutoffIndex = Math.floor(count * 0.7);
                    if (count > 0 && cutoffIndex < count) {
                        groupThresholds[`${g.Sector}|${g.Industry}`] = g.RS_Values[cutoffIndex];
                    } else {
                        groupThresholds[`${g.Sector}|${g.Industry}`] = -9999;
                    }
                });

                // B. Apply Main Filters
                // 1. Today's List (RS Top 30%)
                // 2. CY & NY Trend >= 5%
                // 3. 50DIV <= 55%
                targetData = targetData.filter(stock => {
                    const key = `${stock.Sector}|${stock.Industry}`;
                    const threshold = groupThresholds[key];
                    const rs6 = parseFloat(stock.RS_6mo) || 0;

                    // 1. Today's List condition
                    if (rs6 < threshold) return false;

                    // 2. CY & NY Trend
                    const cy = parseFloat(stock.CY_Trend);
                    const ny = parseFloat(stock.NY_Trend);
                    if (isNaN(cy) || cy < 5) return false;
                    if (isNaN(ny) || ny < 5) return false;

                    // 3. 50DIV <= 55
                    const div50 = parseFloat(stock['50DIV']); // Already checked > 0 above
                    if (div50 > 55) return false;

                    return true;
                });
            } else if (appState.mode === 'RISING_STOCKS') {
                // 급등/반등가능성↑종목: 
                // 1) RS_DiF > 0 
                // 2) CY_Trend > 0
                // 3) NY_Trend > 0
                targetData = globalData.filter(stock =>
                    stock.RS_DiF > 0 &&
                    stock.CY_Trend > 0 &&
                    stock.NY_Trend > 0
                );
            } else if (appState.mode === 'RISING_SECTORS') {
                // 급등/반등가능성↑섹터: WRS_DiF > 0
                // Sort is handled in sort section (Win_Rate)
                targetData = groupedData.filter(g => g.WRS_DiF > 0);
            }

            // 3. Apply Text Search (Global)
            if (appState.filterText) {
                const lower = appState.filterText.toLowerCase();
                targetData = targetData.filter(item => {
                    // Search in Ticker, Sector, Industry (and maybe others?)
                    const ticker = item.Ticker ? item.Ticker.toLowerCase() : '';
                    const sector = item.Sector ? item.Sector.toLowerCase() : '';
                    const ind = item.Industry ? item.Industry.toLowerCase() : '';
                    return ticker.includes(lower) || sector.includes(lower) || ind.includes(lower);
                });
            }

            // 4. Apply Custom Filters (RS_DiF / WRS_Dif)
            // Note: RISING modes override these, but if user manually filters in INDIV/WRS mode:
            if (appState.mode === 'INDIVIDUAL' || appState.mode === 'DRILLDOWN') {
                if (appState.filterRS_DiF === 'POS') {
                    targetData = targetData.filter(item => item.RS_DiF > 0);
                } else if (appState.filterRS_DiF === 'NEG') {
                    targetData = targetData.filter(item => item.RS_DiF < 0);
                }
            }
            if (appState.mode === 'WRS') {
                if (appState.filterWRS_Dif === 'POS') {
                    targetData = targetData.filter(item => item.WRS_Dif > 0);
                } else if (appState.filterWRS_Dif === 'NEG') {
                    targetData = targetData.filter(item => item.WRS_Dif < 0);
                }
            }

            // 5. Apply Sorting
            targetData.sort((a, b) => {
                let valA = a[appState.sort.key];
                let valB = b[appState.sort.key];

                // Handle nulls/undefined - push to bottom? or treat as -Infinity?
                // Let's treat null as -Infinity for desc sort, +Infinity for asc (so always bottom)
                // Actually safer to treat as very small number.
                if (valA === undefined || valA === null) valA = -99999999;
                if (valB === undefined || valB === null) valB = -99999999;

                // String comparison (Ticker, Sector, Industry)
                if (typeof valA === 'string' && typeof valB === 'string') {
                    return appState.sort.asc ? valA.localeCompare(valB) : valB.localeCompare(valA);
                }

                // Numeric comparison
                return appState.sort.asc ? (valA - valB) : (valB - valA);
            });

            return targetData;
        }

        // --- Search Handler ---
        function handleSearch() {
            const input = document.getElementById('search-input');
            const val = input.value.trim();
            appState.filterText = val;
            updateUI();
        }

        // --- Main Render Function ---
        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            const thead = document.querySelector('table thead tr');

            if (appState.mode === 'WRS' || appState.mode === 'RISING_SECTORS') {
                // WRS Table Header
                // Added 10D Chg and WRS_Dif
                thead.innerHTML = `
                    <th onclick="sortTable('Sector')">Sector ⬍</th>
                    <th onclick="sortTable('Industry')">Industry ⬍</th>
                    <th onclick="sortTable('Final_WRS')">Final WRS ⬍</th>
                    <th onclick="sortTable('Final_WRS_Rank_Pct')">Final Rank (%) ⬍</th>
                    <th onclick="sortTable('Final_WRS_10D_Chg')">10D Chg (%) ⬍</th>
                    <th onclick="sortTable('Count')">Total Count ⬍</th>
                    <th onclick="sortTable('WRS_6mo')">WRS (6mo) ⬍</th>
                    <th onclick="sortTable('WRS_Rank_Pct')">WRS Rank (%) ⬍</th>
                    <th onclick="sortTable('WRS_6mo_MD')">WRS_MD (6mo) ⬍</th>
                    <th onclick="sortTable('WRS_MD_Rank_Pct')">WRS_MD Rank (%) ⬍</th>
                    <th onclick="sortTable('Win_Rate')">Win-rate (%) ⬍</th>
                    <th onclick="sortTable('WRS_3mo')">WRS (3mo) ⬍</th>
                    <th onclick="sortTable('WRS_1mo')">WRS (1mo) ⬍</th>
                    <th onclick="sortTable('WRS_Dif')">
                        WRS_Dif ⬍
                        <span style="font-size:12px; cursor:pointer;" onclick="showFilterPopup(event, 'WRS_Dif')">🔍</span>
                    </th>
                `;

                // Calculate Percentiles for Rank
                // (Optional: Re-calculate per filter? Original requirements imply ranking based on global scope usually.
                // But for display consistency, let's keep it simple. If we want dynamic ranking, we need full list.)
                // Given "Rank (%)", let's assuming pre-calculated or calculate on the fly for *current list*?
                // Usually Rank is relative to All Industries. 
                // Let's compute ranks for the visible data for simplicity or use global?
                // Using global groupedData to assign ranks first is better.
                // Re-calculating ranks every render might be confusing if filtering.
                // Let's computing ranks on global groupedData once in calculateWRS is ideal.
                // For now, let's just display what we have. If we need "Rank" column, we need to compute it.
                // Let's add partial Rank calculation here for visual completeness if missing.

                const totalItems = groupedData.length;
                // Sort by metrics to assist ranking (Visual only if not stored)
                // Actually, let's just show values. 

                // Render Rows
                data.forEach(item => {
                    const tr = document.createElement('tr');

                    // Style for WRS_Dif POS/NEG
                    const difClass = item.WRS_Dif > 0 ? 'rs-pos' : (item.WRS_Dif < 0 ? 'rs-neg' : '');

                    tr.innerHTML = `
                        <td style="font-weight:bold; cursor:pointer;" onclick="drillDown('${item.Sector}|${item.Industry}')">${item.Sector}</td>
                        <td style="font-weight:bold; cursor:pointer;" onclick="drillDown('${item.Sector}|${item.Industry}')">${item.Industry}</td>
                        <td style="font-weight:bold; color:var(--primary-color)">${item.Final_WRS.toFixed(2)}</td>
                        <td> - </td> <!-- Rank Pct TODO if needed -->
                        <td style="${getChgColor(item.Final_WRS_10D_Chg)}">
                            ${item.Final_WRS_10D_Chg !== null ? item.Final_WRS_10D_Chg.toFixed(1) + '%' : '-'}
                        </td>
                        <td>${item.Count}</td>
                        <td>${item.WRS_6mo.toFixed(2)}</td>
                        <td> - </td>
                        <td>${item.WRS_MD_6mo.toFixed(2)}</td>
                        <td> - </td>
                        <td>${item.Win_Rate.toFixed(1)}%</td>
                        <td>${item.WRS_3mo.toFixed(2)}</td>
                        <td>${item.WRS_1mo.toFixed(2)}</td>
                        <td class="${difClass}">${item.WRS_Dif.toFixed(2)}</td>
                    `;
                    tbody.appendChild(tr);
                });

            } else {
                // Individual / Drilldown / Lists
                // Added RS_DiF, 50DIV, Trends, Up/Down
                thead.innerHTML = `
                    <th onclick="sortTable('Ticker')">Ticker ⬍</th>
                    <th onclick="sortTable('Sector')">Sector ⬍</th>
                    <th onclick="sortTable('Industry')">Industry ⬍</th>
                    <th onclick="sortTable('Price')">Price ($) ⬍</th>
                    <th onclick="sortTable('Market Cap')">Market Cap ($) ⬍</th>
                    <th onclick="sortTable('MarketCapRank')">MC Rank ⬍</th>
                    <th onclick="sortTable('RS_6mo')">RS (6mo) ⬍</th>
                    <th onclick="sortTable('RS_Rank_Pct')">RS Rank (%) ⬍</th>
                    <th onclick="sortTable('RS_6mo_10D_Chg')">10D Chg (%) ⬍</th>
                    <th onclick="sortTable('RS_3mo')">RS (3mo) ⬍</th>
                    <th onclick="sortTable('RS_1mo')">RS (1mo) ⬍</th>
                    <th onclick="sortTable('RS_DiF')">
                        RS_DiF ⬍
                        <span style="font-size:12px; cursor:pointer;" onclick="showFilterPopup(event, 'RS_DiF')">🔍</span>
                    </th>
                    <th onclick="sortTable('50DIV')">50DIV (%) ⬍</th>
                    <th onclick="sortTable('CY_Trend')">CY Trend (%) ⬍</th>
                    <th onclick="sortTable('NY_Trend')">NY Trend (%) ⬍</th>
                    <th onclick="sortTable('Up_Count')">Up # ⬍</th>
                    <th onclick="sortTable('Down_Count')">Down # ⬍</th>
                    <th onclick="sortTable('Up_Down_Ratio')">Up/(Up+Down) ⬍</th>
                `;

                data.forEach(item => {
                    const tr = document.createElement('tr');

                    // Colors
                    const rs6Class = item.RS_6mo > 0 ? 'rs-pos' : 'rs-neg';
                    const rs3Class = item.RS_3mo > 0 ? 'rs-pos' : 'rs-neg';
                    const rs1Class = item.RS_1mo > 0 ? 'rs-pos' : 'rs-neg';
                    const difClass = item.RS_DiF > 0 ? 'rs-pos' : (item.RS_DiF < 0 ? 'rs-neg' : '');

                    // Format Large Numbers
                    const mcStr = item.Market_Cap_Readable || item['Market Cap']; // Use readable if avail

                    const cyColor = (parseFloat(item.CY_Trend) >= 5) ? 'rs-pos' : '';
                    const nyColor = (parseFloat(item.NY_Trend) >= 5) ? 'rs-pos' : '';

                    tr.innerHTML = `
                        <td style="font-weight:bold;">
                            <a href="https://finance.yahoo.com/quote/${item.Ticker}" target="_blank" style="color:#fff; text-decoration:none">
                                ${item.Ticker}
                            </a>
                        </td>
                        <td>${item.Sector}</td>
                        <td>${item.Industry}</td>
                        <td>${item.Price}</td>
                        <td>${mcStr}</td>
                        <td>${item.MarketCapRank || '-'}</td>
                        <td class="${rs6Class}">${item.RS_6mo}</td>
                        <td>${item.RS_Rank_Pct ? item.RS_Rank_Pct.toFixed(1) + '%' : '-'}</td>
                        <td style="${getChgColor(item.RS_6mo_10D_Chg)}">
                            ${item.RS_6mo_10D_Chg !== null ? item.RS_6mo_10D_Chg.toFixed(1) + '%' : '-'}
                        </td>
                        <td class="${rs3Class}">${item.RS_3mo}</td>
                        <td class="${rs1Class}">${item.RS_1mo}</td>
                        <td class="${difClass}">${item.RS_DiF !== undefined ? item.RS_DiF.toFixed(2) : '-'}</td>
                        <td>${item['50DIV']}%</td>
                        <td class="${cyColor}">${item.CY_Trend}%</td>
                        <td class="${nyColor}">${item.NY_Trend}%</td>
                        <td>${item.Up_Count}</td>
                        <td>${item.Down_Count}</td>
                        <td>${item.Up_Down_Ratio}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        function getChgColor(val) {
            if (val === null || val === undefined) return "";
            if (val > 0) return "color: #00e676;";
            if (val < 0) return "color: #ff5252;";
            return "";
        }

        function drillDown(key) {
            appState.mode = 'DRILLDOWN';
            appState.drillDownKey = key;
            appState.sort = { key: 'RS_6mo', asc: false };

            document.getElementById('search-input').value = '';
            appState.filterText = '';

            updateUI();
            window.scrollTo(0, 0); // Scroll to top
        }

        // --- Excel Download ---
        function downloadExcel() {
            // Determine data based on current view modes (but ignore filters for export normally? 
            // Result: Export *Visible* data or *All* data of current mode? 
            // Usually user wants what they see. Let's export filtered data.
            const data = getFilteredAndSortedData();

            if (data.length === 0) {
                alert("No data to export");
                return;
            }

            let excelData = [];

            if (appState.mode === 'WRS' || appState.mode === 'RISING_SECTORS') {
                excelData = data.map(item => ({
                    'Sector': item.Sector,
                    'Industry': item.Industry,
                    'Final WRS': item.Final_WRS.toFixed(4),
                    'WRS(6mo)': item.WRS_6mo.toFixed(4),
                    'WRS(6mo)_10D_Chg%': item.Final_WRS_10D_Chg !== null ? parseFloat(item.Final_WRS_10D_Chg.toFixed(2)) : null,
                    'WRS_MD(6mo)': item.WRS_MD_6mo.toFixed(4),
                    'Win-Rate(%)': item.Win_Rate.toFixed(2),
                    'Total Count': item.Count,
                    'WRS(3mo)': item.WRS_3mo.toFixed(4),
                    'WRS(1mo)': item.WRS_1mo.toFixed(4),
                    'WRS_Dif': item.WRS_Dif ? parseFloat(item.WRS_Dif.toFixed(4)) : null // Add new column
                }));
            } else {
                excelData = data.map(item => ({
                    'Ticker': item.Ticker,
                    'Sector': item.Sector,
                    'Industry': item.Industry,
                    'Price': item.Price,
                    'Market Cap': item['Market Cap'],
                    'RS(6mo)': item.RS_6mo,
                    'RS(6mo)_10D_Chg%': item.RS_6mo_10D_Chg !== null ? parseFloat(item.RS_6mo_10D_Chg.toFixed(2)) : null,
                    'RS Rank%': item.RS_Rank_Pct,
                    'RS(3mo)': item.RS_3mo,
                    'RS(1mo)': item.RS_1mo,
                    'RS_DiF': item.RS_DiF ? parseFloat(item.RS_DiF.toFixed(4)) : null, // Add new column
                    '50DIV': item['50DIV'],
                    'CY Trend': item.CY_Trend,
                    'NY Trend': item.NY_Trend,
                    'Up Count': item.Up_Count,
                    'Down Count': item.Down_Count,
                    'Up/Down Ratio': item.Up_Down_Ratio
                }));
            }

            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();

            const sheetName = (appState.mode === 'WRS' || appState.mode === 'RISING_SECTORS') ? 'Sector_WRS' : 'Individual_RS';

            XLSX.utils.book_append_sheet(wb, ws, sheetName);

            // Filename with date
            const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, "");
            XLSX.writeFile(wb, `RS_Investment_${sheetName}_${dateStr}.xlsx`);
        }

    </script>
</body>

</html>

updateUI();
}

function handleSearch() {
const input = document.getElementById('search-input');
appState.filterText = input.value.trim().toLowerCase();
updateUI();
}

// --- Rising Modes ---
function showRisingStocks() {
appState.mode = 'RISING_STOCKS';
// Sort by NY_Trend Desc
appState.sort = { key: 'NY_Trend', asc: false };

// Reset filters to avoid confusion, logic handled in getFilteredAndSortedData
appState.filterRS_DiF = 'ALL';

document.getElementById('search-input').value = '';
updateUI();
}

function showRisingSectors() {
appState.mode = 'RISING_SECTORS';
// Sort by Win_Rate Desc
appState.sort = { key: 'Win_Rate', asc: false };

// Ensure WRS calculated
if (groupedData.length === 0) calculateWRS();

appState.filterWRS_Dif = 'ALL';
document.getElementById('search-input').value = '';
updateUI();
}

// --- Filter Popup Logic ---
function showFilterPopup(event, type) {
event.stopPropagation();
const th = event.target.closest('th');

// Remove existing popup if any
const existing = document.getElementById('filter-popup');
if (existing) existing.remove();

const popup = document.createElement('div');
popup.id = 'filter-popup';
popup.className = 'filter-popup';

// Determine current state
let current = type === 'RS_DiF' ? appState.filterRS_DiF : appState.filterWRS_Dif;
// ALL, POS, NEG
const isPos = current === 'POS' || current === 'ALL';
const isNeg = current === 'NEG' || current === 'ALL';

popup.innerHTML = `
<label><input type="checkbox" id="chk-pos" ${isPos ? 'checked' : '' }> (+) Positive</label>
<label><input type="checkbox" id="chk-neg" ${isNeg ? 'checked' : '' }> (-) Negative</label>
<button onclick="applyFilter('${type}')">확인</button>
`;

document.body.appendChild(popup);

// Position
const rect = th.getBoundingClientRect();
popup.style.left = rect.left + 'px';
popup.style.top = (rect.bottom + window.scrollY + 5) + 'px';
popup.style.display = 'block';
}

function applyFilter(type) {
const pos = document.getElementById('chk-pos').checked;
const neg = document.getElementById('chk-neg').checked;

let val = 'ALL';
if (pos && neg) val = 'ALL';
else if (pos) val = 'POS';
else if (neg) val = 'NEG';
else val = 'NONE'; // Should we support NONE? Effectively hides all.

if (type === 'RS_DiF') appState.filterRS_DiF = val;
else appState.filterWRS_Dif = val;

document.getElementById('filter-popup').style.display = 'none';
updateUI();
}

function calculateWRS() {
const groups = {};

globalData.forEach(item => {
// [Strict Exclusion] Exclude items if MC, Sector, or Industry is invalid
if (!item['Market Cap'] || item['Market Cap'] === 'N/A' || item['Market Cap'] === 'null') return;
if (!item['Sector'] || item['Sector'] === 'N/A' || item['Sector'] === 'null' || item['Sector'] === 'nan') return;
if (!item['Industry'] || item['Industry'] === 'N/A' || item['Industry'] === 'null' || item['Industry'] === 'nan')
return;

const key = `${item.Sector}|${item.Industry}`;
if (!groups[key]) {
groups[key] = {
Sector: item.Sector,
Industry: item.Industry,
Count: 0,
TotalMC: 0,
WeightedSum6: 0,
WeightedSum3: 0,
WeightedSum1: 0,
RS_Values: [], // For median calculation
WinCount: 0 // For Win-rate calculation
};
}

const mc = parseMarketCap(item['Market Cap']);
// Use RS_6mo, RS_3mo, RS_1mo for Weighted RS
const rs6 = item.RS_6mo || 0;
const rs3 = item.RS_3mo || 0;
const rs1 = item.RS_1mo || 0;

if (mc > 0) {
groups[key].Count += 1;
groups[key].TotalMC += mc;
groups[key].WeightedSum6 += (mc * rs6);
groups[key].WeightedSum3 += (mc * rs3);
groups[key].WeightedSum1 += (mc * rs1);
groups[key].RS_Values.push(rs6); // Collect for median

if (rs6 > 0) {
groups[key].WinCount += 1;
}
}
});

groupedData = Object.values(groups).map(g => {
// Calculate median
const sortedRS = g.RS_Values.sort((a, b) => a - b);
const mid = Math.floor(sortedRS.length / 2);
const median = sortedRS.length % 2 === 0
? (sortedRS[mid - 1] + sortedRS[mid]) / 2
: sortedRS[mid];

const wrs6mo = g.TotalMC > 0 ? (g.WeightedSum6 / g.TotalMC) : 0;
const winRate = g.Count > 0 ? (g.WinCount / g.Count) : 0; // 0.0 ~ 1.0

// Final WRS 공식: WRS(6MO)×40% + WRS_MD(6MO)×40% + Win-rate×(1-(1/total count))×20%
// Win-rate part needs to be scaled? Request says: Win-rate = (Count > 0) / Total Count
// "단위는 %이고 소수점 둘째자리까지 표시한다." -> Display only.
// Formula uses Win-rate as decimal? Or percentage?
// Example: Win-rate = 71.42% = 0.7142
// Example Calc: 2.7405*0.4 + 0.2661*0.4 + 0.7142*(1-1/7)*0.2
// So Win-rate is used as a decimal (0.7142) but logic probably implies the raw value before % formatting.
// Re-reading logic: "0.7142×(1-1/7)×20%" -> Yes, decimal.

const winFactor = g.Count > 1 ? (1 - (1 / g.Count)) : 0; // Avoid division by zero issues or single item? Logic says
1-1/count. If count=1, 1-1=0.

// WRS_MD(6MO) is `median`

// Final WRS
const finalWRS = (wrs6mo * 0.4) + (median * 0.4) + (winRate * winFactor * 0.2);
// Wait, example: 0.7142...
// Let's re-read the example carefully.
// "Computer Hardware의 Final WRS는 = 1.0962 + 0.1064 + 0.6122×20% = 1.3250"
// 0.6122 comes from 0.7142 * (6/7) = 0.61217...
// 0.6122 * 0.2 = 0.12244...
// 1.0962 + 0.1064 + 0.1224 = 1.325
// The term "0.6122" is "Win-rate * (1 - 1/Count)".
// Wait, WRS values are usually around 0~10 or -10~10?
// Example WRS(6MO) = 2.7405.
// Example WRS_MD(6MO) = 0.2661.
// Win-rate = 0.7142 (71.42%).
// If I just add them: 2.74*0.4 + 0.26*0.4 + 0.71*...*0.2?
// Let's check magnitude.
// 2.74 * 0.4 = 1.096. Correct.
// 0.26 * 0.4 = 0.106. Correct.
// 0.7142 * (6/7) * 0.2 = 0.6122 * 0.2 = 0.1224.
// Sum = 1.096 + 0.106 + 0.122 = 1.324.
// The user example says "= 2.7405×40% + 0.2661×40% + 0.7142×(1-1/7)×20%"
// AND THEN "= 1.0962 + 0.1064 + 0.6122×20%"
// The last term "0.6122 * 20%" suggests 0.12244.
// It seems Win-rate should be treated as 0.xx (decimal).
// However, RS values can be large (e.g. 20, 30). Win rate is 0-1.
// Is there a scaling factor?
// "Win-rate 단위는 %이고" -> 71.42. If used as 71.42:
// 71.42 * (6/7) * 0.2 = 61.21 * 0.2 = 12.24.
// This would dominate the score (1.0 vs 12.24).
// So likely it is used as decimal (0.7142).
// The User Example:
// = 1.0962 + 0.1064 + 0.6122×20%
// 0.6122 is (5/7) * (6/7) ? No. Win-rate is 5/7 = 0.7142.
// 0.7142 * (1 - 1/7) = 0.7142 * 0.8571 = 0.61217... matches 0.6122.
// So the 3rd term is 0.6122 * 20% = 0.1224.
// Total = 1.3250.
// So yes, Win-rate is used as a decimal (0.0 to 1.0) in the calculation.

// BUT wait, is RS typically percentage? "RS(6mo): (개별종목 기간 수익률) - (QQQ 기간 수익률)".
// If a stock is up 50% and QQQ is up 10%, RS is 40? or 0.40?
// If RS is 2.74 (as in example), that sounds like 2.74%? Or factor?
// Usually RS is relative strength index 0-100 or a percentage difference.
// If RS_6mo is 2.74, and WRS_MD is 0.26.
// These are small numbers. Maybe they are percentages like 2.74%?
// If so, 0.71 (71%) is comparable?
// actually 2.74% is 0.0274.
// If RS is raw percentage (e.g. 2.74 means 2.74%), then Win-rate (0.71) is huge (71%).
// If RS is just a number (e.g. 2.74), and Win Rate is 0.71.
// Let's assume the example is the ground truth.
// Win Rate part contributes ~0.12 to the score.
// WRS part contributes ~1.1 to the score.
// So Win Rate is a minor booster. This makes sense.

return {
Sector: g.Sector,
Industry: g.Industry,
Count: g.Count,
WRS_6mo: wrs6mo,
WRS_3mo: g.TotalMC > 0 ? (g.WeightedSum3 / g.TotalMC) : 0,
WRS_1mo: g.TotalMC > 0 ? (g.WeightedSum1 / g.TotalMC) : 0,
WRS_DiF: (g.TotalMC > 0 ? (g.WeightedSum1 / g.TotalMC) : 0) - (g.TotalMC > 0 ? (g.WeightedSum3 / g.TotalMC) : 0) -
wrs6mo, // [Added]
WRS_6mo_MD: median, // Median
Win_Rate: winRate,
Final_WRS: finalWRS,
TotalMC: g.TotalMC
};
});

// Calculate percentiles for WRS
const wrs6moValues = groupedData.map(d => d.WRS_6mo);
const wrsMDValues = groupedData.map(d => d.WRS_6mo_MD);
const finalWRSValues = groupedData.map(d => d.Final_WRS); // [Added]

groupedData.forEach(item => {
item.WRS_Rank_Pct = calculatePercentileRank(item.WRS_6mo, wrs6moValues);
item.WRS_MD_Rank_Pct = calculatePercentileRank(item.WRS_6mo_MD, wrsMDValues);
item.Final_WRS_Rank_Pct = calculatePercentileRank(item.Final_WRS, finalWRSValues); // [Added]
});
}

// Helper function for percentile calculation
function calculatePercentileRank(value, allValues) {
if (value === null || value === undefined) return null;
const sorted = allValues.filter(v => v !== null && v !== undefined).sort((a, b) => b - a);
if (sorted.length === 0) return null;
const rank = sorted.indexOf(value) + 1;
return parseFloat(((rank / sorted.length) * 100).toFixed(2));
}

function getFilteredAndSortedData() {
let targetData = [];

if (appState.mode === 'INDIVIDUAL') {
targetData = globalData;
} else if (appState.mode === 'WRS') {
targetData = groupedData;
} else if (appState.mode === 'DRILLDOWN') {
const [sec, ind] = appState.drillDownKey.split('|');
targetData = globalData.filter(d => d.Sector === sec && d.Industry === ind);
} else if (appState.mode === 'TODAYS_LIST') {
// Today's List 필터링 로직
// (A) 적격 섹터/산업 찾기
const qualifiedSectors = groupedData.filter(wrs => {
return wrs.Count >= 2 && // Count ≥ 2
wrs.Win_Rate >= 0.6 && // Win-rate ≥ 60%
wrs.Final_WRS_Rank_Pct <= 30; // Final WRS rank ≤ 30% }); // (B) 적격 섹터에 속하는 종목 중 RS rank ≤ 30% 인 종목들 const
    qualifiedKeys=new Set( qualifiedSectors.map(s=> `${s.Sector}|${s.Industry}`)
    );

    targetData = globalData.filter(stock => {
    const key = `${stock.Sector}|${stock.Industry}`;
    return qualifiedKeys.has(key) &&
    stock.RS_Rank_Pct !== null &&
    stock.RS_Rank_Pct <= 30 && // RS rank ≤ 30% (상위 30%) stock['50DIV']> 0; // 50DIV > 0 (New Condition)
        });
        } else if (appState.mode === 'TODAYS_MAIN') {
        // Today's Main 필터링 (Today's List + Trend>=5% + 50DIV<=55%) // 1. 적격 섹터 (Today's List와 동일) const
            qualifiedSectors=groupedData.filter(wrs=> {
            return wrs.Count >= 2 &&
            wrs.WRS_Rank_Pct <= 20 && wrs.WRS_MD_Rank_Pct <=40; }); const qualifiedKeys=new Set(
                qualifiedSectors.map(s=> `${s.Sector}|${s.Industry}`)
                );

                targetData = globalData.filter(stock => {
                const key = `${stock.Sector}|${stock.Industry}`;

                // 기본 Today's List 조건
                const basicCondition = qualifiedKeys.has(key) &&
                stock.RS_Rank_Pct !== null &&
                stock.RS_Rank_Pct <= 30 && stock['50DIV']> 0;

                    // 추가 조건: CY_Trend >= 5, NY_Trend >= 5, 50DIV <= 55 // Note: Trend values are in percentage (e.g.
                        5.0=5%) const extraCondition=(stock.CY_Trend>= 5) &&
                        (stock.NY_Trend >= 5) &&
                        (stock['50DIV'] <= 55); return basicCondition && extraCondition; }); } else if
                            (appState.mode==='TODAYS_TOP' ) { // Today's Top 필터링 (Today's List + Order=YES + Trend>=5%)
                            // 1. 적격 섹터 (Today's List와 동일)
                            const qualifiedSectors = groupedData.filter(wrs => {
                            return wrs.Count >= 2 &&
                            wrs.Win_Rate >= 0.6 &&
                            wrs.Final_WRS_Rank_Pct <= 30; }); const qualifiedKeys=new Set( qualifiedSectors.map(s=>
                                `${s.Sector}|${s.Industry}`)
                                );

                                targetData = globalData.filter(stock => {
                                const key = `${stock.Sector}|${stock.Industry}`;

                                // 기본 Today's List 조건
                                const basicCondition = qualifiedKeys.has(key) &&
                                stock.RS_Rank_Pct !== null &&
                                stock.RS_Rank_Pct <= 30 && stock['50DIV']> 0;

                                    // 추가 조건: Order=YES, CY_Trend >= 0.05, NY_Trend >= 0.05
                                    const extraCondition = (stock.Order === 'YES') &&
                                    (stock.CY_Trend >= 0.05) &&
                                    (stock.NY_Trend >= 0.05);

                                    return basicCondition && extraCondition;
                                    });
                                    } else if (appState.mode === 'RISING_STOCKS') {
                                    // 급등/반등가능성↑종목:
                                    // 1) RS_DiF > 0
                                    // 2) CY_Trend > 0
                                    // 3) NY_Trend > 0
                                    targetData = globalData.filter(stock =>
                                    stock.RS_DiF > 0 &&
                                    stock.CY_Trend > 0 &&
                                    stock.NY_Trend > 0
                                    );
                                    } else if (appState.mode === 'RISING_SECTORS') {
                                    // 급등/반등가능성↑섹터: WRS_DiF > 0
                                    // Sort is handled in sort section (Win_Rate)
                                    targetData = groupedData.filter(g => g.WRS_DiF > 0);
                                    }

                                    // 1. Column Filters (RS_DiF / WRS_DiF)
                                    if (appState.filterRS_DiF !== 'ALL' && appState.mode !== 'WRS' && appState.mode !==
                                    'RISING_SECTORS') {
                                    if (appState.filterRS_DiF === 'POS') {
                                    targetData = targetData.filter(d => d.RS_DiF > 0);
                                    } else if (appState.filterRS_DiF === 'NEG') {
                                    targetData = targetData.filter(d => d.RS_DiF < 0); } } if (appState.filterWRS_Dif
                                        !=='ALL' && (appState.mode==='WRS' || appState.mode==='RISING_SECTORS' )) { if
                                        (appState.filterWRS_Dif==='POS' ) { targetData=targetData.filter(d=> d.WRS_DiF >
                                        0);
                                        } else if (appState.filterWRS_Dif === 'NEG') {
                                        targetData = targetData.filter(d => d.WRS_DiF < 0); } } // 2. Search Text Filter
                                            if (appState.filterText) { targetData=targetData.filter(item=> {
                                            return Object.values(item).some(val =>
                                            String(val).toLowerCase().includes(appState.filterText)
                                            );
                                            });
                                            }

                                            // 3. Sort
                                            targetData.sort((a, b) => {
                                            let valA = a[appState.sort.key];
                                            let valB = b[appState.sort.key];

                                            if (appState.sort.key === 'Market Cap') {
                                            valA = parseMarketCap(valA);
                                            valB = parseMarketCap(valB);
                                            }

                                            if (typeof valA === 'string') valA = valA.toUpperCase();
                                            if (typeof valB === 'string') valB = valB.toUpperCase();

                                            // Handle nulls
                                            if (valA === undefined || valA === null) valA = -999999;
                                            if (valB === undefined || valB === null) valB = -999999;

                                            if (valA < valB) return appState.sort.asc ? -1 : 1; if (valA> valB) return
                                                appState.sort.asc ? 1 : -1;
                                                return 0;
                                                });

                                                return targetData;
                                                }

                                                function parseMarketCap(mcStr) {
                                                if (!mcStr || mcStr === 'N/A') return 0;
                                                if (typeof mcStr === 'number') return mcStr;
                                                let val = parseFloat(mcStr.replace(/[^0-9.-]/g, ''));
                                                if (mcStr.includes('B')) val *= 1_000_000_000;
                                                if (mcStr.includes('M')) val *= 1_000_000;
                                                if (mcStr.includes('T')) val *= 1_000_000_000_000;
                                                return val;
                                                }

                                                function renderTable(data) {
                                                const thead = document.querySelector('table thead tr');
                                                const tbody = document.getElementById('table-body');
                                                tbody.innerHTML = '';

                                                // Determine Layout Type
                                                const isWRSLayout = (appState.mode === 'WRS' || appState.mode ===
                                                'RISING_SECTORS');

                                                if (isWRSLayout) {
                                                thead.innerHTML = `
                                                <th onclick="sortTable('Sector')" style="text-align: center;">Sector ⬍
                                                </th>
                                                <th onclick="sortTable('Industry')" style="text-align: center;">Industry
                                                    ⬍</th>
                                                <th onclick="sortTable('Final_WRS')" style="text-align: center;">Final
                                                    WRS ⬍</th>
                                                <th onclick="sortTable('Final_WRS_Rank_Pct')"
                                                    style="text-align: center;">Final Rank (%) ⬍</th>
                                                <th onclick="sortTable('Final_WRS_10D_Chg')"
                                                    style="text-align: center;">10D Chg (%) ⬍</th>
                                                <th onclick="sortTable('Count')" style="text-align: center;">Total Count
                                                    ⬍</th>
                                                <th onclick="sortTable('WRS_6mo')" style="text-align: center;">WRS (6mo)
                                                    ⬍</th>
                                                <th onclick="sortTable('WRS_Rank_Pct')" style="text-align: center;">WRS
                                                    Rank (%) ⬍</th>
                                                <th onclick="sortTable('WRS_6mo_MD')" style="text-align: center;">WRS_MD
                                                    (6mo) ⬍</th>
                                                <th onclick="sortTable('WRS_MD_Rank_Pct')" style="text-align: center;">
                                                    WRS_MD Rank (%) ⬍</th>
                                                <th onclick="sortTable('Win_Rate')" style="text-align: center;">Win-rate
                                                    (%) ⬍</th>
                                                <th onclick="sortTable('WRS_3mo')" style="text-align: center;">WRS (3mo)
                                                    ⬍</th>
                                                <th onclick="sortTable('WRS_1mo')" style="text-align: center;">WRS (1mo)
                                                    ⬍</th>
                                                <th onclick="showFilterPopup(event, 'WRS_Dif')"
                                                    style="text-align: center; cursor: pointer; background-color: #444;">
                                                    WRS_Dif 🔍</th>
                                                `;
                                                } else {
                                                thead.innerHTML = `
                                                <th onclick="sortTable('Ticker')">Ticker ⬍</th>
                                                <th onclick="sortTable('Sector')">Sector ⬍</th>
                                                <th onclick="sortTable('Industry')">Industry ⬍</th>
                                                <th onclick="sortTable('Price')">Price ($) ⬍</th>
                                                <th onclick="sortTable('Market Cap')">Market Cap ($) ⬍</th>
                                                <th onclick="sortTable('MarketCapRank')">MC Rank ⬍</th>
                                                <th onclick="sortTable('RS_6mo')">RS (6mo) ⬍</th>
                                                <th onclick="sortTable('RS_Rank_Pct')">RS Rank (%) ⬍</th>
                                                <th onclick="sortTable('RS_6mo_10D_Chg')">10D Chg (%) ⬍</th>
                                                <th onclick="sortTable('RS_3mo')">RS (3mo) ⬍</th>
                                                <th onclick="sortTable('RS_1mo')">RS (1mo) ⬍</th>
                                                <th onclick="showFilterPopup(event, 'RS_DiF')"
                                                    style="cursor: pointer; background-color: #444;">RS_DiF 🔍</th>
                                                <th onclick="sortTable('50DIV')">50DIV (%) ⬍</th>
                                                <th onclick="sortTable('CY_Trend')">CY Trend (%) ⬍</th>
                                                <th onclick="sortTable('NY_Trend')">NY Trend (%) ⬍</th>
                                                <th onclick="sortTable('Up_Count')">Up # ⬍</th>
                                                <th onclick="sortTable('Down_Count')">Down # ⬍</th>
                                                <th onclick="sortTable('Up_Down_Ratio')">Up/(Up+Down) ⬍</th>
                                                `;
                                                }

                                                // Rank Calc for Individual/Drilldown
                                                if (!isWRSLayout) {
                                                const sortedRef = [...data].sort((a, b) => parseMarketCap(b['Market
                                                Cap']) - parseMarketCap(a['Market Cap']));
                                                const rankMap = {};
                                                sortedRef.forEach((item, idx) => rankMap[item.Ticker] = idx + 1);
                                                data.forEach(item => item.MarketCapRank = rankMap[item.Ticker]);
                                                }

                                                data.forEach(item => {
                                                const tr = document.createElement('tr');

                                                if (isWRSLayout) {
                                                tr.style.cursor = 'pointer';
                                                // [Change] Double click -> Single click
                                                tr.onclick = () => enterDrillDown(item.Sector, item.Industry);
                                                tr.title = "Click to see details";

                                                const wrsRankDisplay = item.WRS_Rank_Pct !== null && item.WRS_Rank_Pct
                                                !== undefined
                                                ? `${item.WRS_Rank_Pct.toFixed(2)}%`
                                                : 'N/A';
                                                const wrsMDRankDisplay = item.WRS_MD_Rank_Pct !== null &&
                                                item.WRS_MD_Rank_Pct !== undefined
                                                ? `${item.WRS_MD_Rank_Pct.toFixed(2)}%`
                                                : 'N/A';

                                                tr.innerHTML = `
                                                <td style="text-align: center; white-space: nowrap;">${item.Sector}</td>
                                                <td style="text-align: center; white-space: nowrap;">${item.Industry}
                                                </td>
                                                <td style="text-align: center; font-weight: bold;">${item.Final_WRS ?
                                                    item.Final_WRS.toFixed(4) : '0.0000'}</td>
                                                <td style="text-align: center;">${item.Final_WRS_Rank_Pct ?
                                                    item.Final_WRS_Rank_Pct.toFixed(2) + '%' : 'N/A'}</td>
                                                <td
                                                    style="text-align: center; font-weight: bold; color: ${item.Final_WRS_10D_Chg > 0 ? '#00e676' : (item.Final_WRS_10D_Chg < 0 ? '#ff5252' : 'inherit')}">
                                                    ${item.Final_WRS_10D_Chg !== undefined && item.Final_WRS_10D_Chg !==
                                                    null ? (item.Final_WRS_10D_Chg > 0 ? '+' : '') +
                                                    item.Final_WRS_10D_Chg.toFixed(2) + '%' : '-'}
                                                </td>
                                                <td style="text-align: center;">${item.Count}</td>
                                                <td class="${item.WRS_6mo > 0 ? 'rs-pos' : 'rs-neg'}"
                                                    style="text-align: center;">${item.WRS_6mo.toFixed(4)}</td>
                                                <td style="text-align: center;">${wrsRankDisplay}</td>
                                                <td class="${item.WRS_6mo_MD > 0 ? 'rs-pos' : 'rs-neg'}"
                                                    style="text-align: center;">${item.WRS_6mo_MD.toFixed(4)}</td>
                                                <td style="text-align: center;">${wrsMDRankDisplay}</td>
                                                <td style="text-align: center;">${(item.Win_Rate * 100).toFixed(2)}%
                                                </td>
                                                <td class="${item.WRS_3mo > 0 ? 'rs-pos' : 'rs-neg'}"
                                                    style="text-align: center;">${item.WRS_3mo.toFixed(4)}</td>
                                                <td class="${item.WRS_1mo > 0 ? 'rs-pos' : 'rs-neg'}"
                                                    style="text-align: center;">${item.WRS_1mo.toFixed(4)}</td>
                                                <td class="${item.WRS_DiF > 0 ? 'rs-pos' : (item.WRS_DiF < 0 ? 'rs-neg' : '')}"
                                                    style="text-align: center; font-weight: bold;">${item.WRS_DiF ?
                                                    item.WRS_DiF.toFixed(4) : '0.0000'}</td>
                                                `;
                                                } else {
                                                let mcDisplay = item['Market Cap'];
                                                if (typeof mcDisplay === 'number') mcDisplay = '$' +
                                                mcDisplay.toLocaleString();

                                                // [Change] Ticker Link
                                                const tickerLink = `<a
                                                    href="https://finance.yahoo.com/quote/${item.Ticker}/"
                                                    target="_blank"
                                                    style="color: inherit; text-decoration: underline;">${item.Ticker}</a>`;

                                                // RS Rank Pct Display
                                                const rsRankDisplay = item.RS_Rank_Pct !== null && item.RS_Rank_Pct !==
                                                undefined
                                                ? `${Number(item.RS_Rank_Pct).toFixed(2)}%`
                                                : 'N/A';

                                                // 10D Change Display
                                                const change10d = item.RS_6mo_10D_Chg;
                                                let change10dDisplay = '-';
                                                let change10dClass = '';
                                                if (change10d !== undefined && change10d !== null) {
                                                change10dDisplay = (change10d > 0 ? '+' : '') + change10d.toFixed(2) +
                                                '%';
                                                if (change10d > 0) change10dClass = 'rs-pos';
                                                else if (change10d < 0) change10dClass='rs-neg' ; } // 50DIV Display
                                                    const div50Display=item['50DIV'] !==null && item['50DIV']
                                                    !==undefined ? (item['50DIV']> 0 ? `+${item['50DIV'].toFixed(2)}%` :
                                                    `${item['50DIV'].toFixed(2)}%`)
                                                    : 'N/A';
                                                    const div50Class = item['50DIV'] > 0 ? 'rs-pos' : (item['50DIV'] < 0
                                                        ? 'rs-neg' : '' ); // RS Estimate Displays const
                                                        cyTrendDisplay=item.CY_Trend !==null && item.CY_Trend
                                                        !==undefined ? `${item.CY_Trend.toFixed(2)}%` : 'N/A' ; const
                                                        cyTrendClass=item.CY_Trend> 0 ? 'rs-pos' : (item.CY_Trend < 0
                                                            ? 'rs-neg' : '' ); const nyTrendDisplay=item.NY_Trend
                                                            !==null && item.NY_Trend !==undefined ?
                                                            `${item.NY_Trend.toFixed(2)}%` : 'N/A' ; const
                                                            nyTrendClass=item.NY_Trend> 0 ? 'rs-pos' : (item.NY_Trend <
                                                                0 ? 'rs-neg' : '' ); const upCountDisplay=item.Up_Count
                                                                !==null ? item.Up_Count : '-' ; const
                                                                downCountDisplay=item.Down_Count !==null ?
                                                                item.Down_Count : '-' ; const
                                                                upDownRatioDisplay=item.Up_Down_Ratio !==null &&
                                                                item.Up_Down_Ratio !==undefined ?
                                                                `${item.Up_Down_Ratio.toFixed(2)}%` : '-' ; const
                                                                rsDifDisplay=item.RS_DiF ? item.RS_DiF.toFixed(4)
                                                                : '0.0000' ; tr.innerHTML=` <td>
                                                                <strong>${tickerLink}</strong></td>
                                                                <td style="white-space: nowrap;">${item.Sector}</td>
                                                                <td style="white-space: nowrap;">${item.Industry}</td>
                                                                <td>$${Number(item.Price).toLocaleString(undefined, {
                                                                    minimumFractionDigits: 2, maximumFractionDigits: 2
                                                                    })}</td>
                                                                <td>${mcDisplay}</td>
                                                                <td>${item.MarketCapRank}</td>
                                                                <td class="${item.RS_6mo > 0 ? 'rs-pos' : 'rs-neg'}">
                                                                    ${Number(item.RS_6mo).toFixed(4)}</td>
                                                                <td>${rsRankDisplay}</td>
                                                                <td class="${change10dClass}"
                                                                    style="text-align: center; font-weight: bold;">
                                                                    ${change10dDisplay}</td>
                                                                <td class="${item.RS_3mo > 0 ? 'rs-pos' : 'rs-neg'}">
                                                                    ${Number(item.RS_3mo).toFixed(4)}</td>
                                                                <td class="${item.RS_1mo > 0 ? 'rs-pos' : 'rs-neg'}">
                                                                    ${Number(item.RS_1mo).toFixed(4)}</td>
                                                                <td class="${item.RS_DiF > 0 ? 'rs-pos' : (item.RS_DiF < 0 ? 'rs-neg' : '')}"
                                                                    style="font-weight:bold;">${rsDifDisplay}</td>
                                                                <td class="${div50Class}">${div50Display}</td>
                                                                <td class="${cyTrendClass}">${cyTrendDisplay}</td>
                                                                <td class="${nyTrendClass}">${nyTrendDisplay}</td>
                                                                <td>${upCountDisplay}</td>
                                                                <td>${downCountDisplay}</td>
                                                                <td>${upDownRatioDisplay}</td>

                                                                `;
                                                                }
                                                                tbody.appendChild(tr);
                                                                });
                                                                }

                                                                function enterDrillDown(sector, industry) {
                                                                appState.mode = 'DRILLDOWN';
                                                                appState.drillDownKey = `${sector}|${industry}`;
                                                                appState.filterText = '';
                                                                document.getElementById('search-input').value = '';
                                                                // Reset to RS sort for drilldown
                                                                appState.sort = { key: 'RS_6mo', asc: false };
                                                                updateUI();
                                                                }

                                                                function sortTable(key) {
                                                                if (appState.sort.key === key) appState.sort.asc =
                                                                !appState.sort.asc;
                                                                else { appState.sort.key = key; appState.sort.asc =
                                                                true; }
                                                                updateUI();
                                                                }

                                                                function downloadExcel() {
                                                                const data = getFilteredAndSortedData();
                                                                if (data.length === 0) return alert('데이터가 없습니다
                                                                (v1.2).');

                                                                const wb = XLSX.utils.book_new();
                                                                let excelData = [];
                                                                let fileName = "";

                                                                // Determine if WRS layout (including Rising Sectors)
                                                                const isWRSLayout = (appState.mode === 'WRS' ||
                                                                appState.mode === 'RISING_SECTORS');

                                                                if (isWRSLayout) {
                                                                excelData = data.map(item => ({
                                                                'Sector': item.Sector,
                                                                'Industry': item.Industry,
                                                                'Final WRS': item.Final_WRS ?
                                                                parseFloat(item.Final_WRS.toFixed(4)) : 0,
                                                                'Final Rank (%)': item.Final_WRS_Rank_Pct ?
                                                                parseFloat(item.Final_WRS_Rank_Pct.toFixed(2)) : null,
                                                                '10D Chg (%)': item.Final_WRS_10D_Chg ?
                                                                parseFloat(item.Final_WRS_10D_Chg.toFixed(2)) : null,
                                                                'Total Count': item.Count,
                                                                'WRS (6mo)': item.WRS_6mo ?
                                                                parseFloat(item.WRS_6mo.toFixed(4)) : 0,
                                                                'WRS Rank (%)': item.WRS_Rank_Pct ?
                                                                parseFloat(item.WRS_Rank_Pct.toFixed(2)) : null,
                                                                'WRS_MD (6mo)': item.WRS_6mo_MD ?
                                                                parseFloat(item.WRS_6mo_MD.toFixed(4)) : 0,
                                                                'WRS_MD Rank (%)': item.WRS_MD_Rank_Pct ?
                                                                parseFloat(item.WRS_MD_Rank_Pct.toFixed(2)) : null,
                                                                'Win-rate (%)': item.Win_Rate ?
                                                                parseFloat((item.Win_Rate * 100).toFixed(2)) : 0,
                                                                'WRS (3mo)': item.WRS_3mo ?
                                                                parseFloat(item.WRS_3mo.toFixed(4)) : 0,
                                                                'WRS (1mo)': item.WRS_1mo ?
                                                                parseFloat(item.WRS_1mo.toFixed(4)) : 0,
                                                                'WRS_Dif': item.WRS_DiF ?
                                                                parseFloat(item.WRS_DiF.toFixed(4)) : 0
                                                                }));
                                                                fileName = `WRS_Score_${new
                                                                Date().toISOString().slice(0, 10)}.xlsx`;
                                                                } else {
                                                                excelData = data.map(item => ({
                                                                'Ticker': item.Ticker,
                                                                'Sector': item.Sector,
                                                                'Industry': item.Industry,
                                                                'Price ($)': typeof item.Price === 'number' ? item.Price
                                                                : parseFloat(item.Price),
                                                                'Market Cap ($)': parseMarketCap(item['Market Cap']),
                                                                'MC Rank': item.MarketCapRank,
                                                                'RS (6mo)': item.RS_6mo ?
                                                                parseFloat(item.RS_6mo.toFixed(4)) : null,
                                                                'RS Rank (%)': item.RS_Rank_Pct ?
                                                                parseFloat(item.RS_Rank_Pct.toFixed(2)) : null,
                                                                '10D Chg (%)': item.RS_6mo_10D_Chg !== undefined &&
                                                                item.RS_6mo_10D_Chg !== null ?
                                                                parseFloat(item.RS_6mo_10D_Chg.toFixed(2)) : null,
                                                                'RS (3mo)': item.RS_3mo ?
                                                                parseFloat(item.RS_3mo.toFixed(4)) : null,
                                                                'RS (1mo)': item.RS_1mo ?
                                                                parseFloat(item.RS_1mo.toFixed(4)) : null,
                                                                'RS_DiF': item.RS_DiF ?
                                                                parseFloat(item.RS_DiF.toFixed(4)) : null,
                                                                '50DIV (%)': item['50DIV'] !== undefined &&
                                                                item['50DIV'] !== null ?
                                                                parseFloat(item['50DIV'].toFixed(2)) : null,
                                                                'CY Trend (%)': item.CY_Trend !== undefined &&
                                                                item.CY_Trend !== null ?
                                                                parseFloat(item.CY_Trend.toFixed(2)) : null,
                                                                'NY Trend (%)': item.NY_Trend !== undefined &&
                                                                item.NY_Trend !== null ?
                                                                parseFloat(item.NY_Trend.toFixed(2)) : null,
                                                                'Up #': item.Up_Count,
                                                                'Down #': item.Down_Count,
                                                                'Up/(Up+Down)': item.Up_Down_Ratio !== undefined &&
                                                                item.Up_Down_Ratio !== null ?
                                                                parseFloat(item.Up_Down_Ratio.toFixed(2)) : null
                                                                }));
                                                                const prefix = appState.mode === 'DRILLDOWN' ?
                                                                'Sector_Detail_' : 'RS_Investment_';
                                                                fileName = `${prefix}${new Date().toISOString().slice(0,
                                                                10)}.xlsx`;
                                                                }

                                                                const ws = XLSX.utils.json_to_sheet(excelData);
                                                                XLSX.utils.book_append_sheet(wb, ws, "Data");
                                                                XLSX.writeFile(wb, fileName);
                                                                }
                                                                </script>
                                                                </body>

                                                                </html>