<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Timeframe RS Investment</title>
    <link rel="shortcut icon" href="static/favicon.png">
    <style>
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --primary-color: #00e676;
            --text-color: #ffffff;
            --text-secondary: #b0b0b0;
            --danger-color: #ff5252;
            --border-color: #333;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 95%;
            max-width: 1600px;
            /* Wider for more columns */
            margin-top: 40px;
            text-align: center;
            flex-grow: 1;
        }

        h1 {
            margin-bottom: 20px;
        }

        .subtitle {
            color: #888;
            font-size: 14px;
            margin-bottom: 30px;
        }

        .info-box {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: left;
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        button {
            background-color: var(--primary-color);
            color: #000;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            transition: 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        #result-area {
            display: none;
            margin-top: 40px;
        }

        .btn-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .download-btn {
            background-color: #333;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
            transition: 0.2s;
            cursor: pointer;
        }

        .download-btn:hover {
            background-color: #555;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--surface-color);
            font-size: 13px;
        }

        th,
        td {
            text-align: left;
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            cursor: pointer;
            user-select: none;
            background-color: #252525;
            color: var(--text-secondary);
            position: sticky;
            top: 0;
            white-space: nowrap;
        }

        th:hover {
            background-color: #333;
        }

        .rs-pos {
            color: #00e676;
        }

        .rs-neg {
            color: #ff5252;
        }

        footer {
            width: 100%;
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 12px;
            border-top: 1px solid var(--border-color);
            margin-top: 50px;
            padding-bottom: 30px;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1 id="page-title" style="margin-bottom:5px;">US Market Multi-Timeframe RS Investment</h1>
        <h2 id="mode-subtitle" style="margin-top:0; margin-bottom:10px; font-size:24px; min-height:30px;"></h2>

        <p class="subtitle" id="last-updated" style="margin-bottom:15px;">업데이트 확인 중...</p>

        <!-- 날짜 선택 드롭다운 -->
        <div style="margin-bottom:30px;">
            <label for="date-selector" style="color: #aaa; margin-right: 10px; font-size: 14px;">
                📅 데이터 날짜:
            </label>
            <select id="date-selector" style="
                background-color: #2a2a2a;
                color: #fff;
                border: 1px solid #444;
                padding: 8px 15px;
                border-radius: 5px;
                font-size: 14px;
                cursor: pointer;
                min-width: 150px;
            ">
                <option value="static/result.json">Latest</option>
            </select>
        </div>

        <div class="info-box">
            <ul>
                <li><strong>일일 자동 업데이트</strong>: 매일 미국 장 마감 후 서버가 자동으로 데이터를 갱신합니다. (매일 UTC 21:00 / 한국 시간 오전 6:00)</li>
                <li><strong>RS Logic</strong>: (개별종목 기간 수익률) - (QQQ 기간 수익률)
                    <ul>
                        <li><strong>RS(6mo)</strong>: 120영업일, <strong>RS(3mo)</strong>: 60영업일, <strong>RS(1mo)</strong>:
                            20영업일</li>
                        <li>양수(+)면 벤치마크(QQQ) 대비 초과 수익, 음수(-)면 저조한 성과를 의미합니다.</li>
                    </ul>
                </li>
                <li><strong>시가총액</strong>: 주가 × 발행주식수 (기업의 총 시장 가치)</li>
                <li><strong>WRS (Weighted Relative Strength):</strong> 섹터/산업 내 종목들의 시가총액 가중 평균 RS (섹터/산업의 주도력)</li>
                <li><strong>WRS_MD:</strong> 섹터/산업 내 종목들의 RS(6mo) 중앙값 (Median)</li>
                <li><strong>Win-rate:</strong> (해당 Sector/Industry 내 RS(6mo) > 0 인 Ticker 수) / Total Count (단위: %)</li>
                <li><strong>Final WRS:</strong> 종합 점수 = WRS(6MO)×40% + WRS_MD(6MO)×40% + Win-rate×(1-(1/Total
                    Count))×20%</li>
                <li><strong>10D Chg (%):</strong> Final WRS의 10거래일 전 대비 변화율</li>
                <li><strong>50DIV(%):</strong> 현재 주가와 50일 이동평균선의 괴리율 (높을수록 과열)</li>

                <li><strong>EPS Trend:</strong> 시장 전문가들의 EPS(주당순이익) 예상치 30일전 대비 변화율 (CY:올해, NY:내년, CY와 NY 모두 5% 이상일 경우
                    장기 주도주가 될 가능성이 매우 높음)</li>
                <li><strong>Up/Down #:</strong> 최근 30일간 EPS 추정치를 상향(Up)/하향(Down) 조정한 애널리스트 수</li>
                <li><strong>Up/Down Ratio:</strong> 상향 조정 비율 (높을수록 실적 전망 긍정적)</li>
                <li><strong>Today's List 기준:</strong>
                    <ul>
                        <li><strong>섹터/산업:</strong> 종목 수 2개 이상 & WRS(6mo) 상위 20% & Median 상위 40%</li>
                        <li><strong>종목:</strong> 위 섹터에 속하며 RS(6mo) 상위 30% 이내 & <strong>50DIV > 0</strong></li>
                    </ul>
                </li>
                <li><strong>Today's Main 기준:</strong>
                    <ul>
                        <li><strong>Today's List</strong> 조건을 만족하는 종목 중</li>
                        <li><strong>CY Trend & NY Trend</strong> 모두 5% 이상</li>
                        <li><strong>50DIV</strong> 55% 이하</li>
                    </ul>
                </li>

            </ul>
        </div>

        <!-- 로딩 상태 표시 -->
        <div id="loading-msg" style="margin-top:20px; font-size:18px; color:var(--primary-color);">
            데이터 로딩 중... ⏳
        </div>

        <div id="result-area">
            <div class="btn-group">
                <span id="result-count" style="font-size:14px; color:#aaa;"></span>

                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="text" id="search-input" placeholder="Search..."
                        style="padding:10px; border-radius:4px; border:1px solid #333; background:#222; color:#fff;">

                    <button id="indiv-btn" onclick="showIndividualRS()" class="download-btn"
                        style="background-color:#2196f3; color:#ffffff;">
                        Individual RS
                    </button>

                    <button id="wrs-btn" onclick="showWRS()" class="download-btn"
                        style="background-color:#00e676; color:#000;">
                        Sector/Industry WRS
                    </button>

                    <button id="todays-list-btn" onclick="showTodaysList()" class="download-btn"
                        style="background-color:#ff9800; color:#000;">
                        Today's List
                    </button>

                    <button id="todays-main-btn" onclick="showTodaysMain()" class="download-btn"
                        style="background-color:#e91e63; color:#ffffff;">
                        Today's Main
                    </button>



                    <button onclick="downloadExcel()" class="download-btn">📥 엑셀 다운로드</button>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th onclick="sortTable('Ticker')">Ticker ⬍</th>
                        <th onclick="sortTable('Sector')">Sector ⬍</th>
                        <th onclick="sortTable('Industry')">Industry ⬍</th>
                        <th onclick="sortTable('Price')">Price ($) ⬍</th>
                        <th onclick="sortTable('Market Cap')">Market Cap ($) ⬍</th>
                        <th onclick="sortTable('MarketCapRank')">MC Rank ⬍</th>

                        <th onclick="sortTable('RS_6mo')">RS (6mo) ⬍</th>
                        <th onclick="sortTable('RS_3mo')">RS (3mo) ⬍</th>
                        <th onclick="sortTable('RS_1mo')">RS (1mo) ⬍</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>

    <footer>
        <p>RS Investment © 2026 | Idea & Built by In-kyu Lee</p>
        <div style="margin-top: 15px; font-size: 11px; color: #555; line-height: 1.5;">
            <strong>Disclaimer:</strong> Data provided by Yahoo Finance. This project is for <strong>personal
                educational purposes only</strong> and is <strong>not for commercial use</strong>.<br>
            All data is strictly for informational purposes and should not be considered financial advice.
        </div>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <script>
        // Global State & Data
        let globalData = [];
        let groupedData = []; // for WRS mode

        // App State
        let appState = {
            mode: 'INDIVIDUAL', // 'INDIVIDUAL' | 'WRS' | 'DRILLDOWN' | 'TODAYS_LIST'
            filterText: '',
            drillDownKey: null, // "Sector|Industry"
            sort: { key: 'RS_6mo', asc: false } // Default Sort: RS(6mo) Descending
        };

        // 페이지 로드 시 자동 실행
        window.onload = function () {
            const today = new Date();
            const kstDate = new Intl.DateTimeFormat('ko-KR', {
                timeZone: 'Asia/Seoul',
                year: 'numeric', month: '2-digit', day: '2-digit'
            }).format(today);
            document.getElementById('page-title').innerText = `${kstDate} RS Investment`;

            // Enter Key Listener for Search
            document.getElementById('search-input').addEventListener("keypress", function (event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    handleSearch();
                }
            });

            loadData();
            loadHistoryIndex();
        };

        // Load History Index and populate dropdown
        async function loadHistoryIndex() {
            try {
                const res = await fetch('./static/history_index.json?t=' + new Date().getTime());
                if (!res.ok) return; // No history yet

                const json = await res.json();
                const selector = document.getElementById('date-selector');

                // Add history options
                json.dates.forEach(item => {
                    const option = document.createElement('option');
                    option.value = 'static/' + item.filename;
                    option.text = item.date;
                    selector.appendChild(option);
                });

                // Add change listener
                selector.addEventListener('change', function () {
                    loadData(this.value);
                });

            } catch (e) {
                console.log("History index load failed:", e);
            }
        }

        async function loadData(url = './static/result.json') {
            const loader = document.getElementById('loading-msg');
            loader.style.display = 'block'; // Show loader when switching

            try {
                // Fetch Data
                const res = await fetch(url + '?t=' + new Date().getTime());
                if (res.status === 404) throw new Error("BOT_WORKING");
                if (!res.ok) throw new Error("데이터 로드 실패 code: " + res.status);

                const rawText = await res.text();
                // Fix NaN issue
                const sanitizedText = rawText.replace(/:\s*NaN/g, ': null');
                const json = JSON.parse(sanitizedText);

                // Initialize Data
                globalData = json.data;



                // Time Display
                if (json.last_updated) {
                    const lastUpdatedEl = document.getElementById('last-updated');
                    if (lastUpdatedEl) {
                        try {
                            const dateObj = new Date(json.last_updated.replace(' UTC', 'Z').replace(' ', 'T'));
                            const kstStr = new Intl.DateTimeFormat('ko-KR', {
                                timeZone: 'Asia/Seoul',
                                year: 'numeric', month: '2-digit', day: '2-digit',
                                hour: '2-digit', minute: '2-digit', second: '2-digit',
                                hour12: false
                            }).format(dateObj);
                            lastUpdatedEl.innerText = `Last update KST: ${kstStr}`;
                        } catch (e) {
                            lastUpdatedEl.innerText = `Last Updated: ${json.last_updated}`;
                        }
                    }
                }

                // Initial Render
                updateUI();

                document.getElementById('result-area').style.display = 'block';
                loader.style.display = 'none';

                // [Added] Load Historical Data for 5-day comparison (Async)
                loadHistoricalComparison();

            } catch (e) {
                if (e.message === "BOT_WORKING") {
                    loader.innerHTML = `<div style="padding: 20px; border: 2px dashed var(--primary-color);"><h3>🤖 봇이 작업중입니다!</h3><p>잠시 후 새로고침 해주세요.</p></div>`;
                } else {
                    loader.innerText = "Error: " + e.message;
                }
            }
        }

        // [Added] New Function for Historical Comparison
        async function loadHistoricalComparison() {
            try {
                // 1. Get History Index
                const res = await fetch('./static/history_index.json?t=' + new Date().getTime());
                if (!res.ok) return;
                const indexData = await res.json();

                // 2. Find 5-day ago file (Index 5 in sorted list, assuming current is 0 or fresh)
                // If viewing specific date, need to find relative 5 days.
                // For simplicity, let's assume we compare "Current View" vs "5 Indices Back".

                const dates = indexData.dates; // Sorted DESC
                // Currently loaded file: if 'static/result.json' -> treat as latest (Index -1? No, logic needed).
                // Let's just assume we want 5 days ago from LATEST for now, 
                // BUT if user selected a date, we should respect that.

                // Since this is a "LIVE" feature request ("지금 데이터가 계속 쌓이고 있잖아"),
                // primarily focused on Latest view.

                if (dates.length < 11) return; // Need at least 11 files (0 to 10)

                const targetHistory = dates[10]; // 0 is today ... 10 is 10 days ago (data points)

                if (!targetHistory) return;

                console.log("Loading 10-day ago data from:", targetHistory.filename);

                const histRes = await fetch('static/' + targetHistory.filename);
                if (!histRes.ok) return;
                const histJson = await histRes.json();
                const histData = histJson.data; // Raw tickers

                // 3. Calculate WRS for Historical Data
                const histWRS = calculateWRSForData(histData);

                // 4. Merge comparison into current groupedData
                groupedData.forEach(curr => {
                    const key = `${curr.Sector}|${curr.Industry}`;
                    const past = histWRS[key];
                    if (past && past.Final_WRS !== 0) {
                        const change = ((curr.Final_WRS - past.Final_WRS) / Math.abs(past.Final_WRS)) * 100;
                        curr.Final_WRS_10D_Chg = change;
                    } else {
                        curr.Final_WRS_10D_Chg = null;
                    }
                });

                // 5. Re-render UI to show new column
                updateUI();

            } catch (e) {
                console.error("Historical comparison failed:", e);
            }
        }

        // Refactored WRS Calculation to be reusable
        function calculateWRSForData(rawData) {
            const groups = {};
            rawData.forEach(item => {
                if (!item['Market Cap'] || item['Market Cap'] === 'N/A' || item['Market Cap'] === 'null') return;
                if (!item['Sector'] || item['Sector'] === 'N/A' || item['Sector'] === 'null' || item['Sector'] === 'nan') return;
                // ... (rest of logic similar to calculateWRS)
                // To avoid code duplication, I should refactor calculateWRS to use this.
                // But for now, let's implement a simplified version here or duplicate logic safely.
                // Logic must be IDENTICAL to `calculateWRS`.

                const key = `${item.Sector}|${item.Industry}`;
                if (!groups[key]) {
                    groups[key] = {
                        Sector: item.Sector,
                        Industry: item.Industry,
                        Count: 0,
                        TotalMC: 0,
                        WeightedSum6: 0,
                        RS_Values: [],
                        WinCount: 0
                    };
                }

                const mc = parseMarketCap(item['Market Cap']);
                const rs6 = item.RS_6mo || 0;

                if (mc > 0) {
                    groups[key].Count += 1;
                    groups[key].TotalMC += mc;
                    groups[key].WeightedSum6 += (mc * rs6);
                    groups[key].RS_Values.push(rs6);
                    if (rs6 > 0) groups[key].WinCount += 1;
                }
            });

            const result = {};
            Object.values(groups).forEach(g => {
                // Median
                const sortedRS = g.RS_Values.sort((a, b) => a - b);
                const mid = Math.floor(sortedRS.length / 2);
                const median = sortedRS.length % 2 === 0
                    ? (sortedRS[mid - 1] + sortedRS[mid]) / 2
                    : sortedRS[mid];

                const wrs6mo = g.TotalMC > 0 ? (g.WeightedSum6 / g.TotalMC) : 0;
                const winRate = g.Count > 0 ? (g.WinCount / g.Count) : 0;
                const winFactor = g.Count > 1 ? (1 - (1 / g.Count)) : 0;

                const finalWRS = (wrs6mo * 0.4) + (median * 0.4) + (winRate * winFactor * 0.2);

                result[`${g.Sector}|${g.Industry}`] = {
                    Final_WRS: finalWRS
                };
            });
            return result;
        }

        // --- Core Functions ---

        function showIndividualRS() {
            appState.mode = 'INDIVIDUAL';
            appState.drillDownKey = null;
            appState.sort = { key: 'RS_6mo', asc: false }; // Default sort

            document.getElementById('search-input').value = '';
            appState.filterText = '';
            updateUI();
        }

        function showWRS() {
            // If in Drilldown, this acts as "Back"
            if (appState.mode === 'DRILLDOWN') {
                appState.mode = 'WRS';
                appState.drillDownKey = null;
            } else {
                appState.mode = 'WRS';
            }

            // Generate data if needed
            if (groupedData.length === 0) calculateWRS();

            appState.sort = { key: 'Final_WRS', asc: false }; // Default sort

            document.getElementById('search-input').value = '';
            appState.filterText = '';
            updateUI();
        }

        function updateUI() {
            const subtitle = document.getElementById('mode-subtitle');
            const wrsBtn = document.getElementById('wrs-btn');
            const indivBtn = document.getElementById('indiv-btn');
            const resultCount = document.getElementById('result-count');

            if (!subtitle || !wrsBtn || !indivBtn) {
                console.error("Missing UI elements");
                return;
            }

            // 1. Update Subtitle & Button States
            if (appState.mode === 'INDIVIDUAL') {
                subtitle.innerText = "Individual RS";
                subtitle.style.color = "#2196f3"; // Blue

                // Active/Inactive Styling (Optional)
                indivBtn.style.opacity = '1';
                wrsBtn.innerText = "Sector/Industry WRS"; // Reset text (Fixed: removed .style)

            } else if (appState.mode === 'WRS') {
                subtitle.innerText = "Sector/Industry WRS";
                subtitle.style.color = "#ff5252"; // Red

                wrsBtn.innerText = "Sector/Industry WRS";

            } else if (appState.mode === 'DRILLDOWN') {
                subtitle.innerText = "Sector Detail View";
                subtitle.style.color = "#00e676";

                // Change WRS button to Back button
                wrsBtn.innerText = "Back to WRS List";

            } else if (appState.mode === 'TODAYS_LIST') {
                subtitle.innerText = "Today's List";
                subtitle.style.color = "#ff9800"; // Orange

                wrsBtn.innerText = "Sector/Industry WRS"; // Reset

            } else if (appState.mode === 'TODAYS_MAIN') {
                subtitle.innerText = "Today's Main";
                subtitle.style.color = "#e91e63"; // Pink

                wrsBtn.innerText = "Sector/Industry WRS"; // Reset

            } else if (appState.mode === 'TODAYS_TOP') {
                subtitle.innerText = "Today's Top (Best of Best)";
                subtitle.style.color = "#00bcd4"; // Cyan

                wrsBtn.innerText = "Sector/Industry WRS"; // Reset
            }

            // 2. Render Data
            const data = getFilteredAndSortedData();
            renderTable(data);

            if (resultCount) {
                resultCount.innerText = `Total: ${data.length} Items`;
            }

            // 3. Table Layout Adjustment (Compact center for WRS)
            const tableElement = document.querySelector('table');
            if (tableElement) {
                if (appState.mode === 'WRS') {
                    tableElement.style.width = 'auto'; // Shrink to fit
                    tableElement.style.margin = '0 auto'; // Center
                } else {
                    tableElement.style.width = '100%'; // Full width
                    tableElement.style.margin = '0';
                }
            }
        }

        function showTodaysList() {
            appState.mode = 'TODAYS_LIST';
            appState.filterText = '';
            document.getElementById('search-input').value = '';
            appState.sort = { key: 'RS_6mo', asc: false };

            // WRS 계산이 필요한 경우
            if (groupedData.length === 0) {
                calculateWRS();
            }

            updateUI();
        }

        function showTodayMain() {
            // Function needed but not part of original request, implementing `showTodaysMain` below
        }

        function showTodaysMain() {
            appState.mode = 'TODAYS_MAIN';
            appState.filterText = '';
            document.getElementById('search-input').value = '';
            appState.sort = { key: 'RS_6mo', asc: false };

            if (groupedData.length === 0) {
                calculateWRS();
            }

            updateUI();
        }

        function showTodaysTop() {
            appState.mode = 'TODAYS_TOP';
            appState.filterText = '';
            document.getElementById('search-input').value = '';
            appState.sort = { key: 'RS_6mo', asc: false };

            if (groupedData.length === 0) {
                calculateWRS();
            }

            updateUI();
        }

        function handleSearch() {
            const input = document.getElementById('search-input');
            appState.filterText = input.value.trim().toLowerCase();
            updateUI();
        }

        function calculateWRS() {
            const groups = {};

            globalData.forEach(item => {
                // [Strict Exclusion] Exclude items if MC, Sector, or Industry is invalid
                if (!item['Market Cap'] || item['Market Cap'] === 'N/A' || item['Market Cap'] === 'null') return;
                if (!item['Sector'] || item['Sector'] === 'N/A' || item['Sector'] === 'null' || item['Sector'] === 'nan') return;
                if (!item['Industry'] || item['Industry'] === 'N/A' || item['Industry'] === 'null' || item['Industry'] === 'nan') return;

                const key = `${item.Sector}|${item.Industry}`;
                if (!groups[key]) {
                    groups[key] = {
                        Sector: item.Sector,
                        Industry: item.Industry,
                        Count: 0,
                        TotalMC: 0,
                        WeightedSum6: 0,
                        WeightedSum3: 0,
                        WeightedSum1: 0,
                        RS_Values: [],  // For median calculation
                        WinCount: 0     // For Win-rate calculation
                    };
                }

                const mc = parseMarketCap(item['Market Cap']);
                // Use RS_6mo, RS_3mo, RS_1mo for Weighted RS
                const rs6 = item.RS_6mo || 0;
                const rs3 = item.RS_3mo || 0;
                const rs1 = item.RS_1mo || 0;

                if (mc > 0) {
                    groups[key].Count += 1;
                    groups[key].TotalMC += mc;
                    groups[key].WeightedSum6 += (mc * rs6);
                    groups[key].WeightedSum3 += (mc * rs3);
                    groups[key].WeightedSum1 += (mc * rs1);
                    groups[key].RS_Values.push(rs6);  // Collect for median

                    if (rs6 > 0) {
                        groups[key].WinCount += 1;
                    }
                }
            });

            groupedData = Object.values(groups).map(g => {
                // Calculate median
                const sortedRS = g.RS_Values.sort((a, b) => a - b);
                const mid = Math.floor(sortedRS.length / 2);
                const median = sortedRS.length % 2 === 0
                    ? (sortedRS[mid - 1] + sortedRS[mid]) / 2
                    : sortedRS[mid];

                const wrs6mo = g.TotalMC > 0 ? (g.WeightedSum6 / g.TotalMC) : 0;
                const winRate = g.Count > 0 ? (g.WinCount / g.Count) : 0; // 0.0 ~ 1.0

                // Final WRS 공식: WRS(6MO)×40% + WRS_MD(6MO)×40% + Win-rate×(1-(1/total count))×20%
                // Win-rate part needs to be scaled? Request says: Win-rate = (Count > 0) / Total Count
                // "단위는 %이고 소수점 둘째자리까지 표시한다." -> Display only.
                // Formula uses Win-rate as decimal? Or percentage?
                // Example: Win-rate = 71.42% = 0.7142
                // Example Calc: 2.7405*0.4 + 0.2661*0.4 + 0.7142*(1-1/7)*0.2
                // So Win-rate is used as a decimal (0.7142) but logic probably implies the raw value before % formatting.
                // Re-reading logic: "0.7142×(1-1/7)×20%" -> Yes, decimal.

                const winFactor = g.Count > 1 ? (1 - (1 / g.Count)) : 0; // Avoid division by zero issues or single item? Logic says 1-1/count. If count=1, 1-1=0.

                // WRS_MD(6MO) is `median`

                // Final WRS
                const finalWRS = (wrs6mo * 0.4) + (median * 0.4) + (winRate * winFactor * 0.2);
                // Wait, example: 0.7142... 
                // Let's re-read the example carefully.
                // "Computer Hardware의 Final WRS는 = 1.0962 + 0.1064 + 0.6122×20% = 1.3250"
                // 0.6122 comes from 0.7142 * (6/7) = 0.61217...
                // 0.6122 * 0.2 = 0.12244...
                // 1.0962 + 0.1064 + 0.1224 = 1.325
                // The term "0.6122" is "Win-rate * (1 - 1/Count)".
                // Wait, WRS values are usually around 0~10 or -10~10?
                // Example WRS(6MO) = 2.7405. 
                // Example WRS_MD(6MO) = 0.2661.
                // Win-rate = 0.7142 (71.42%).
                // If I just add them: 2.74*0.4 + 0.26*0.4 + 0.71*...*0.2?
                // Let's check magnitude.
                // 2.74 * 0.4 = 1.096. Correct.
                // 0.26 * 0.4 = 0.106. Correct.
                // 0.7142 * (6/7) * 0.2 = 0.6122 * 0.2 = 0.1224.
                // Sum = 1.096 + 0.106 + 0.122 = 1.324.
                // The user example says "= 2.7405×40% + 0.2661×40% + 0.7142×(1-1/7)×20%"
                // AND THEN "= 1.0962 + 0.1064 + 0.6122×20%"
                // The last term "0.6122 * 20%" suggests 0.12244.
                // It seems Win-rate should be treated as 0.xx (decimal).
                // However, RS values can be large (e.g. 20, 30). Win rate is 0-1.
                // Is there a scaling factor?
                // "Win-rate 단위는 %이고" -> 71.42. If used as 71.42:
                // 71.42 * (6/7) * 0.2 = 61.21 * 0.2 = 12.24.
                // This would dominate the score (1.0 vs 12.24).
                // So likely it is used as decimal (0.7142).
                // The User Example: 
                // = 1.0962 + 0.1064 + 0.6122×20%
                // 0.6122 is (5/7) * (6/7) ? No. Win-rate is 5/7 = 0.7142.
                // 0.7142 * (1 - 1/7) = 0.7142 * 0.8571 = 0.61217... matches 0.6122.
                // So the 3rd term is 0.6122 * 20% = 0.1224.
                // Total = 1.3250.
                // So yes, Win-rate is used as a decimal (0.0 to 1.0) in the calculation.

                // BUT wait, is RS typically percentage? "RS(6mo): (개별종목 기간 수익률) - (QQQ 기간 수익률)".
                // If a stock is up 50% and QQQ is up 10%, RS is 40? or 0.40?
                // If RS is 2.74 (as in example), that sounds like 2.74%? Or factor?
                // Usually RS is relative strength index 0-100 or a percentage difference.
                // If RS_6mo is 2.74, and WRS_MD is 0.26.
                // These are small numbers. Maybe they are percentages like 2.74%?
                // If so, 0.71 (71%) is comparable?
                // actually 2.74% is 0.0274. 
                // If RS is raw percentage (e.g. 2.74 means 2.74%), then Win-rate (0.71) is huge (71%).
                // If RS is just a number (e.g. 2.74), and Win Rate is 0.71.
                // Let's assume the example is the ground truth.
                // Win Rate part contributes ~0.12 to the score.
                // WRS part contributes ~1.1 to the score.
                // So Win Rate is a minor booster. This makes sense.

                return {
                    Sector: g.Sector,
                    Industry: g.Industry,
                    Count: g.Count,
                    WRS_6mo: wrs6mo,
                    WRS_3mo: g.TotalMC > 0 ? (g.WeightedSum3 / g.TotalMC) : 0,
                    WRS_1mo: g.TotalMC > 0 ? (g.WeightedSum1 / g.TotalMC) : 0,
                    WRS_6mo_MD: median,  // Median
                    Win_Rate: winRate,
                    Final_WRS: finalWRS,
                    TotalMC: g.TotalMC
                };
            });

            // Calculate percentiles for WRS
            const wrs6moValues = groupedData.map(d => d.WRS_6mo);
            const wrsMDValues = groupedData.map(d => d.WRS_6mo_MD);
            const finalWRSValues = groupedData.map(d => d.Final_WRS); // [Added]

            groupedData.forEach(item => {
                item.WRS_Rank_Pct = calculatePercentileRank(item.WRS_6mo, wrs6moValues);
                item.WRS_MD_Rank_Pct = calculatePercentileRank(item.WRS_6mo_MD, wrsMDValues);
                item.Final_WRS_Rank_Pct = calculatePercentileRank(item.Final_WRS, finalWRSValues); // [Added]
            });
        }

        // Helper function for percentile calculation
        function calculatePercentileRank(value, allValues) {
            if (value === null || value === undefined) return null;
            const sorted = allValues.filter(v => v !== null && v !== undefined).sort((a, b) => b - a);
            if (sorted.length === 0) return null;
            const rank = sorted.indexOf(value) + 1;
            return parseFloat(((rank / sorted.length) * 100).toFixed(2));
        }

        function getFilteredAndSortedData() {
            let targetData = [];

            if (appState.mode === 'INDIVIDUAL') {
                targetData = globalData;
            } else if (appState.mode === 'WRS') {
                targetData = groupedData;
            } else if (appState.mode === 'DRILLDOWN') {
                const [sec, ind] = appState.drillDownKey.split('|');
                targetData = globalData.filter(d => d.Sector === sec && d.Industry === ind);
            } else if (appState.mode === 'TODAYS_LIST') {
                // Today's List 필터링 로직
                // (A) 적격 섹터/산업 찾기
                const qualifiedSectors = groupedData.filter(wrs => {
                    return wrs.Count >= 2 &&                    // Count ≥ 2
                        wrs.WRS_Rank_Pct <= 20 &&            // WRS rank ≤ 20% (상위 20%)
                        wrs.WRS_MD_Rank_Pct <= 40;           // WRS_MD rank ≤ 40%
                });

                // (B) 적격 섹터에 속하는 종목 중 RS rank ≤ 30% 인 종목들
                const qualifiedKeys = new Set(
                    qualifiedSectors.map(s => `${s.Sector}|${s.Industry}`)
                );

                targetData = globalData.filter(stock => {
                    const key = `${stock.Sector}|${stock.Industry}`;
                    return qualifiedKeys.has(key) &&
                        stock.RS_Rank_Pct !== null &&
                        stock.RS_Rank_Pct <= 30 &&  // RS rank ≤ 30% (상위 30%)
                        stock['50DIV'] > 0;         // 50DIV > 0 (New Condition)
                });
            } else if (appState.mode === 'TODAYS_MAIN') {
                // Today's Main 필터링 (Today's List + Trend>=5% + 50DIV<=55%)
                // 1. 적격 섹터 (Today's List와 동일)
                const qualifiedSectors = groupedData.filter(wrs => {
                    return wrs.Count >= 2 &&
                        wrs.WRS_Rank_Pct <= 20 &&
                        wrs.WRS_MD_Rank_Pct <= 40;
                });

                const qualifiedKeys = new Set(
                    qualifiedSectors.map(s => `${s.Sector}|${s.Industry}`)
                );

                targetData = globalData.filter(stock => {
                    const key = `${stock.Sector}|${stock.Industry}`;

                    // 기본 Today's List 조건
                    const basicCondition = qualifiedKeys.has(key) &&
                        stock.RS_Rank_Pct !== null &&
                        stock.RS_Rank_Pct <= 30 &&
                        stock['50DIV'] > 0;

                    // 추가 조건: CY_Trend >= 0.05, NY_Trend >= 0.05, 50DIV <= 55
                    const extraCondition = (stock.CY_Trend >= 0.05) &&
                        (stock.NY_Trend >= 0.05) &&
                        (stock['50DIV'] <= 55);

                    return basicCondition && extraCondition;
                });
            } else if (appState.mode === 'TODAYS_TOP') {
                // Today's Top 필터링 (Today's List + Order=YES + Trend>=5%)
                // 1. 적격 섹터 (Today's List와 동일)
                const qualifiedSectors = groupedData.filter(wrs => {
                    return wrs.Count >= 2 &&
                        wrs.WRS_Rank_Pct <= 20 &&
                        wrs.WRS_MD_Rank_Pct <= 40;
                });

                const qualifiedKeys = new Set(
                    qualifiedSectors.map(s => `${s.Sector}|${s.Industry}`)
                );

                targetData = globalData.filter(stock => {
                    const key = `${stock.Sector}|${stock.Industry}`;

                    // 기본 Today's List 조건
                    const basicCondition = qualifiedKeys.has(key) &&
                        stock.RS_Rank_Pct !== null &&
                        stock.RS_Rank_Pct <= 30 &&
                        stock['50DIV'] > 0;

                    // 추가 조건: Order=YES, CY_Trend >= 0.05, NY_Trend >= 0.05
                    const extraCondition = (stock.Order === 'YES') &&
                        (stock.CY_Trend >= 0.05) &&
                        (stock.NY_Trend >= 0.05);

                    return basicCondition && extraCondition;
                });
            }

            // 1. Filter
            if (appState.filterText) {
                targetData = targetData.filter(item => {
                    return Object.values(item).some(val =>
                        String(val).toLowerCase().includes(appState.filterText)
                    );
                });
            }

            // 2. Sort
            targetData.sort((a, b) => {
                let valA = a[appState.sort.key];
                let valB = b[appState.sort.key];

                if (appState.sort.key === 'Market Cap') {
                    valA = parseMarketCap(valA);
                    valB = parseMarketCap(valB);
                }

                if (typeof valA === 'string') valA = valA.toUpperCase();
                if (typeof valB === 'string') valB = valB.toUpperCase();

                if (valA < valB) return appState.sort.asc ? -1 : 1;
                if (valA > valB) return appState.sort.asc ? 1 : -1;
                return 0;
            });

            return targetData;
        }

        function parseMarketCap(mcStr) {
            if (!mcStr || mcStr === 'N/A') return 0;
            if (typeof mcStr === 'number') return mcStr;
            let val = parseFloat(mcStr.replace(/[^0-9.-]/g, ''));
            if (mcStr.includes('B')) val *= 1_000_000_000;
            if (mcStr.includes('M')) val *= 1_000_000;
            if (mcStr.includes('T')) val *= 1_000_000_000_000;
            return val;
        }

        function renderTable(data) {
            const thead = document.querySelector('table thead tr');
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            if (appState.mode === 'WRS') {
                thead.innerHTML = `
                    <th onclick="sortTable('Sector')" style="text-align: center;">Sector ⬍</th>
                    <th onclick="sortTable('Industry')" style="text-align: center;">Industry ⬍</th>
                    <th onclick="sortTable('Final_WRS')" style="text-align: center;">Final WRS ⬍</th>
                    <th onclick="sortTable('Final_WRS_Rank_Pct')" style="text-align: center;">Final Rank (%) ⬍</th>
                    <th onclick="sortTable('Final_WRS_10D_Chg')" style="text-align: center;">10D Chg (%) ⬍</th>
                    <th onclick="sortTable('Count')" style="text-align: center;">Total Count ⬍</th>
                    <th onclick="sortTable('WRS_6mo')" style="text-align: center;">WRS (6mo) ⬍</th>
                    <th onclick="sortTable('WRS_Rank_Pct')" style="text-align: center;">WRS Rank (%) ⬍</th>
                    <th onclick="sortTable('WRS_6mo_MD')" style="text-align: center;">WRS_MD (6mo) ⬍</th>
                    <th onclick="sortTable('WRS_MD_Rank_Pct')" style="text-align: center;">WRS_MD Rank (%) ⬍</th>
                    <th onclick="sortTable('Win_Rate')" style="text-align: center;">Win-rate (%) ⬍</th>
                    <th onclick="sortTable('WRS_3mo')" style="text-align: center;">WRS (3mo) ⬍</th>
                    <th onclick="sortTable('WRS_1mo')" style="text-align: center;">WRS (1mo) ⬍</th>
                `;
            } else {
                thead.innerHTML = `
                    <th onclick="sortTable('Ticker')">Ticker ⬍</th>
                    <th onclick="sortTable('Sector')">Sector ⬍</th>
                    <th onclick="sortTable('Industry')">Industry ⬍</th>
                    <th onclick="sortTable('Price')">Price ($) ⬍</th>
                    <th onclick="sortTable('Market Cap')">Market Cap ($) ⬍</th>
                    <th onclick="sortTable('MarketCapRank')">MC Rank ⬍</th>
                    <th onclick="sortTable('RS_6mo')">RS (6mo) ⬍</th>
                    <th onclick="sortTable('RS_Rank_Pct')">RS Rank (%) ⬍</th>
                    <th onclick="sortTable('RS_3mo')">RS (3mo) ⬍</th>
                    <th onclick="sortTable('RS_1mo')">RS (1mo) ⬍</th>
                    <th onclick="sortTable('50DIV')">50DIV (%) ⬍</th>
                    <th onclick="sortTable('CY_Trend')">CY Trend (%) ⬍</th>
                    <th onclick="sortTable('NY_Trend')">NY Trend (%) ⬍</th>
                    <th onclick="sortTable('Up_Count')">Up # ⬍</th>
                    <th onclick="sortTable('Down_Count')">Down # ⬍</th>
                    <th onclick="sortTable('Up_Down_Ratio')">Up/(Up+Down) ⬍</th>

                `;
            }

            // Rank Calc for Individual/Drilldown
            if (appState.mode !== 'WRS') {
                const sortedRef = [...data].sort((a, b) => parseMarketCap(b['Market Cap']) - parseMarketCap(a['Market Cap']));
                const rankMap = {};
                sortedRef.forEach((item, idx) => rankMap[item.Ticker] = idx + 1);
                data.forEach(item => item.MarketCapRank = rankMap[item.Ticker]);
            }

            data.forEach(item => {
                const tr = document.createElement('tr');

                if (appState.mode === 'WRS') {
                    tr.style.cursor = 'pointer';
                    // [Change] Double click -> Single click
                    tr.onclick = () => enterDrillDown(item.Sector, item.Industry);
                    tr.title = "Click to see details";

                    const wrsRankDisplay = item.WRS_Rank_Pct !== null && item.WRS_Rank_Pct !== undefined
                        ? `${item.WRS_Rank_Pct.toFixed(2)}%`
                        : 'N/A';
                    const wrsMDRankDisplay = item.WRS_MD_Rank_Pct !== null && item.WRS_MD_Rank_Pct !== undefined
                        ? `${item.WRS_MD_Rank_Pct.toFixed(2)}%`
                        : 'N/A';

                    tr.innerHTML = `
                        <td style="text-align: center; white-space: nowrap;">${item.Sector}</td>
                        <td style="text-align: center; white-space: nowrap;">${item.Industry}</td>
                        <td style="text-align: center; font-weight: bold;">${item.Final_WRS ? item.Final_WRS.toFixed(4) : '0.0000'}</td>
                        <td style="text-align: center;">${item.Final_WRS_Rank_Pct ? item.Final_WRS_Rank_Pct.toFixed(2) + '%' : 'N/A'}</td>
                        <td style="text-align: center; font-weight: bold; color: ${item.Final_WRS_10D_Chg > 0 ? '#00e676' : (item.Final_WRS_10D_Chg < 0 ? '#ff5252' : 'inherit')}">
                            ${item.Final_WRS_10D_Chg !== undefined && item.Final_WRS_10D_Chg !== null ? (item.Final_WRS_10D_Chg > 0 ? '+' : '') + item.Final_WRS_10D_Chg.toFixed(2) + '%' : '-'}
                        </td>
                        <td style="text-align: center;">${item.Count}</td>
                        <td class="${item.WRS_6mo > 0 ? 'rs-pos' : 'rs-neg'}" style="text-align: center;">${item.WRS_6mo.toFixed(4)}</td>
                        <td style="text-align: center;">${wrsRankDisplay}</td>
                        <td class="${item.WRS_6mo_MD > 0 ? 'rs-pos' : 'rs-neg'}" style="text-align: center;">${item.WRS_6mo_MD.toFixed(4)}</td>
                        <td style="text-align: center;">${wrsMDRankDisplay}</td>
                        <td style="text-align: center;">${(item.Win_Rate * 100).toFixed(2)}%</td>
                        <td class="${item.WRS_3mo > 0 ? 'rs-pos' : 'rs-neg'}" style="text-align: center;">${item.WRS_3mo.toFixed(4)}</td>
                        <td class="${item.WRS_1mo > 0 ? 'rs-pos' : 'rs-neg'}" style="text-align: center;">${item.WRS_1mo.toFixed(4)}</td>
                    `;
                } else {
                    let mcDisplay = item['Market Cap'];
                    if (typeof mcDisplay === 'number') mcDisplay = '$' + mcDisplay.toLocaleString();

                    // [Change] Ticker Link
                    const tickerLink = `<a href="https://finance.yahoo.com/quote/${item.Ticker}/" target="_blank" style="color: inherit; text-decoration: underline;">${item.Ticker}</a>`;

                    // RS Rank Pct Display
                    const rsRankDisplay = item.RS_Rank_Pct !== null && item.RS_Rank_Pct !== undefined
                        ? `${Number(item.RS_Rank_Pct).toFixed(2)}%`
                        : 'N/A';

                    // 50DIV Display
                    const div50Display = item['50DIV'] !== null && item['50DIV'] !== undefined
                        ? (item['50DIV'] > 0 ? `+${item['50DIV'].toFixed(2)}%` : `${item['50DIV'].toFixed(2)}%`)
                        : 'N/A';
                    const div50Class = item['50DIV'] > 0 ? 'rs-pos' : (item['50DIV'] < 0 ? 'rs-neg' : '');

                    // RS Estimate Displays
                    const cyTrendDisplay = item.CY_Trend !== null && item.CY_Trend !== undefined ? `${item.CY_Trend.toFixed(2)}%` : 'N/A';
                    const cyTrendClass = item.CY_Trend > 0 ? 'rs-pos' : (item.CY_Trend < 0 ? 'rs-neg' : '');

                    const nyTrendDisplay = item.NY_Trend !== null && item.NY_Trend !== undefined ? `${item.NY_Trend.toFixed(2)}%` : 'N/A';
                    const nyTrendClass = item.NY_Trend > 0 ? 'rs-pos' : (item.NY_Trend < 0 ? 'rs-neg' : '');

                    const upCountDisplay = item.Up_Count !== null ? item.Up_Count : '-';
                    const downCountDisplay = item.Down_Count !== null ? item.Down_Count : '-';
                    const upDownRatioDisplay = item.Up_Down_Ratio !== null && item.Up_Down_Ratio !== undefined ? `${item.Up_Down_Ratio.toFixed(2)}%` : '-';


                    tr.innerHTML = `
                        <td><strong>${tickerLink}</strong></td>
                        <td style="white-space: nowrap;">${item.Sector}</td>
                        <td style="white-space: nowrap;">${item.Industry}</td>
                        <td>$${Number(item.Price).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        <td>${mcDisplay}</td>
                        <td>${item.MarketCapRank}</td>
                        <td class="${item.RS_6mo > 0 ? 'rs-pos' : 'rs-neg'}">${Number(item.RS_6mo).toFixed(4)}</td>
                        <td>${rsRankDisplay}</td>
                        <td class="${item.RS_3mo > 0 ? 'rs-pos' : 'rs-neg'}">${Number(item.RS_3mo).toFixed(4)}</td>
                        <td class="${item.RS_1mo > 0 ? 'rs-pos' : 'rs-neg'}">${Number(item.RS_1mo).toFixed(4)}</td>
                        <td class="${div50Class}">${div50Display}</td>
                        <td class="${cyTrendClass}">${cyTrendDisplay}</td>
                        <td class="${nyTrendClass}">${nyTrendDisplay}</td>
                        <td>${upCountDisplay}</td>
                        <td>${downCountDisplay}</td>
                        <td>${upDownRatioDisplay}</td>

                    `;
                }
                tbody.appendChild(tr);
            });
        }

        function enterDrillDown(sector, industry) {
            appState.mode = 'DRILLDOWN';
            appState.drillDownKey = `${sector}|${industry}`;
            appState.filterText = '';
            document.getElementById('search-input').value = '';
            // Reset to RS sort for drilldown
            appState.sort = { key: 'RS_6mo', asc: false };
            updateUI();
        }

        function sortTable(key) {
            if (appState.sort.key === key) appState.sort.asc = !appState.sort.asc;
            else { appState.sort.key = key; appState.sort.asc = true; }
            updateUI();
        }

        function downloadExcel() {
            const data = getFilteredAndSortedData();
            if (data.length === 0) return alert('데이터가 없습니다.');

            const wb = XLSX.utils.book_new();
            let excelData = [];
            let fileName = "";

            if (appState.mode === 'WRS') {
                excelData = data.map(item => ({
                    Ticker: item.Ticker,
                    Sector: item.Sector,
                    Industry: item.Industry,
                    Price: item.Price,
                    Order: item.Order,
                    RS_1mo: item.RS_1mo,
                    WRS_3mo: item.WRS_3mo,
                    WRS_1mo: item.WRS_1mo
                }));
                fileName = `WRS_Score_${new Date().toISOString().slice(0, 10)}.xlsx`;
            } else {
                excelData = data.map(item => ({
                    Ticker: item.Ticker,
                    Price: item.Price,
                    MarketCap: parseMarketCap(item['Market Cap']),
                    MarketCapRank: item.MarketCapRank,
                    RS_6mo: item.RS_6mo,
                    RS_3mo: item.RS_3mo,
                    RS_1mo: item.RS_1mo,
                    '50DIV': item['50DIV'],
                    CY_Trend: item.CY_Trend,
                    NY_Trend: item.NY_Trend,
                    Up_Count: item.Up_Count,
                    Down_Count: item.Down_Count,
                    Up_Down_Ratio: item.Up_Down_Ratio,
                    Sector: item.Sector,
                    Industry: item.Industry
                }));
                const prefix = appState.mode === 'DRILLDOWN' ? 'Sector_Detail_' : 'RS_Investment_';
                fileName = `${prefix}${new Date().toISOString().slice(0, 10)}.xlsx`;
            }

            const ws = XLSX.utils.json_to_sheet(excelData);
            XLSX.utils.book_append_sheet(wb, ws, "Data");
            XLSX.writeFile(wb, fileName);
        }
    </script>
</body>

</html>