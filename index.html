<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Timeframe RS Investment (v1.3)</title>
    <link rel="shortcut icon" href="static/favicon.png">
    <style>
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --primary-color: #00e676;
            --text-color: #ffffff;
            --text-secondary: #b0b0b0;
            --danger-color: #ff5252;
            --border-color: #333;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 95%;
            max-width: 1600px;
            /* Wider for more columns */
            margin-top: 40px;
            text-align: center;
            flex-grow: 1;
        }

        h1 {
            margin-bottom: 20px;
        }

        .subtitle {
            color: #888;
            font-size: 14px;
            margin-bottom: 30px;
        }

        .info-box {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: left;
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        button {
            background-color: var(--primary-color);
            color: #000;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            transition: 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        /* Filter Popup */
        .filter-popup {
            position: absolute;
            background-color: #333;
            border: 1px solid #555;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            display: none;
            min-width: 120px;
            text-align: left;
        }

        .filter-popup label {
            display: block;
            margin-bottom: 5px;
            cursor: pointer;
            color: #eee;
            font-size: 13px;
        }

        .filter-popup button {
            margin-top: 5px;
            padding: 5px 10px;
            font-size: 12px;
            width: 100%;
            background-color: var(--primary-color);
            color: #000;
        }

        #result-area {
            display: none;
            margin-top: 40px;
        }

        .btn-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .download-btn {
            background-color: #333;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 4px;
            font-size: 14px;
            transition: 0.2s;
            cursor: pointer;
        }

        .download-btn:hover {
            background-color: #555;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--surface-color);
            font-size: 13px;
        }

        th,
        td {
            text-align: left;
            padding: 8px 12px;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            cursor: pointer;
            user-select: none;
            background-color: #252525;
            color: var(--text-secondary);
            position: sticky;
            top: 0;
            white-space: nowrap;
        }

        th:hover {
            background-color: #333;
        }

        .rs-pos {
            color: #00e676;
        }

        .rs-neg {
            color: #ff5252;
        }

        footer {
            width: 100%;
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 12px;
            border-top: 1px solid var(--border-color);
            margin-top: 50px;
            padding-bottom: 30px;
        }

        /* Market Popup Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal-content {
            background-color: #1e1e1e;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 900px;
            color: #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }

        /* Matrix Table Styles */
        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 14px;
        }

        .matrix-table th,
        .matrix-table td {
            border: 1px solid #444;
            padding: 8px;
            text-align: left;
        }

        .matrix-table th {
            background-color: #333;
            color: #eee;
        }

        .matrix-table tr:nth-child(mm) {
            background-color: #252525;
        }

        .trend-up {
            color: #ff5252;
            font-weight: bold;
        }

        /* Red for Up in KR stock context usually, but let's stick to user image context if colored. Image text is black. Let's use standard text color but bold for direction. */
        .trend-down {
            color: #00e676;
            font-weight: bold;
        }

        /* Green for Down */
        .trend-flat {
            color: #ffca28;
            font-weight: bold;
        }

        /* Yellow for Flat */

        .action-highlight {
            color: #ffd700;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1 id="page-title" style="margin-bottom:5px;">US Market Multi-Timeframe RS Investment (v1.1)</h1>

        <h2 id="mode-subtitle" style="margin-top:0; margin-bottom:10px; font-size:24px; min-height:30px;"></h2>

        <p class="subtitle" id="last-updated" style="margin-bottom:15px;">업데이트 확인 중...</p>
        <p id="history-debug" style="font-size: 12px; color: #ff9800; display: none;"></p>

        <!-- 날짜 선택 드롭다운 -->
        <div style="margin-bottom:30px;">
            <label for="date-selector" style="color: #aaa; margin-right: 10px; font-size: 14px;">
                📅 데이터 날짜:
            </label>
            <select id="date-selector" style="
                background-color: #2a2a2a;
                color: #fff;
                border: 1px solid #444;
                padding: 8px 15px;
                border-radius: 5px;
                font-size: 14px;
                cursor: pointer;
                min-width: 150px;
            ">
                <option value="static/result.json">Latest</option>
            </select>

            <!-- Market Judgment Link -->
            <a href="#" onclick="openMarketPopup(); return false;"
                style="color: #ff5252; text-decoration: underline; font-size: 16px; font-weight: bold; margin-left: 20px;">
                📢 시장판단(필독)
            </a>

            <!-- Investment Method Link -->
            <a href="#" onclick="openInvestPopup(); return false;"
                style="color: #ff9800; text-decoration: underline; font-size: 16px; font-weight: bold; margin-left: 15px;">
                💰 투자방법(약식)
            </a>
        </div>

        <div class="info-box">
            <h3 onclick="toggleDescription()"
                style="cursor: pointer; margin: 0; padding: 10px; background-color: #333; border-radius: 5px; display: flex; justify-content: space-between; align-items: center;">
                <span>📝 컬럼 등에 대한 설명 (Click to Open/Close)</span>
                <span id="desc-arrow">▼</span>
            </h3>
            <div id="description-content"
                style="display: none; margin-top: 10px; padding: 10px; background-color: #222; border-radius: 5px;">
                <ul>
                    <li><strong>일일 자동 업데이트</strong>: 매일 미국 장 마감 후 서버가 자동으로 데이터를 갱신합니다. (매일 UTC 21:00 / 한국 시간 오전 6:00)
                    </li>
                    <li><strong>RS Logic</strong>: (개별종목 기간 수익률) - (QQQ 기간 수익률)
                        <ul>
                            <li><strong>RS(6mo)</strong>: 120영업일, <strong>RS(3mo)</strong>: 60영업일,
                                <strong>RS(1mo)</strong>:
                                20영업일
                            </li>
                            <li>양수(+)면 벤치마크(QQQ) 대비 초과 수익, 음수(-)면 저조한 성과를 의미합니다.</li>
                        </ul>
                    </li>
                    <li><strong>시가총액</strong>: 주가 × 발행주식수 (기업의 총 시장 가치)</li>
                    <li><strong>WRS (Weighted Relative Strength):</strong> 섹터/산업 내 종목들의 시가총액 가중 평균 RS (섹터/산업의 주도력)</li>
                    <li><strong>WRS_MD:</strong> 섹터/산업 내 종목들의 RS(6mo) 중앙값 (Median)</li>
                    <li><strong>Win-rate:</strong> (해당 Sector/Industry 내 RS(6mo) > 0 인 Ticker 수) / Total Count (단위: %)
                    </li>
                    <li><strong>Final WRS:</strong> 종합 점수 = WRS(6MO)×40% + WRS_MD(6MO)×40% + Win-rate×(1-(1/Total
                        Count))×20%</li>
                    <li><strong>10D Chg (%):</strong> WRS 및 개별 종목 RS(6mo)의 10거래일 전 대비 변화율</li>
                    <li><strong>RS_DiF / WRS_Dif:</strong> (1개월 RS) - (3개월 RS) - (6개월 RS) (단기 모멘텀이 장기보다 강한지 확인)</li>
                    <li><strong>50DIV(%):</strong> 현재 주가와 50일 이동평균선의 괴리율 (높을수록 과열)</li>
                    <li><strong>10DIV(%):</strong> 현재 주가와 10일 이동평균선의 괴리율 (단기 이격도)</li>
                    <li><strong>중장기정배열:</strong> 최근 20, 60, 120 영업일 종가 이동평균선이 정배열(20&gt;60&gt;120) 상태인지 여부 (YES/NO)</li>

                    <li><strong>EPS Trend:</strong> 시장 전문가들의 EPS(주당순이익) 예상치 30일전 대비 변화율 (CY:올해, NY:내년, CY와 NY 모두 5% 이상일
                        경우
                        장기 주도주가 될 가능성이 매우 높음)</li>
                    <li><strong>Up/Down #:</strong> 최근 30일간 EPS 추정치를 상향(Up)/하향(Down) 조정한 애널리스트 수</li>
                    <li><strong>Up/Down Ratio:</strong> 상향 조정 비율 (높을수록 실적 전망 긍정적)</li>
                    <li><strong>Today's List 기준:</strong>
                        <ul>
                            <li><strong>섹터/산업:</strong> Total Count 2개 이상, Win-rate 60% 이상, Final WRS(종합 점수) 상위 30%</li>
                            <li><strong>종목:</strong> 선정된 섹터/산업 내 RS(6mo) 상위 30% 이내 & <strong>50DIV &gt; 0</strong></li>
                        </ul>
                    </li>
                    <li><strong>Today's Main 기준:</strong>
                        <ul>
                            <li><strong>Today's List</strong> 조건을 만족하는 종목 중</li>
                            <li><strong>CY Trend & NY Trend</strong> 모두 5% 이상</li>
                            <li><strong>50DIV</strong> 55% 이하 (과열 방지)</li>
                        </ul>
                    </li>
                    <li><strong>급등/반등가능성↑종목:</strong> RS_DiF &gt; 0 이며, CY Trend 및 NY Trend가 모두 양수인 종목 (NY Trend 순 정렬)
                    </li>
                    <li><strong>급등/반등가능성↑섹터:</strong> WRS_Dif &gt; 0 인 섹터 (Win-rate 순 정렬)</li>
                    <li><strong>BBWTHD:</strong> 볼린저 밴드 너비(Bandwidth). (상단밴드 - 하단밴드) / 중심선(20일SMA)</li>
                    <li><strong>BBWTHD LOW:</strong> 해당 종목의 최근 60영업일 간 BBWTHD 최저값</li>
                </ul>
            </div>
        </div>



        <!-- ... -->

        <!-- Loading Message -->
        <div id="loading-msg" style="text-align: center; padding: 50px; font-size: 18px; color: var(--primary-color);">
            ⏳ 데이터 불러오는 중...
        </div>

        <div id="result-area">
            <div class="btn-group">
                <span id="result-count" style="font-size:14px; color:#aaa;"></span>

                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="text" id="search-input" placeholder="Search..."
                        style="padding:10px; border-radius:4px; border:1px solid #333; background:#222; color:#fff;">

                    <button id="indiv-btn" onclick="showIndividualRS()" class="download-btn"
                        style="background-color:#2196f3; color:#ffffff;">
                        Individual RS
                    </button>



                    <button id="wrs-btn" onclick="showWRS()" class="download-btn"
                        style="background-color:#00e676; color:#000;">
                        Sector/Industry WRS
                    </button>

                    <button id="todays-list-btn" onclick="showTodaysList()" class="download-btn"
                        style="background-color:#ff9800; color:#000;">
                        Today's List
                    </button>

                    <button id="todays-main-btn" onclick="showTodaysMain()" class="download-btn"
                        style="background-color:#e91e63; color:#ffffff;">
                        Today's Main
                    </button>

                    <!-- Rising Links (Text style buttons) -->
                    <a href="#" onclick="showRisingStocks(); return false;"
                        style="color: #ffca28; text-decoration: none; font-size: 14px; font-weight: bold; margin-left: 10px;">
                        ⚡급등/반등가능성↑종목
                    </a>
                    <a href="#" onclick="showRisingSectors(); return false;"
                        style="color: #ffca28; text-decoration: none; font-size: 14px; font-weight: bold;">
                        ⚡급등/반등가능성↑섹터
                    </a>

                    <!-- [Added] Energy Filter Button -->
                    <a href="#" id="energy-filter-btn" onclick="toggleEnergyFilter(); return false;"
                        style="color: #FFD700; text-decoration: none; font-size: 14px; font-weight: bold; margin-left: 10px;">
                        ⚡에너지응축하는놈
                    </a>

                    <button onclick="downloadExcel()" class="download-btn">📥 엑셀 다운로드</button>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th onclick="sortTable('Ticker')">Ticker ⬍</th>
                        <th onclick="sortTable('Sector')">Sector ⬍</th>
                        <th onclick="sortTable('Industry')">Industry ⬍</th>
                        <th onclick="sortTable('Price')">Price ($) ⬍</th>
                        <th onclick="sortTable('Market Cap')">Market Cap ($) ⬍</th>
                        <th onclick="sortTable('MarketCapRank')">MC Rank ⬍</th>

                        <th onclick="sortTable('RS_6mo')">RS (6mo) ⬍</th>
                        <th onclick="sortTable('RS_3mo')">RS (3mo) ⬍</th>
                        <th onclick="sortTable('RS_1mo')">RS (1mo) ⬍</th>
                    </tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>

    <footer>
        <p>RS Investment © 2026 | Idea & Built by In-kyu Lee</p>
        <div style="margin-top: 15px; font-size: 11px; color: #555; line-height: 1.5;">
            <strong>Disclaimer:</strong> Data provided by Yahoo Finance. This project is for <strong>personal
                educational purposes only</strong> and is <strong>not for commercial use</strong>.<br>
            All data is strictly for informational purposes and should not be considered financial advice.
        </div>
    </footer>

    <!-- Market Judgment Modal -->
    <div id="market-popup" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeMarketPopup()">&times;</span>
            <h2 style="margin-top:0;">시장 추세 판단 가이드</h2>

            <h3>1. 시장 장기 추세 판단(약식)</h3>
            <ul style="line-height: 1.6;">
                <li>(1) <strong>대세 상승</strong>: ARKK 월봉 10 우상향 (저점 2~3개 연결해서 판단)</li>
                <li>(2) <strong>대세 하락</strong>: ARKK 월봉 10 우하향 (고점 2~3개 연결해서 판단)</li>
                <li>(3) <strong>횡보(관망)</strong>: ARKK 월봉 10 횡보</li>
            </ul>

            <h3 style="margin-top:20px;">2. 시장 중기추세와 결합 판단(약식)</h3>
            <p>📊 <strong>월봉 10선 & 주봉 30선 조합별 대응 매트릭스</strong></p>

            <table class="matrix-table">
                <thead>
                    <tr>
                        <th>월봉 10선 (대세)</th>
                        <th>주봉 30선 (중기)</th>
                        <th>가격 위치</th>
                        <th>시장 해석 (국면)</th>
                        <th>대응 전략 (Action)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>상승 (↑)</td>
                        <td>상승 (↑)</td>
                        <td>가격 > 주봉</td>
                        <td><strong>최강의 제2단계</strong></td>
                        <td><span class="action-highlight">적극 매수 및 홀딩.</span> 비중을 최대화하여 수익 극대화.</td>
                    </tr>
                    <tr>
                        <td>상승 (↑)</td>
                        <td>상승 (↑)</td>
                        <td>가격 < 주봉</td>
                        <td>일시적 눌림목</td>
                        <td><strong>추가 매수 기회.</strong> 주봉 지지 확인 후 반등 시 진입.</td>
                    </tr>
                    <tr>
                        <td>상승 (↑)</td>
                        <td>횡보 (→)</td>
                        <td>주봉 부근</td>
                        <td>에너지 응축</td>
                        <td><strong>관심 종목 등록.</strong> 주봉 돌파 시점이 핵심 타점.</td>
                    </tr>
                    <tr>
                        <td>상승 (↑)</td>
                        <td>하락 (↓)</td>
                        <td>가격 < 주봉</td>
                        <td>깊은 조정 구간</td>
                        <td><strong>보수적 접근.</strong> 주봉 위로 안착 전까지 신규 매수 금지.</td>
                    </tr>
                    <tr>
                        <td>횡보 (→)</td>
                        <td>상승 (↑)</td>
                        <td>가격 > 주봉</td>
                        <td>바닥 탈출 (1→2)</td>
                        <td><strong>분할 매수 시작.</strong> 월봉 저항 돌파 시 비중 확대.</td>
                    </tr>
                    <tr>
                        <td>횡보 (→)</td>
                        <td>횡보 (→)</td>
                        <td>박스권</td>
                        <td>방향성 탐색</td>
                        <td><strong>관망.</strong> 에너지가 위로 터지는지 아래로 터지는지 대기.</td>
                    </tr>
                    <tr>
                        <td>횡보 (→)</td>
                        <td>하락 (↓)</td>
                        <td>가격 < 주봉</td>
                        <td>하락 전환 전조</td>
                        <td><strong>리스크 관리.</strong> 보유 비중을 줄이고 현금 확보.</td>
                    </tr>
                    <tr>
                        <td>하락 (↓)</td>
                        <td>상승 (↑)</td>
                        <td>가격 > 주봉</td>
                        <td>기술적 반등</td>
                        <td><strong>단기 매매만 허용.</strong> 월봉 저항이 강하므로 짧게 익절.</td>
                    </tr>
                    <tr>
                        <td>하락 (↓)</td>
                        <td>하락 (↓)</td>
                        <td>가격 < 주봉</td>
                        <td>공포의 제4단계</td>
                        <td><strong>전량 현금화.</strong> 어떤 반등도 매도 기회로 활용.</td>
                    </tr>
                </tbody>
            </table>
            <p style="font-size: 12px; color: #888; margin-top: 10px;">* 가격 위치 : 가격은 주봉 종가, 주봉은 주봉 30선을 말함</p>

            <h3 style="margin-top:20px;">3. 주봉 30선 기반 시장 판단 로직</h3>
            <p>📈 <strong>이 기준을 스캐너와 결합할 때 확인해야 할 3가지 체크포인트</strong></p>

            <table class="matrix-table">
                <thead>
                    <tr>
                        <th style="width: 35%;">상태</th>
                        <th style="width: 25%;">시장 해석</th>
                        <th>대응 전략</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>가격 > 주봉 30선 & 30선 우상향</strong></td>
                        <td style="color:#ff5252; font-weight:bold;">강력한 강세장 (Stage 2)</td>
                        <td>Today's List 종목 적극 매수 및 홀딩</td>
                    </tr>
                    <tr>
                        <td><strong>가격 < 주봉 30선 & 30선 우하향</strong>
                        </td>
                        <td style="color:#2196f3; font-weight:bold;">명확한 하락장 (Stage 4)</td>
                        <td>보수적 접근, 현금 비중 확대</td>
                    </tr>
                    <tr>
                        <td><strong>가격이 30선 부근에서 횡보</strong></td>
                        <td style="color:#ffca28; font-weight:bold;">전환기 (Stage 1 또는 3)</td>
                        <td>추세가 결정될 때까지 관망 혹은 비중 조절</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Investment Method Modal -->
    <div id="invest-popup" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeInvestPopup()">&times;</span>
            <h2 style="margin-top:0; color:#ff9800;">💰 투자방법 (약식)</h2>

            <div style="line-height: 1.8; font-size: 15px;">

                <h3 style="color:#2196f3; border-bottom:1px solid #444; padding-bottom:5px; margin-top:20px;">
                    1. RS_Dif가 양수인 종목들 [RS(6MO) > RS(3MO) > RS(1MO)]
                </h3>
                <ul style="list-style-type: disc; margin-left: 20px;">
                    <li><strong>Today’s list</strong> 또는 <strong>Today’s Main</strong> 내 종목들 중에서 <strong>눌림목(상승하다가 횡보)시
                            매수</strong></li>
                    <li>시장상황은 가급적 <strong>월봉 10 우상향</strong>할 때!</li>
                </ul>

                <h3 style="color:#f44336; border-bottom:1px solid #444; padding-bottom:5px; margin-top:20px;">
                    2. RS_Dif가 음수인 종목들 [RS(6MO) < RS(3MO) < RS(1MO)] </h3>
                        <ul style="list-style-type: disc; margin-left: 20px;">
                            <li><strong>급등/반등가능성↑종목</strong> 에 포함된 종목들 중에서:
                                <ul style="list-style-type: circle; margin-left: 20px; margin-top:5px;">
                                    <li style="margin-bottom:5px;">
                                        <strong>(1) 기관 매집</strong> (6개월간 횡보 + OBV 최소 3개월 상승)이 포착되고 이후 <strong>스퀴즈
                                            돌파</strong>한 종목
                                    </li>
                                    <li>
                                        <strong>(2) 회사는 매우 우량하나</strong> 회사가 포함된 섹터가 전반적으로 하락세를 보여 하락한 경우는 <strong>2파,
                                            4파, 5파 이후 조정파, 각 단계 조정파 돌파시 매수</strong><br>
                                        <span style="font-size:13px; color:#aaa;">* 사례 : 2026년 팔란티어 (소프트웨어 섹터에 포함되 회사는
                                            우량하나 포함된 섹터 때문에 하락)</span>
                                    </li>
                                </ul>
                            </li>
                        </ul>

                        <h3 style="color:#00e676; border-bottom:1px solid #444; padding-bottom:5px; margin-top:20px;">
                            3. 급등/반등가능성↑섹터 (ETF)
                        </h3>
                        <ul style="list-style-type: disc; margin-left: 20px;">
                            <li>해당 ETF를 찾아서 <strong>(1)~(3)에 해당될 경우 투자</strong></li>
                            <li style="margin-top:5px;">
                                <strong>(1) 상승 변화기1 (하락추세 끝):</strong><br>
                                장기선(200일선) > 단기선(5일선(한달)) > 중기선(75일(1분기))
                            </li>
                            <li style="margin-top:5px;">
                                <strong>(2) 상승 변화기2 (상승추세 시작):</strong><br>
                                단기선(5일선(한달)) > 장기선(200일선) > 중기선(75일(1분기))
                            </li>
                            <li style="margin-top:5px;">
                                <strong>(3) 상승 안정기:</strong><br>
                                단기선 > 중기선 > 장기선
                            </li>
                        </ul>

            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <script>
        // --- Invest Popup Functions ---
        function openInvestPopup() {
            document.getElementById('invest-popup').style.display = 'block';
        }

        function closeInvestPopup() {
            document.getElementById('invest-popup').style.display = 'none';
        }

        // --- Market Popup Functions ---
        function openMarketPopup() {
            document.getElementById('market-popup').style.display = 'block';
        }

        function closeMarketPopup() {
            document.getElementById('market-popup').style.display = 'none';
        }

        // Close when clicking outside
        window.onclick = function (event) {
            const marketModal = document.getElementById('market-popup');
            const investModal = document.getElementById('invest-popup');

            if (event.target == marketModal) {
                marketModal.style.display = "none";
            }
            if (event.target == investModal) {
                investModal.style.display = "none";
            }
        }

        // Global State & Data
        let globalData = [];
        let groupedData = []; // for WRS mode

        // App State
        let appState = {
            mode: 'INDIVIDUAL', // 'INDIVIDUAL' | 'WRS' | 'DRILLDOWN' | 'TODAYS_LIST' | 'RISING_STOCKS' | 'RISING_SECTORS'
            filterText: '',
            drillDownKey: null, // "Sector|Industry"
            sort: { key: 'RS_6mo', asc: false }, // Default Sort: RS(6mo) Descending
            filterRS_DiF: 'ALL', // 'ALL' | 'POS' | 'NEG'
            filterWRS_Dif: 'ALL', // 'ALL' | 'POS' | 'NEG'
            energyFilter: false // [Added] Energy Condensing Filter State
        };

        // 페이지 로드 시 자동 실행
        window.onload = function () {
            const today = new Date();
            const kstDate = new Intl.DateTimeFormat('ko-KR', {
                timeZone: 'Asia/Seoul',
                year: 'numeric', month: '2-digit', day: '2-digit'
            }).format(today);
            document.getElementById('page-title').innerText = `${kstDate} RS Investment`;

            // Enter Key Listener for Search
            document.getElementById('search-input').addEventListener("keypress", function (event) {
                if (event.key === "Enter") {
                    event.preventDefault();
                    handleSearch();
                }
            });

            // Close filter popup when clicking outside
            document.addEventListener('click', function (event) {
                const popup = document.getElementById('filter-popup');
                if (popup && popup.style.display === 'block' && !event.target.closest('th')) {
                    if (!popup.contains(event.target)) {
                        popup.style.display = 'none';
                    }
                }
            });

            loadData();
            loadHistoryIndex();
        };

        // Load History Index and populate dropdown
        async function loadHistoryIndex() {
            try {
                const res = await fetch('./static/history_index.json?t=' + new Date().getTime());
                if (!res.ok) return; // No history yet

                const json = await res.json();
                const selector = document.getElementById('date-selector');

                // Add history options
                json.dates.forEach(item => {
                    const option = document.createElement('option');
                    option.value = 'static/' + item.filename;
                    option.text = item.date;
                    selector.appendChild(option);
                });

                // Add change listener
                selector.addEventListener('change', function () {
                    loadData(this.value);
                });

            } catch (e) {
                console.log("History index load failed:", e);
            }
        }

        async function loadData(url = './static/result.json') {
            const loader = document.getElementById('loading-msg');
            if (loader) loader.style.display = 'block'; // Show loader when switching

            try {
                // Fetch Data
                const res = await fetch(url + '?t=' + new Date().getTime());
                if (res.status === 404) throw new Error("BOT_WORKING");
                if (!res.ok) throw new Error("데이터 로드 실패 code: " + res.status);

                const rawText = await res.text();
                // Fix NaN issue
                const sanitizedText = rawText.replace(/:\s*NaN/g, ': null');
                const json = JSON.parse(sanitizedText);

                // Initialize Data
                globalData = json.data;

                // [Added] Calculate RS_DiF for Individual Data
                // Also Calculate Market Cap Rank
                // 1. Sort by Market Cap Desc for Ranking
                const sortedByMC = [...globalData].sort((a, b) => {
                    const mcA = parseMarketCap(a['Market Cap']);
                    const mcB = parseMarketCap(b['Market Cap']);
                    return mcB - mcA;
                });
                // 2. Map Ticker to Rank
                const rankMap = {};
                sortedByMC.forEach((item, index) => {
                    rankMap[item.Ticker] = index + 1;
                });

                globalData.forEach(item => {
                    // Assign Rank
                    item.MarketCapRank = rankMap[item.Ticker];

                    // RS_DiF Calculation
                    const rs1 = parseFloat(item.RS_1mo) || 0;
                    const rs3 = parseFloat(item.RS_3mo) || 0;
                    const rs6 = parseFloat(item.RS_6mo) || 0;
                    // Formula: RS(1mo) - RS(3mo) - RS(6mo)
                    item.RS_DiF = rs1 - rs3 - rs6;
                });

                // [Added] Calculate RS Rank (Percentile)
                const sortedByRS = [...globalData].sort((a, b) => (parseFloat(b.RS_6mo) || 0) - (parseFloat(a.RS_6mo) || 0));
                const totalDocs = sortedByRS.length;
                const rsRankMap = {};
                sortedByRS.forEach((item, index) => {
                    rsRankMap[item.Ticker] = ((index + 1) / totalDocs) * 100;
                });
                globalData.forEach(item => {
                    item.RS_Rank_Pct = rsRankMap[item.Ticker];
                });

                // [Fix] Calculate WRS immediately so groupedData is ready for History Comparison
                calculateWRS();

                // Time Display
                if (json.last_updated) {
                    const lastUpdatedEl = document.getElementById('last-updated');
                    if (lastUpdatedEl) {
                        try {
                            const dateObj = new Date(json.last_updated.replace(' UTC', 'Z').replace(' ', 'T'));
                            const kstStr = new Intl.DateTimeFormat('ko-KR', {
                                timeZone: 'Asia/Seoul',
                                year: 'numeric', month: '2-digit', day: '2-digit',
                                hour: '2-digit', minute: '2-digit', second: '2-digit',
                                hour12: false
                            }).format(dateObj);
                            lastUpdatedEl.innerText = `Last update KST: ${kstStr}`;
                        } catch (e) {
                            lastUpdatedEl.innerText = `Last Updated: ${json.last_updated}`;
                        }
                    }
                }

                // Initial Render
                updateUI();

                document.getElementById('result-area').style.display = 'block';
                if (loader) loader.style.display = 'none';

                // [Added] Load Historical Data for 5-day comparison (Async)
                loadHistoricalComparison();

            } catch (e) {
                if (loader) {
                    if (e.message === "BOT_WORKING") {
                        loader.innerHTML = `<div style="padding: 20px; border: 2px dashed var(--primary-color);"><h3>🤖 봇이 작업중입니다!</h3><p>잠시 후 새로고침 해주세요.</p></div>`;
                    } else {
                        loader.innerText = "Error: " + e.message;
                    }
                } else {
                    console.error("Load Error (and loader missing):", e);
                }
            }
        }

        // [Added] New Function for Historical Comparison
        async function loadHistoricalComparison() {
            const debugEl = document.getElementById('history-debug');
            if (debugEl) debugEl.style.display = 'block';

            try {
                // 1. Get History Index
                const res = await fetch('./static/history_index.json?t=' + new Date().getTime());
                if (!res.ok) {
                    if (debugEl) debugEl.innerText = "Hist Index Fetch Failed";
                    return;
                }
                const indexData = await res.json();

                const dates = indexData.dates; // Sorted DESC

                if (dates.length < 11) {
                    if (debugEl) debugEl.innerText = `History insufficient (Count: ${dates.length}, Need 11)`;
                    console.log("Not enough history for 10D comparison (Total: " + dates.length + ")");
                    return;
                }

                const targetHistory = dates[10]; // 10 days ago (11th file)

                if (debugEl) debugEl.innerText = `Loading History: ${targetHistory.date} ...`;
                console.log("Loading 10-day ago data from:", targetHistory.filename);

                const histRes = await fetch('static/' + targetHistory.filename);
                if (!histRes.ok) {
                    if (debugEl) debugEl.innerText = `Hist File Fetch Failed: ${targetHistory.filename}`;
                    throw new Error("Failed to fetch history file");
                }
                // [Fix] Handle NaN in JSON
                const rawText = await histRes.text();
                // Replace constants like NaN with null (or 0) because JSON.parse fails on them
                const sanitizedText = rawText.replace(/:\s*NaN/g, ': null');
                const histJson = JSON.parse(sanitizedText);
                const histData = histJson.data; // Raw tickers

                // Update Header with Date
                const dateStr = targetHistory.date; // "YYYY-MM-DD"
                const shortDate = dateStr.substring(5); // "MM-DD"
                const header = document.querySelector('th[onclick="sortTable(\'Final_WRS_10D_Chg\')"]');
                if (header) header.innerText = `10D Chg (${shortDate}) ⬍`;

                // 3. Calculate WRS for Historical Data
                const histWRS = calculateWRSForData(histData);
                const histKeys = Object.keys(histWRS);

                let matchCount = 0;
                let foundCount = 0;
                let firstHistKey = histKeys.length > 0 ? histKeys[0] : "None";
                let firstCurrKey = "None";

                // 4. Merge WRS
                groupedData.forEach((curr, idx) => {
                    const key = `${curr.Sector}|${curr.Industry}`;
                    if (idx === 0) firstCurrKey = key;

                    const past = histWRS[key];

                    if (past) {
                        foundCount++;
                        if (past.Final_WRS !== 0 && !isNaN(past.Final_WRS)) {
                            const change = ((curr.Final_WRS - past.Final_WRS) / Math.abs(past.Final_WRS)) * 100;
                            curr.Final_WRS_10D_Chg = change;
                            matchCount++;
                        } else {
                            curr.Final_WRS_10D_Chg = null;
                        }
                    } else {
                        curr.Final_WRS_10D_Chg = null;
                    }
                });

                // [Added] 5. Merge Individual RS (Ticker Level)
                const histTickerMap = {};
                histData.forEach(item => {
                    if (item.Ticker) histTickerMap[item.Ticker] = item.RS_6mo;
                });

                let tickerMatchCount = 0;
                globalData.forEach(curr => {
                    const pastRS = histTickerMap[curr.Ticker];
                    // Check if pastRS is valid number (can be 0, but usually not null/undefined)
                    if (pastRS !== undefined && pastRS !== null && !isNaN(pastRS) && pastRS !== 0) {
                        // Change % = (Curr - Past) / |Past| * 100
                        const change = ((curr.RS_6mo - pastRS) / Math.abs(pastRS)) * 100;
                        curr.RS_6mo_10D_Chg = change;
                        tickerMatchCount++;
                    } else {
                        curr.RS_6mo_10D_Chg = null;
                    }
                });

                const debugMsg = `Loaded: ${dateStr} | HistItems: ${histData.length} | WRSGroups: ${histKeys.length} | Found: ${foundCount} | Valid: ${matchCount}\nTicker Matches: ${tickerMatchCount}`;
                if (debugEl) debugEl.innerText = debugMsg;
                console.log(debugMsg);

                // 6. Re-render UI
                updateUI();

            } catch (e) {
                console.error("Historical comparison failed:", e);
                if (debugEl) debugEl.innerText = `History Error: ${e.message}`;
            }
        }

        // Refactored WRS Calculation to be reusable
        function calculateWRSForData(rawData) {
            const groups = {};
            rawData.forEach(item => {
                // Ensure field existence
                if (!item['Market Cap'] || item['Market Cap'] === 'N/A') return;
                if (!item['Sector'] || item['Sector'] === 'N/A' || item['Sector'] === 'nan') return;

                const key = `${item.Sector}|${item.Industry}`;
                if (!groups[key]) {
                    groups[key] = {
                        Sector: item.Sector,
                        Industry: item.Industry,
                        Count: 0,
                        TotalMC: 0,
                        WeightedSum6: 0,
                        RS_Values: [],
                        WinCount: 0
                    };
                }

                // Robust Parsing
                const mc = parseMarketCap(item['Market Cap']);
                // Ensure RS is number
                const rs6 = parseFloat(item.RS_6mo) || 0;

                if (mc > 0) {
                    groups[key].Count += 1;
                    groups[key].TotalMC += mc;
                    groups[key].WeightedSum6 += (mc * rs6);
                    groups[key].RS_Values.push(rs6);
                    if (rs6 > 0) groups[key].WinCount += 1;
                }
            });

            const result = {};
            Object.values(groups).forEach(g => {
                // Median Calculation
                const sortedRS = g.RS_Values.sort((a, b) => a - b);

                let median = 0;
                if (sortedRS.length > 0) {
                    const mid = Math.floor(sortedRS.length / 2);
                    median = sortedRS.length % 2 === 0
                        ? (sortedRS[mid - 1] + sortedRS[mid]) / 2
                        : sortedRS[mid];
                }

                const wrs6mo = g.TotalMC > 0 ? (g.WeightedSum6 / g.TotalMC) : 0;
                const winRate = g.Count > 0 ? (g.WinCount / g.Count) : 0;
                const winFactor = g.Count > 1 ? (1 - (1 / g.Count)) : 0;

                const finalWRS = (wrs6mo * 0.4) + (median * 0.4) + (winRate * winFactor * 0.2);

                // [Added] WRS_Dif Calculation
                // Formula: WRS(1mo) - WRS(3mo) - WRS(6mo)
                const wrs3mo = g.TotalMC > 0 ? (g.WeightedSum3 / g.TotalMC) : 0;
                const wrs1mo = g.TotalMC > 0 ? (g.WeightedSum1 / g.TotalMC) : 0;
                const wrsDif = wrs1mo - wrs3mo - wrs6mo;

                result[`${g.Sector}|${g.Industry}`] = {
                    Final_WRS: finalWRS,
                    WRS_Dif: wrsDif
                };
            });
            return result;
        }

        // --- Core Functions ---

        function showIndividualRS() {
            appState.mode = 'INDIVIDUAL';
            appState.drillDownKey = null;
            appState.sort = { key: 'RS_6mo', asc: false }; // Default sort

            document.getElementById('search-input').value = '';
            appState.filterText = '';
            updateUI();
        }

        function showWRS() {
            // If in Drilldown, this acts as "Back"
            if (appState.mode === 'DRILLDOWN') {
                appState.mode = 'WRS';
                appState.drillDownKey = null;
            } else {
                appState.mode = 'WRS';
            }

            // Generate data if needed
            if (groupedData.length === 0) calculateWRS();

            appState.sort = { key: 'Final_WRS', asc: false }; // Default sort

            document.getElementById('search-input').value = '';
            appState.filterText = '';
            updateUI();
        }

        function updateUI() {
            const subtitle = document.getElementById('mode-subtitle');
            const wrsBtn = document.getElementById('wrs-btn');
            const indivBtn = document.getElementById('indiv-btn');
            const resultCount = document.getElementById('result-count');
            const energyBtn = document.getElementById('energy-filter-btn'); // [Added]

            if (!subtitle || !wrsBtn) {
                console.error("Missing UI elements: subtitle or wrsBtn");
                // indivBtn might be null if not used, but let's be safe. 
                // actually indivBtn is not used in this function below except for logic check
                // return; 
            }

            // 1. Update Subtitle & Button States
            let subtitleText = "";
            if (appState.mode === 'INDIVIDUAL') {
                subtitleText = "Individual RS";
                subtitle.style.color = "#2196f3"; // Blue
                if (wrsBtn) wrsBtn.innerText = "Sector/Industry WRS";

            } else if (appState.mode === 'WRS') {
                subtitleText = "Sector/Industry WRS";
                subtitle.style.color = "#ff5252"; // Red
                if (wrsBtn) wrsBtn.innerText = "Sector/Industry WRS";

            } else if (appState.mode === 'DRILLDOWN') {
                subtitleText = "Sector Detail View";
                subtitle.style.color = "#00e676";
                if (wrsBtn) wrsBtn.innerText = "Back to WRS List";

            } else if (appState.mode === 'TODAYS_LIST') {
                subtitleText = "Today's List";
                subtitle.style.color = "#ff9800"; // Orange
                if (wrsBtn) wrsBtn.innerText = "Sector/Industry WRS";

            } else if (appState.mode === 'TODAYS_MAIN') {
                subtitleText = "Today's Main";
                subtitle.style.color = "#e91e63"; // Pink
                if (wrsBtn) wrsBtn.innerText = "Sector/Industry WRS";

            } else if (appState.mode === 'TODAYS_TOP') {
                subtitleText = "Today's Top (Best of Best)";
                subtitle.style.color = "#00bcd4"; // Cyan
                if (wrsBtn) wrsBtn.innerText = "Sector/Industry WRS";

            } else if (appState.mode === 'RISING_STOCKS') {
                subtitleText = "Rising/Rebound Stocks (RS_DiF > 0, CY/NY > 0)";
                subtitle.style.color = "#ffca28";
                if (wrsBtn) wrsBtn.innerText = "Sector/Industry WRS";

            } else if (appState.mode === 'RISING_SECTORS') {
                subtitleText = "Rising/Rebound Sectors (WRS_Dif > 0)";
                subtitle.style.color = "#ffca28";
                if (wrsBtn) wrsBtn.innerText = "Sector/Industry WRS";
            }

            // [Added] Energy Filter UI Update
            if (appState.energyFilter) {
                if (energyBtn) energyBtn.innerText = "🔄 다시모든놈보여줘";
                subtitleText += " (⚡에너지응축)";
            } else {
                if (energyBtn) energyBtn.innerText = "⚡에너지응축하는놈";
            }

            subtitle.innerText = subtitleText;

            // 2. Render Data
            const data = getFilteredAndSortedData();
            renderTable(data);

            if (resultCount) {
                resultCount.innerText = `Total: ${data.length} Items`;
            }

            // 3. Table Layout Adjustment (Compact center for WRS)
            const tableElement = document.querySelector('table');
            if (tableElement) {
                if (appState.mode === 'WRS') {
                    tableElement.style.width = 'auto'; // Shrink to fit
                    tableElement.style.margin = '0 auto'; // Center
                } else {
                    tableElement.style.width = '100%'; // Full width
                    tableElement.style.margin = '0';
                }
            }
        }

        function showTodaysList() {
            appState.mode = 'TODAYS_LIST';
            appState.filterText = '';
            document.getElementById('search-input').value = '';
            appState.sort = { key: 'RS_6mo', asc: false };

            // WRS 계산이 필요한 경우
            if (groupedData.length === 0) {
                calculateWRS();
            }

            updateUI();
        }

        function showTodayMain() {
            // Function needed but not part of original request, implementing `showTodaysMain` below
        }

        function showTodaysMain() {
            appState.mode = 'TODAYS_MAIN';
            appState.filterText = '';
            document.getElementById('search-input').value = '';
            appState.sort = { key: 'RS_6mo', asc: false };

            if (groupedData.length === 0) {
                calculateWRS();
            }

            updateUI();
        }

        function showTodaysTop() {
            appState.mode = 'TODAYS_TOP';
            appState.filterText = '';
            document.getElementById('search-input').value = '';
            appState.sort = { key: 'RS_6mo', asc: false };


            updateUI();
        }

        // --- Rising Modes ---
        function showRisingStocks() {
            appState.mode = 'RISING_STOCKS';
            // Sort by NY_Trend Desc
            appState.sort = { key: 'NY_Trend', asc: false };

            // Reset filters to avoid confusion, logic handled in getFilteredAndSortedData
            appState.filterRS_DiF = 'ALL';

            document.getElementById('search-input').value = '';
            updateUI();
        }

        function showRisingSectors() {
            appState.mode = 'RISING_SECTORS';
            // Sort by Win_Rate Desc
            appState.sort = { key: 'Win_Rate', asc: false };
            // Ensure WRS calculated
            if (groupedData.length === 0) calculateWRS();

            appState.filterWRS_Dif = 'ALL';
            document.getElementById('search-input').value = '';
            updateUI();
        }

        // [Added] Toggle Energy Filter
        function toggleEnergyFilter() {
            appState.energyFilter = !appState.energyFilter;
            updateUI();
        }

        function calculateWRS() {
            // Group by Sector|Industry
            const groups = {};

            globalData.forEach(item => {
                // Ensure Sector/Industry exists
                if (!item['Sector'] || item['Sector'] === 'N/A') return;
                if (!item['Industry'] || item['Industry'] === 'N/A') return;

                const key = `${item.Sector}|${item.Industry}`;
                if (!groups[key]) {
                    groups[key] = {
                        Sector: item.Sector,
                        Industry: item.Industry,
                        Count: 0,
                        TotalMC: 0,
                        WeightedSum6: 0,
                        WeightedSum3: 0, // [Added]
                        WeightedSum1: 0, // [Added]
                        RS_Values: [], // For Median
                        WinCount: 0
                    };
                }

                // Market Cap Parsing
                const mc = parseMarketCap(item['Market Cap']);
                if (mc > 0) {
                    const rs6 = parseFloat(item.RS_6mo) || 0;
                    const rs3 = parseFloat(item.RS_3mo) || 0; // [Added]
                    const rs1 = parseFloat(item.RS_1mo) || 0; // [Added]

                    groups[key].Count += 1;
                    groups[key].TotalMC += mc;
                    groups[key].WeightedSum6 += (mc * rs6);
                    groups[key].WeightedSum3 += (mc * rs3); // [Added]
                    groups[key].WeightedSum1 += (mc * rs1); // [Added]

                    groups[key].RS_Values.push(rs6);

                    if (rs6 > 0) groups[key].WinCount += 1;
                }
            });

            // Calculate Metrics per Group
            groupedData = Object.values(groups).map(g => {
                // ... (Existing Logic)
                // 1. Median RS(6mo)
                const sortedRS = g.RS_Values.sort((a, b) => a - b);
                let median = 0;
                if (sortedRS.length > 0) {
                    const mid = Math.floor(sortedRS.length / 2);
                    median = sortedRS.length % 2 === 0
                        ? (sortedRS[mid - 1] + sortedRS[mid]) / 2
                        : sortedRS[mid];
                }

                // 2. WRS (Weighted Average)
                const wrs6mo = g.TotalMC > 0 ? (g.WeightedSum6 / g.TotalMC) : 0;
                const wrs3mo = g.TotalMC > 0 ? (g.WeightedSum3 / g.TotalMC) : 0;
                const wrs1mo = g.TotalMC > 0 ? (g.WeightedSum1 / g.TotalMC) : 0;

                // 3. Win Rate & Factor
                const winRate = g.Count > 0 ? (g.WinCount / g.Count) : 0;
                const winFactor = g.Count > 1 ? (1 - (1 / g.Count)) : 0;

                // 4. Final WRS
                const finalWRS = (wrs6mo * 0.4) + (median * 0.4) + (winRate * winFactor * 0.2);

                const wrsDif = wrs1mo - wrs3mo - wrs6mo;

                return {
                    Sector: g.Sector,
                    Industry: g.Industry,
                    Count: g.Count,
                    WRS_6mo: wrs6mo,
                    WRS_3mo: wrs3mo,
                    WRS_1mo: wrs1mo,
                    WRS_Dif: wrsDif,
                    WRS_MD_6mo: median,
                    Win_Rate: winRate * 100, // %
                    Final_WRS: finalWRS,
                    Final_WRS_10D_Chg: null,
                    RS_Values: g.RS_Values
                };
            });

            // [Modified] Exclude groups with Count <= 1
            groupedData = groupedData.filter(g => g.Count > 1);

            // [Added] Calculate WRS Ranks (Percentile)
            const calculateRank = (arr, key, rankKey) => {
                const sorted = [...arr].sort((a, b) => b[key] - a[key]);
                const total = sorted.length;
                sorted.forEach((item, index) => {
                    // Percentile: Top 0.1% etc. (Rank / Total) * 100
                    item[rankKey] = ((index + 1) / total) * 100;
                });
            };

            calculateRank(groupedData, 'Final_WRS', 'Final_WRS_Rank_Pct');
            calculateRank(groupedData, 'WRS_6mo', 'WRS_Rank_Pct');
            calculateRank(groupedData, 'WRS_MD_6mo', 'WRS_MD_Rank_Pct');
        }

        // --- Helper: Parse Market Cap ---
        function parseMarketCap(mcStr) {
            if (!mcStr) return 0;
            // e.g. "1.23T", "45.6B", "789M"
            const last = mcStr.slice(-1).toUpperCase();
            const val = parseFloat(mcStr.slice(0, -1));

            if (isNaN(val)) return 0;

            if (last === 'T') return val * 1_000_000_000_000;
            if (last === 'B') return val * 1_000_000_000;
            if (last === 'M') return val * 1_000_000;
            if (last === 'K') return val * 1_000;
            return val;
        }

        // --- Helper: Sort ---
        function sortTable(key) {
            if (appState.sort.key === key) {
                // Toggle desc/asc
                appState.sort.asc = !appState.sort.asc;
            } else {
                appState.sort.key = key;
                appState.sort.asc = false; // Default desc
            }
            updateUI();
        }

        // --- Helper: Filter by RS_DiF / WRS_Dif ---
        function applyFilter(type, value) {
            if (type === 'RS_DiF') {
                appState.filterRS_DiF = value;
            } else if (type === 'WRS_Dif') {
                appState.filterWRS_Dif = value;
            }

            // Close popup
            const popup = document.getElementById('filter-popup');
            if (popup) popup.style.display = 'none';

            updateUI();
        }

        function showFilterPopup(event, type) {
            event.stopPropagation(); // Stop sorting

            const popup = document.getElementById('filter-popup');
            if (!popup) {
                // Create popup if not exists
                const div = document.createElement('div');
                div.id = 'filter-popup';
                div.className = 'filter-popup';
                document.body.appendChild(div);
            }

            const p = document.getElementById('filter-popup');
            const currentFilter = (type === 'RS_DiF') ? appState.filterRS_DiF : appState.filterWRS_Dif;

            p.innerHTML = `
                <div style="font-weight:bold; margin-bottom:8px; border-bottom:1px solid #555; padding-bottom:5px;">
                    ${type} Filter
                </div>
                <label>
                    <input type="radio" name="filter-${type}" value="ALL" 
                        onclick="applyFilter('${type}', 'ALL')" ${currentFilter === 'ALL' ? 'checked' : ''}> 
                    All
                </label>
                <label>
                    <input type="radio" name="filter-${type}" value="POS" 
                        onclick="applyFilter('${type}', 'POS')" ${currentFilter === 'POS' ? 'checked' : ''}> 
                    (+) Positive
                </label>
                <label>
                    <input type="radio" name="filter-${type}" value="NEG" 
                        onclick="applyFilter('${type}', 'NEG')" ${currentFilter === 'NEG' ? 'checked' : ''}> 
                    (-) Negative
                </label>
            `;

            // Position
            const rect = event.target.getBoundingClientRect();
            p.style.top = (window.scrollY + rect.bottom + 5) + 'px';
            p.style.left = (window.scrollX + rect.left) + 'px';
            p.style.display = 'block';
        }

        // --- Data Processing for Render ---
        function getFilteredAndSortedData() {
            let targetData = [];

            // 1. Select Data Source based on Mode
            if (appState.mode === 'INDIVIDUAL' || appState.mode === 'TODAYS_LIST' || appState.mode === 'TODAYS_MAIN') {
                targetData = [...globalData]; // Copy
            } else if (appState.mode === 'WRS' || appState.mode === 'RISING_SECTORS') {
                targetData = [...groupedData];
            } else if (appState.mode === 'DRILLDOWN') {
                // Filter globalData by DrillDownKey
                targetData = globalData.filter(item => {
                    return `${item.Sector}|${item.Industry}` === appState.drillDownKey;
                });
            } else if (appState.mode === 'RISING_STOCKS') {
                targetData = [...globalData];
            } else if (appState.mode === 'TODAYS_TOP') { // Added TODAYS_TOP logic source
                targetData = [...globalData];
            }


            // 2. [Added] Apply Energy Condensing Filter (Prioritize this over mode specific? No, combine with mode)
            // It acts as an additional filter on the currently selected data source.
            if (appState.energyFilter) {
                targetData = targetData.filter(item => {
                    // 1. Jungjanggi Jeongbaeyeol: YES
                    if (item['Jungjanggi Jeongbaeyeol'] !== "YES") return false;

                    // 2. 10DIV: within ±4%
                    const div10 = parseFloat(item['10DIV']);
                    if (isNaN(div10) || Math.abs(div10) > 4) return false;

                    // 3. BBWTHD < 0.15 OR BBWTHD <= BBWTHD_LOW
                    // Note: If BBWTHD_LOW includes today, BBWTHD <= BBWTHD_LOW means it matches the low.
                    const bbw = parseFloat(item.BBWTHD);
                    const bbwLow = parseFloat(item.BBWTHD_LOW);

                    if (isNaN(bbw)) return false;

                    let cond1 = bbw < 0.15;
                    let cond2 = (!isNaN(bbwLow) && bbw <= bbwLow);

                    if (!cond1 && !cond2) return false;

                    return true;
                });
            }


            // 2. Apply Mode-Specific Filters
            if (appState.mode === 'TODAYS_LIST') {
                // [Requirement]
                // 1. Sector/Industry: Count >= 2, Win-Rate >= 60%, Final WRS Top 30%
                // 2. Individual: RS(6mo) Top 30% within Sector, 50DIV > 0

                // A. Identify Top Sectors
                const validGroups = groupedData.filter(g => g.Count >= 2 && g.Win_Rate >= 60);
                // Sort by Final_WRS desc to find top 30%
                validGroups.sort((a, b) => b.Final_WRS - a.Final_WRS);
                const topGroupCutoff = Math.ceil(validGroups.length * 0.3);
                const topGroups = validGroups.slice(0, topGroupCutoff);
                const topGroupKeys = new Set(topGroups.map(g => `${g.Sector}|${g.Industry}`));

                // B. Filter Tickers
                targetData = targetData.filter(stock => {
                    // Must belong to Top Sector
                    const key = `${stock.Sector}|${stock.Industry}`;
                    if (!topGroupKeys.has(key)) return false;

                    // Must have 50DIV > 0
                    const div50 = parseFloat(stock['50DIV']);
                    if (isNaN(div50) || div50 <= 0) return false;

                    return true;
                });

                // C. RS(6mo) Top 30% within *each* sector (pre-calculation optimization?)
                // Or just filter here simply? The requirement says "RS(6mo) Top 30% within selected sector"
                // Let's refine: For each stock, check if it is in top 30% of its group.
                // We need group-level sorted lists.
                // Re-use groups from calculateWRS logic? 

                // Easy way: Group targetData by (Sector|Industry) again, then slice top 30%.
                // But targetData is already filtered by group.

                // Let's do a map for "Top 30% Threshold per Group"
                const groupThresholds = {};
                topGroups.forEach(g => {
                    // g.RS_Values is already sorted asc (rs values)
                    // We need top 30% -> Top 0.3 -> Bottom 0.7 index
                    // e.g. 10 items. Top 3 items. 7th item is cutoff (if sorted asc).
                    const count = g.RS_Values.length;
                    const cutoffIndex = Math.floor(count * 0.7);
                    // g.RS_Values is sorted ASC. so index 0 is smallest. 
                    // slice(cutoffIndex) gives top items.
                    // The value at cutoffIndex is the minimum RS needed.
                    if (count > 0 && cutoffIndex < count) {
                        groupThresholds[`${g.Sector}|${g.Industry}`] = g.RS_Values[cutoffIndex];
                    } else {
                        groupThresholds[`${g.Sector}|${g.Industry}`] = -9999; // Take all
                    }
                });

                targetData = targetData.filter(stock => {
                    const key = `${stock.Sector}|${stock.Industry}`;
                    const threshold = groupThresholds[key];
                    const rs6 = parseFloat(stock.RS_6mo) || 0;
                    return rs6 >= threshold;
                });

            } else if (appState.mode === 'TODAYS_MAIN') {
                // Reuse logic of TODAYS_LIST first, then stricter filter
                // 1. Get List Data (Simulate Today's List Logic)
                // Copy-paste logic or abstraction? Abstraction is better but stick to flow.

                // A. Identify Top Sectors (Same as List)
                const validGroups = groupedData.filter(g => g.Count >= 2 && g.Win_Rate >= 60);
                validGroups.sort((a, b) => b.Final_WRS - a.Final_WRS);
                const topGroupCutoff = Math.ceil(validGroups.length * 0.3);
                const topGroups = validGroups.slice(0, topGroupCutoff);
                const topGroupKeys = new Set(topGroups.map(g => `${g.Sector}|${g.Industry}`));

                targetData = targetData.filter(stock => {
                    const key = `${stock.Sector}|${stock.Industry}`;
                    if (!topGroupKeys.has(key)) return false;
                    const div50 = parseFloat(stock['50DIV']);
                    if (isNaN(div50) || div50 <= 0) return false;
                    return true;
                });

                // Thresholds (Same as List)
                const groupThresholds = {};
                topGroups.forEach(g => {
                    const count = g.RS_Values.length;
                    const cutoffIndex = Math.floor(count * 0.7);
                    if (count > 0 && cutoffIndex < count) {
                        groupThresholds[`${g.Sector}|${g.Industry}`] = g.RS_Values[cutoffIndex];
                    } else {
                        groupThresholds[`${g.Sector}|${g.Industry}`] = -9999;
                    }
                });

                // B. Apply Main Filters
                // 1. Today's List (RS Top 30%)
                // 2. CY & NY Trend >= 5%
                // 3. 50DIV <= 55%
                targetData = targetData.filter(stock => {
                    const key = `${stock.Sector}|${stock.Industry}`;
                    const threshold = groupThresholds[key];
                    const rs6 = parseFloat(stock.RS_6mo) || 0;

                    // 1. Today's List condition
                    if (rs6 < threshold) return false;

                    // 2. CY & NY Trend
                    const cy = parseFloat(stock.CY_Trend);
                    const ny = parseFloat(stock.NY_Trend);
                    if (isNaN(cy) || cy < 5) return false;
                    if (isNaN(ny) || ny < 5) return false;

                    // 3. 50DIV <= 55
                    const div50 = parseFloat(stock['50DIV']); // Already checked > 0 above
                    if (div50 > 55) return false;

                    return true;
                });
            } else if (appState.mode === 'RISING_STOCKS') {
                // 급등/반등가능성↑종목: 
                // 1) RS_DiF > 0 
                // 2) CY_Trend > 0
                // 3) NY_Trend > 0
                targetData = globalData.filter(stock =>
                    stock.RS_DiF > 0 &&
                    stock.CY_Trend > 0 &&
                    stock.NY_Trend > 0
                );
            } else if (appState.mode === 'RISING_SECTORS') {
                // 급등/반등가능성↑섹터: WRS_Dif > 0
                // Sort is handled in sort section (Win_Rate)
                targetData = groupedData.filter(g => g.WRS_Dif > 0);
            }

            // 3. Apply Text Search (Global)
            if (appState.filterText) {
                const lower = appState.filterText.toLowerCase();
                targetData = targetData.filter(item => {
                    // Search in Ticker, Sector, Industry (and maybe others?)
                    const ticker = item.Ticker ? item.Ticker.toLowerCase() : '';
                    const sector = item.Sector ? item.Sector.toLowerCase() : '';
                    const ind = item.Industry ? item.Industry.toLowerCase() : '';
                    return ticker.includes(lower) || sector.includes(lower) || ind.includes(lower);
                });
            }

            // 4. Apply Custom Filters (RS_DiF / WRS_Dif)
            // Note: RISING modes override these, but if user manually filters in INDIV/WRS mode:
            if (appState.mode === 'INDIVIDUAL' || appState.mode === 'DRILLDOWN') {
                if (appState.filterRS_DiF === 'POS') {
                    targetData = targetData.filter(item => item.RS_DiF > 0);
                } else if (appState.filterRS_DiF === 'NEG') {
                    targetData = targetData.filter(item => item.RS_DiF < 0);
                }
            }
            if (appState.mode === 'WRS') {
                if (appState.filterWRS_Dif === 'POS') {
                    targetData = targetData.filter(item => item.WRS_Dif > 0);
                } else if (appState.filterWRS_Dif === 'NEG') {
                    targetData = targetData.filter(item => item.WRS_Dif < 0);
                }
            }

            // 5. Apply Sorting
            targetData.sort((a, b) => {
                let valA = a[appState.sort.key];
                let valB = b[appState.sort.key];

                // Handle nulls/undefined - push to bottom? or treat as -Infinity?
                // Let's treat null as -Infinity for desc sort, +Infinity for asc (so always bottom)
                // Actually safer to treat as very small number.
                if (valA === undefined || valA === null) valA = -99999999;
                if (valB === undefined || valB === null) valB = -99999999;

                // String comparison (Ticker, Sector, Industry)
                if (typeof valA === 'string' && typeof valB === 'string') {
                    return appState.sort.asc ? valA.localeCompare(valB) : valB.localeCompare(valA);
                }

                // Numeric comparison
                return appState.sort.asc ? (valA - valB) : (valB - valA);
            });

            return targetData;
        }

        // --- Search Handler ---
        function handleSearch() {
            const input = document.getElementById('search-input');
            const val = input.value.trim();
            appState.filterText = val;
            updateUI();
        }

        // --- Helper: Safe Number Check ---
        function isValidNumber(val) {
            return val !== null && val !== undefined && !isNaN(val);
        }

        function getChgColor(val) {
            if (!isValidNumber(val)) return "";
            if (val > 0) return "color: #00e676;";
            if (val < 0) return "color: #ff5252;";
            return "";
        }

        // --- Main Render Function ---
        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';

            const thead = document.querySelector('table thead tr');

            if (appState.mode === 'WRS' || appState.mode === 'RISING_SECTORS') {
                // WRS Table Header
                thead.innerHTML = `
                    <th onclick="sortTable('Sector')">Sector ⬍</th>
                    <th onclick="sortTable('Industry')">Industry ⬍</th>
                    <th onclick="sortTable('Final_WRS')">Final WRS ⬍</th>
                    <th onclick="sortTable('Final_WRS_Rank_Pct')">Final Rank (%) ⬍</th>
                    <th onclick="sortTable('Final_WRS_10D_Chg')">10D Chg (%) ⬍</th>
                    <th onclick="sortTable('Count')">Total Count ⬍</th>
                    <th onclick="sortTable('WRS_6mo')">WRS (6mo) ⬍</th>
                    <th onclick="sortTable('WRS_Rank_Pct')">WRS Rank (%) ⬍</th>
                    <th onclick="sortTable('WRS_6mo_MD')">WRS_MD (6mo) ⬍</th>
                    <th onclick="sortTable('WRS_MD_Rank_Pct')">WRS_MD Rank (%) ⬍</th>
                    <th onclick="sortTable('Win_Rate')">Win-rate (%) ⬍</th>
                    <th onclick="sortTable('WRS_3mo')">WRS (3mo) ⬍</th>
                    <th onclick="sortTable('WRS_1mo')">WRS (1mo) ⬍</th>
                    <th onclick="sortTable('WRS_Dif')">
                        WRS_Dif ⬍
                        <span style="font-size:12px; cursor:pointer;" onclick="showFilterPopup(event, 'WRS_Dif')">🔍</span>
                    </th>
                `;

                data.forEach(item => {
                    const tr = document.createElement('tr');

                    const difClass = (isValidNumber(item.WRS_Dif) && item.WRS_Dif > 0) ? 'rs-pos' :
                        ((isValidNumber(item.WRS_Dif) && item.WRS_Dif < 0) ? 'rs-neg' : '');

                    tr.innerHTML = `
                        <td style="font-weight:bold; cursor:pointer;" onclick="drillDown('${item.Sector}|${item.Industry}')">${item.Sector}</td>
                        <td style="font-weight:bold; cursor:pointer;" onclick="drillDown('${item.Sector}|${item.Industry}')">${item.Industry}</td>
                        <td style="font-weight:bold; color:var(--primary-color)">${isValidNumber(item.Final_WRS) ? item.Final_WRS.toFixed(2) : '-'}</td>
                        <td>${isValidNumber(item.Final_WRS_Rank_Pct) ? item.Final_WRS_Rank_Pct.toFixed(1) + '%' : '-'}</td>
                        <td style="${getChgColor(item.Final_WRS_10D_Chg)}">
                            ${isValidNumber(item.Final_WRS_10D_Chg) ? item.Final_WRS_10D_Chg.toFixed(1) + '%' : '-'}
                        </td>
                        <td>${item.Count}</td>
                        <td>${isValidNumber(item.WRS_6mo) ? item.WRS_6mo.toFixed(2) : '-'}</td>
                        <td>${isValidNumber(item.WRS_Rank_Pct) ? item.WRS_Rank_Pct.toFixed(1) + '%' : '-'}</td>
                        <td>${isValidNumber(item.WRS_MD_6mo) ? item.WRS_MD_6mo.toFixed(2) : '-'}</td>
                        <td>${isValidNumber(item.WRS_MD_Rank_Pct) ? item.WRS_MD_Rank_Pct.toFixed(1) + '%' : '-'}</td>
                        <td>${isValidNumber(item.Win_Rate) ? item.Win_Rate.toFixed(1) + '%' : '-'}</td>
                        <td>${isValidNumber(item.WRS_3mo) ? item.WRS_3mo.toFixed(2) : '-'}</td>
                        <td>${isValidNumber(item.WRS_1mo) ? item.WRS_1mo.toFixed(2) : '-'}</td>
                        <td class="${difClass}">${isValidNumber(item.WRS_Dif) ? item.WRS_Dif.toFixed(2) : '-'}</td>
                    `;
                    tbody.appendChild(tr);
                });

            } else {
                // Individual / Drilldown / Lists
                thead.innerHTML = `
                    <th onclick="sortTable('Ticker')">Ticker ⬍</th>
                    <th onclick="sortTable('Sector')">Sector ⬍</th>
                    <th onclick="sortTable('Industry')">Industry ⬍</th>
                    <th onclick="sortTable('Price')">Price ($) ⬍</th>
                    <th onclick="sortTable('Market Cap')">Market Cap ($) ⬍</th>
                    <th onclick="sortTable('MarketCapRank')">MC Rank ⬍</th>
                    <th onclick="sortTable('RS_6mo')">RS (6mo) ⬍</th>
                    <th onclick="sortTable('RS_Rank_Pct')">RS Rank (%) ⬍</th>
                    <th onclick="sortTable('RS_6mo_10D_Chg')">10D Chg (%) ⬍</th>
                    <th onclick="sortTable('RS_3mo')">RS (3mo) ⬍</th>
                    <th onclick="sortTable('RS_1mo')">RS (1mo) ⬍</th>
                    <th onclick="sortTable('RS_DiF')">
                        RS_DiF ⬍
                        <span style="font-size:12px; cursor:pointer;" onclick="showFilterPopup(event, 'RS_DiF')">🔍</span>
                    </th>
                    <th onclick="sortTable('50DIV')">50DIV (%) ⬍</th>
                    <th onclick="sortTable('CY_Trend')">CY Trend (%) ⬍</th>
                    <th onclick="sortTable('NY_Trend')">NY Trend (%) ⬍</th>
                    <th onclick="sortTable('Up_Count')">Up # ⬍</th>
                    <th onclick="sortTable('Down_Count')">Down # ⬍</th>
                    <th onclick="sortTable('Up_Down_Ratio')">Up/(Up+Down) ⬍</th>
                    <th onclick="sortTable('Jungjanggi Jeongbaeyeol')">중장기정배열 ⬍</th>
                    <th onclick="sortTable('10DIV')">10DIV (%) ⬍</th>
                    <th onclick="sortTable('BBWTHD')">BBWTHD ⬍</th>
                    <th onclick="sortTable('BBWTHD_LOW')">BBWTHD LOW ⬍</th>
                `;

                data.forEach(item => {
                    const tr = document.createElement('tr');

                    // Convert to numbers for safety if strings
                    const rs6 = parseFloat(item.RS_6mo);
                    const rs3 = parseFloat(item.RS_3mo);
                    const rs1 = parseFloat(item.RS_1mo);
                    const rsDif = parseFloat(item.RS_DiF);

                    const rs6Class = (isValidNumber(rs6) && rs6 > 0) ? 'rs-pos' : 'rs-neg';
                    const rs3Class = (isValidNumber(rs3) && rs3 > 0) ? 'rs-pos' : 'rs-neg';
                    const rs1Class = (isValidNumber(rs1) && rs1 > 0) ? 'rs-pos' : 'rs-neg';
                    const difClass = (isValidNumber(rsDif) && rsDif > 0) ? 'rs-pos' :
                        ((isValidNumber(rsDif) && rsDif < 0) ? 'rs-neg' : '');
                    // Format Large Numbers
                    const mcStr = item.Market_Cap_Readable || item['Market Cap'];

                    const price = parseFloat(item.Price);
                    const priceStr = isValidNumber(price) ? price.toFixed(2) : item.Price;

                    const cy = parseFloat(item.CY_Trend);
                    const ny = parseFloat(item.NY_Trend);
                    // [Fix] Standardize Trend Colors (Pos: Green, Neg: Red)
                    const cyColor = (isValidNumber(cy) && cy > 0) ? 'rs-pos' : ((isValidNumber(cy) && cy < 0) ? 'rs-neg' : '');
                    const nyColor = (isValidNumber(ny) && ny > 0) ? 'rs-pos' : ((isValidNumber(ny) && ny < 0) ? 'rs-neg' : '');

                    // [Fix] Handle null counts gracefully
                    const upCount = isValidNumber(item.Up_Count) ? item.Up_Count : '-';
                    const downCount = isValidNumber(item.Down_Count) ? item.Down_Count : '-';
                    const upDownRatio = isValidNumber(item.Up_Down_Ratio) ? item.Up_Down_Ratio : '-';

                    // [Added] Jeongbaeyeol Color Logic
                    const jb = item['Jungjanggi Jeongbaeyeol'] || 'NO';
                    const jbColor = (jb === 'YES') ? 'rs-pos' : '';

                    // [Added] 10DIV Logic
                    const div10 = item['10DIV'];
                    const div10Str = isValidNumber(div10) ? div10 + '%' : '-';

                    tr.innerHTML = `
                        <td style="font-weight:bold;">
                            <a href="https://finance.yahoo.com/quote/${item.Ticker}" target="_blank" style="color:#fff; text-decoration:none">
                                ${item.Ticker}
                            </a>
                        </td>
                        <td>${item.Sector}</td>
                        <td>${item.Industry}</td>
                        <td>${priceStr}</td>
                        <td>${mcStr}</td>
                        <td>${item.MarketCapRank || '-'}</td>
                        <td class="${rs6Class}">${isValidNumber(rs6) ? rs6.toFixed(2) : '-'}</td>
                        <td>${isValidNumber(item.RS_Rank_Pct) ? item.RS_Rank_Pct.toFixed(1) + '%' : '-'}</td>
                        <td style="${getChgColor(item.RS_6mo_10D_Chg)}">
                            ${isValidNumber(item.RS_6mo_10D_Chg) ? item.RS_6mo_10D_Chg.toFixed(1) + '%' : '-'}
                        </td>
                        <td class="${rs3Class}">${isValidNumber(rs3) ? rs3.toFixed(2) : '-'}</td>
                        <td class="${rs1Class}">${isValidNumber(rs1) ? rs1.toFixed(2) : '-'}</td>
                        <td class="${difClass}">${isValidNumber(rsDif) ? rsDif.toFixed(2) : '-'}</td>
                        <td>${item['50DIV']}%</td>
                        <td class="${cyColor}">${isValidNumber(cy) ? cy.toFixed(2) + '%' : '-'}</td>
                        <td class="${nyColor}">${isValidNumber(ny) ? ny.toFixed(2) + '%' : '-'}</td>
                        <td>${upCount}</td>
                        <td>${downCount}</td>
                        <td>${upDownRatio}</td>
                        <td class="${jbColor}">${jb}</td>
                        <td>${div10Str}</td>
                        <td>${isValidNumber(item.BBWTHD) ? item.BBWTHD.toFixed(2) : '-'}</td>
                        <td>${isValidNumber(item.BBWTHD_LOW) ? item.BBWTHD_LOW.toFixed(2) : '-'}</td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        function drillDown(key) {
            appState.mode = 'DRILLDOWN';
            appState.drillDownKey = key;
            appState.sort = { key: 'RS_6mo', asc: false };

            document.getElementById('search-input').value = '';
            appState.filterText = '';

            updateUI();
            window.scrollTo(0, 0); // Scroll to top
        }

        // --- Excel Download ---
        function downloadExcel() {
            // Determine data based on current view modes (but ignore filters for export normally? 
            // Result: Export *Visible* data or *All* data of current mode? 
            // Usually user wants what they see. Let's export filtered data.
            const data = getFilteredAndSortedData();

            if (data.length === 0) {
                alert("No data to export");
                return;
            }

            let excelData = [];

            if (appState.mode === 'WRS' || appState.mode === 'RISING_SECTORS') {
                excelData = data.map(item => ({
                    'Sector': item.Sector,
                    'Industry': item.Industry,
                    'Final WRS': item.Final_WRS.toFixed(4),
                    'WRS(6mo)': item.WRS_6mo.toFixed(4),
                    'WRS(6mo)_10D_Chg%': item.Final_WRS_10D_Chg !== null ? parseFloat(item.Final_WRS_10D_Chg.toFixed(2)) : null,
                    'WRS_MD(6mo)': item.WRS_MD_6mo.toFixed(4),
                    'Win-Rate(%)': item.Win_Rate.toFixed(2),
                    'Total Count': item.Count,
                    'WRS(3mo)': item.WRS_3mo.toFixed(4),
                    'WRS(1mo)': item.WRS_1mo.toFixed(4),
                    'WRS_Dif': item.WRS_Dif ? parseFloat(item.WRS_Dif.toFixed(4)) : null // Add new column
                }));
            } else {
                excelData = data.map(item => ({
                    'Ticker': item.Ticker,
                    'Sector': item.Sector,
                    'Industry': item.Industry,
                    'Price': item.Price,
                    'Market Cap': item['Market Cap'],
                    'RS(6mo)': item.RS_6mo,
                    'RS(6mo)_10D_Chg%': item.RS_6mo_10D_Chg !== null ? parseFloat(item.RS_6mo_10D_Chg.toFixed(2)) : null,
                    'RS Rank%': item.RS_Rank_Pct,
                    'RS(3mo)': item.RS_3mo,
                    'RS(1mo)': item.RS_1mo,
                    'RS_DiF': item.RS_DiF ? parseFloat(item.RS_DiF.toFixed(4)) : null, // Add new column
                    '50DIV': item['50DIV'],
                    'CY Trend': item.CY_Trend,
                    'NY Trend': item.NY_Trend,
                    'Up Count': item.Up_Count,
                    'Down Count': item.Down_Count,
                    'Up/Down Ratio': item.Up_Down_Ratio,
                    'Jungjanggi Jeongbaeyeol': item['Jungjanggi Jeongbaeyeol'],
                    '10DIV': item['10DIV'],
                    'BBWTHD': item.BBWTHD,
                    'BBWTHD_LOW': item.BBWTHD_LOW
                }));
            }

            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();

            const sheetName = (appState.mode === 'WRS' || appState.mode === 'RISING_SECTORS') ? 'Sector_WRS' : 'Individual_RS';

            XLSX.utils.book_append_sheet(wb, ws, sheetName);

            // Filename with date
            const dateStr = new Date().toISOString().slice(0, 10).replace(/-/g, "");
            XLSX.writeFile(wb, `RS_Investment_${sheetName}_${dateStr}.xlsx`);
        }

        // Description Toggle
        function toggleDescription() {
            const content = document.getElementById('description-content');
            const arrow = document.getElementById('desc-arrow');
            if (content.style.display === 'none') {
                content.style.display = 'block';
                arrow.textContent = '▲';
            } else {
                content.style.display = 'none';
                arrow.textContent = '▼';
            }
        }

    </script>
</body>

</html>